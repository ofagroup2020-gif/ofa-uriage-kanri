<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFA å£²ä¸Šç®¡ç†ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆéƒ½é“åºœçœŒåˆ¥ é›†è¨ˆãƒ»PDFå°åˆ·ï¼‰</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111b2f;
      --card2:#0f1a2d;
      --line:rgba(255,255,255,.12);
      --text:#e9f1ff;
      --muted:rgba(233,241,255,.70);
      --accent:#ffd400;
      --ok:#19c37d;
      --bad:#ff5c5c;
      --chip:rgba(255,255,255,.08);
      --shadow:0 12px 28px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background: radial-gradient(1200px 600px at 15% 10%, rgba(255,212,0,.18), transparent 60%),
                  radial-gradient(900px 500px at 85% 25%, rgba(25,195,125,.12), transparent 55%),
                  radial-gradient(900px 500px at 65% 95%, rgba(52,152,219,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:18px 14px 120px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      position:sticky;top:0;z-index:50;padding:14px 10px;margin:-18px -14px 16px;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,18,32,.85), rgba(11,18,32,.35));
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(255,212,0,.95), rgba(255,120,0,.95));
      box-shadow:0 12px 20px rgba(255,212,0,.16);
      display:grid;place-items:center;font-weight:900;color:#111;
      letter-spacing:.04em;
    }
    .brand h1{font-size:16px;margin:0;line-height:1.1}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    button,.btn{
      border:0;cursor:pointer;
      padding:10px 12px;border-radius:12px;
      color:var(--text);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 18px rgba(0,0,0,.20);
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      font-weight:700;
    }
    button:hover,.btn:hover{filter:brightness(1.06)}
    .btn-accent{background:rgba(255,212,0,.16);border-color:rgba(255,212,0,.22)}
    .btn-ok{background:rgba(25,195,125,.14);border-color:rgba(25,195,125,.22)}
    .btn-bad{background:rgba(255,92,92,.14);border-color:rgba(255,92,92,.22)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .tab{
      padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);font-weight:800;
    }
    .tab.active{color:var(--text);background:rgba(255,212,0,.12);border-color:rgba(255,212,0,.22)}
    .grid{display:grid;gap:14px}
    @media(min-width:980px){
      .grid{grid-template-columns: 1.15fr .85fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{margin:0 0 10px;font-size:14px}
    .muted{color:var(--muted)}
    .row{display:grid;gap:10px}
    @media(min-width:720px){
      .row.cols2{grid-template-columns:1fr 1fr}
      .row.cols3{grid-template-columns:1fr 1fr 1fr}
      .row.cols4{grid-template-columns:1fr 1fr 1fr 1fr}
    }
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,textarea{
      width:100%;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:80px;resize:vertical}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      padding:8px 10px;border-radius:999px;background:var(--chip);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;color:var(--muted);
    }
    .chip b{color:var(--text)}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12.5px}
    th{color:var(--muted);text-align:left;background:rgba(255,255,255,.04);font-weight:800}
    tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .small{font-size:12px}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .pill{
      padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);font-size:12px;color:var(--muted)
    }
    .good{color:var(--ok);font-weight:900}
    .bad{color:var(--bad);font-weight:900}
    .hide{display:none !important}

    /* ===== å°åˆ·(PDF)ç”¨ ===== */
    @media print{
      body{background:#fff;color:#000}
      .topbar,.tabs,.no-print{display:none !important}
      .wrap{max-width:none;padding:0}
      .card{box-shadow:none;border:1px solid #ccc;background:#fff}
      table{border:1px solid #999;background:#fff}
      th{background:#f3f3f3;color:#111}
      td,th{border-bottom:1px solid #ddd;color:#111}
      .chip,.pill{border:1px solid #ccc;background:#f7f7f7;color:#111}
      .muted{color:#333}
      .good{color:#0a7d4f}
      .bad{color:#b80000}
      a{color:#000;text-decoration:none}
      .pagebreak{page-break-before:always}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo">OFA</div>
        <div>
          <h1>å£²ä¸Šç®¡ç†ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆéƒ½é“åºœçœŒåˆ¥ é›†è¨ˆãƒ»PDFå°åˆ·ï¼‰</h1>
          <div class="sub">å£²ä¸Šå…¥åŠ› â†’ è«‹æ±‚å…¥åŠ› â†’ åˆ©ç›Š/æ‰‹å½“(0.3%+0.3%) è‡ªå‹•è¨ˆç®— â†’ å°åˆ·PDF</div>
        </div>
      </div>

      <div class="actions no-print">
        <button class="btn-accent" id="btnPrint">ğŸ–¨ï¸ PDFå°åˆ·</button>
        <button class="btn" id="btnCSV">â¬‡ï¸ CSVå‡ºåŠ›</button>
        <button class="btn" id="btnBackup">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(JSON)</button>
        <label class="btn" for="jsonImport" style="cursor:pointer">â¬†ï¸ å¾©å…ƒ(JSON)</label>
        <input id="jsonImport" type="file" accept="application/json" class="hide" />
        <button class="btn-bad" id="btnReset">ğŸ§¹ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
      </div>
    </div>

    <div class="tabs no-print">
      <div class="tab active" data-tab="entry">â‘  å£²ä¸Šå…¥åŠ›</div>
      <div class="tab" data-tab="masters">â‘¡ ãƒã‚¹ã‚¿ãƒ¼è¨­å®š</div>
      <div class="tab" data-tab="report">â‘¢ é›†è¨ˆãƒ»å°åˆ·</div>
    </div>

    <!-- ===== â‘  å£²ä¸Šå…¥åŠ› ===== -->
    <section id="tab-entry">
      <div class="grid">
        <div class="card">
          <h2>å£²ä¸Šå…¥åŠ›ï¼ˆå–¶æ¥­ãƒãƒ³ãŒã“ã“ã ã‘è§¦ã‚Œã°OKï¼‰</h2>

          <div class="row cols4">
            <div>
              <label>æ—¥ä»˜</label>
              <input type="date" id="fDate">
            </div>
            <div>
              <label>éƒ½é“åºœçœŒ</label>
              <select id="fPref"></select>
            </div>
            <div>
              <label>å–¶æ¥­ãƒãƒ³ï¼ˆå…¥åŠ›è€…ï¼‰</label>
              <input type="text" id="fSales" placeholder="ä¾‹ï¼šæ£®ä¸‹ / å¤ªç”° / æ¾å²¡ ãªã©">
            </div>
            <div>
              <label>æ¡ˆä»¶åï¼ˆä»»æ„ï¼‰</label>
              <input type="text" id="fProject" placeholder="ä¾‹ï¼šã‚¢ãƒ‘ãƒ¬ãƒ«é…é€ / Amazon / ãƒ«ãƒ¼ãƒˆä¾¿ãªã©">
            </div>
          </div>

          <div class="hr"></div>

          <div class="row cols3">
            <div>
              <label>å£²ä¸Šï¼ˆå††ï¼‰</label>
              <input type="text" inputmode="numeric" id="fRevenue" placeholder="ä¾‹ï¼š1200000">
            </div>
            <div>
              <label>å§”è¨—ä¼šç¤¾â‘ ï¼ˆä¼šç¤¾åï¼‰</label>
              <input type="text" id="fVendor1Name" placeholder="ä¾‹ï¼šãƒ¤ãƒãƒˆé‹è¼¸ / ä½å·æ€¥ä¾¿ / Amazon ç­‰">
            </div>
            <div>
              <label>å§”è¨—ä¼šç¤¾â‘  è«‹æ±‚é‡‘é¡ï¼ˆå††ï¼‰</label>
              <input type="text" inputmode="numeric" id="fVendor1Amt" placeholder="ä¾‹ï¼š800000">
            </div>
          </div>

          <div class="row cols3">
            <div>
              <label>å§”è¨—ä¼šç¤¾â‘¡ï¼ˆä¼šç¤¾åï¼‰</label>
              <input type="text" id="fVendor2Name" placeholder="ä»»æ„">
            </div>
            <div>
              <label>å§”è¨—ä¼šç¤¾â‘¡ è«‹æ±‚é‡‘é¡ï¼ˆå††ï¼‰</label>
              <input type="text" inputmode="numeric" id="fVendor2Amt" placeholder="ä»»æ„">
            </div>
            <div>
              <label>ãã®ä»–çµŒè²»ï¼ˆä»»æ„ãƒ»å††ï¼‰</label>
              <input type="text" inputmode="numeric" id="fOtherCost" placeholder="ä¾‹ï¼šé«˜é€Ÿä»£/å¤–æ³¨/ä¿®ç†ãªã©">
            </div>
          </div>

          <div class="row">
            <div>
              <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
              <textarea id="fMemo" placeholder="è£œè¶³ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"></textarea>
            </div>
          </div>

          <div class="inline">
            <button class="btn-ok" id="btnAdd">â• è¿½åŠ ã—ã¦ä¿å­˜</button>
            <span class="pill">ã‚¨ãƒªã‚¢ãƒãƒæ‰‹å½“ï¼š<b>0.3%</b>ï¼ˆéƒ½é“åºœçœŒå£²ä¸Šã«å¯¾ã—ã¦ï¼‰</span>
            <span class="pill">å–¶æ¥­æ‰‹å½“ï¼š<b>0.3%</b>ï¼ˆå„å…¥åŠ›å£²ä¸Šã«å¯¾ã—ã¦ï¼‰</span>
          </div>

          <div class="hr"></div>

          <div class="chips">
            <div class="chip">è‡ªå‹•è¨ˆç®—ï¼š<b>åˆ©ç›Š = å£²ä¸Š - (å§”è¨—è«‹æ±‚åˆè¨ˆ + ãã®ä»–çµŒè²»)</b></div>
            <div class="chip">æ‰‹å½“ï¼š<b>å–¶æ¥­0.3% / ã‚¨ãƒªã‚¢ãƒãƒ0.3%</b></div>
            <div class="chip">ä¿å­˜ï¼š<b>ç«¯æœ«å†…(LocalStorage)</b>ï¼ˆCSV/JSONã§å¤–éƒ¨ä¿å­˜æ¨å¥¨ï¼‰</div>
          </div>
        </div>

        <div class="card">
          <h2>ç›´è¿‘ã®å…¥åŠ›ï¼ˆç·¨é›†ãƒ»å‰Šé™¤ï¼‰</h2>
          <div class="muted small">â€»å„æ‹…å½“ãŒè¨ˆç®—ã§ããªãã¦ã‚‚ã€ã“ã“ã¯è‡ªå‹•ã§æ•°å­—ãŒå‡ºã¾ã™ã€‚</div>
          <div class="hr"></div>

          <div class="inline no-print">
            <button class="btn" id="btnSortNew">ğŸ•’ æ–°ã—ã„é †</button>
            <button class="btn" id="btnSortOld">ğŸ•’ å¤ã„é †</button>
            <button class="btn" id="btnSelectAll">âœ… å…¨é¸æŠ</button>
            <button class="btn" id="btnClearSelect">â é¸æŠè§£é™¤</button>
            <button class="btn-bad" id="btnDeleteSelected">ğŸ—‘ï¸ é¸æŠå‰Šé™¤</button>
          </div>

          <div class="hr"></div>

          <div style="overflow:auto;max-height:520px">
            <table id="tblRecent">
              <thead>
                <tr>
                  <th class="no-print">é¸æŠ</th>
                  <th>æ—¥ä»˜</th>
                  <th>éƒ½é“åºœçœŒ</th>
                  <th>å–¶æ¥­</th>
                  <th class="right">å£²ä¸Š</th>
                  <th class="right">è«‹æ±‚+çµŒè²»</th>
                  <th class="right">åˆ©ç›Š</th>
                  <th class="right">å–¶æ¥­0.3%</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

        </div>
      </div>
    </section>

    <!-- ===== â‘¡ ãƒã‚¹ã‚¿ãƒ¼è¨­å®š ===== -->
    <section id="tab-masters" class="hide">
      <div class="grid">
        <div class="card">
          <h2>éƒ½é“åºœçœŒãƒã‚¹ã‚¿ãƒ¼ï¼ˆã‚¨ãƒªã‚¢ãƒãƒè¨­å®šï¼‰</h2>
          <div class="muted small">éƒ½é“åºœçœŒã”ã¨ã«è²¬ä»»è€…ï¼ˆã‚¨ãƒªã‚¢ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰ã‚’è¨­å®šã—ã¾ã™ã€‚æ‰‹å½“ã¯é›†è¨ˆæ™‚ã«è‡ªå‹•ã§ <b>0.3%</b> ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</div>

          <div class="hr"></div>

          <div class="row cols3">
            <div>
              <label>éƒ½é“åºœçœŒ</label>
              <select id="mPref"></select>
            </div>
            <div>
              <label>ã‚¨ãƒªã‚¢ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å</label>
              <input type="text" id="mManager" placeholder="ä¾‹ï¼šç¦å²¡è²¬ä»»è€…ï¼šã€‡ã€‡">
            </div>
            <div style="display:flex;align-items:flex-end;gap:10px">
              <button class="btn-ok" id="btnSaveManager">ğŸ’¾ ä¿å­˜</button>
              <button class="btn-bad" id="btnClearManager">ğŸ§½ è§£é™¤</button>
            </div>
          </div>

          <div class="hr"></div>
          <h2 style="margin-top:0">ç¾åœ¨ã®è¨­å®šä¸€è¦§</h2>
          <div style="overflow:auto">
            <table id="tblManagers">
              <thead>
                <tr>
                  <th>éƒ½é“åºœçœŒ</th>
                  <th>ã‚¨ãƒªã‚¢ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2>æ‰‹å½“ã®ãƒ«ãƒ¼ãƒ«ï¼ˆå›ºå®šï¼‰</h2>
          <div class="chips">
            <div class="chip">ã‚¨ãƒªã‚¢ãƒãƒæ‰‹å½“ï¼š<b>éƒ½é“åºœçœŒã®å£²ä¸Šåˆè¨ˆ Ã— 0.3%</b></div>
            <div class="chip">å–¶æ¥­æ‰‹å½“ï¼š<b>å„å…¥åŠ›ã®å£²ä¸Š Ã— 0.3%</b></div>
            <div class="chip">å–¶æ¥­ã¨ã‚¨ãƒªã‚¢ãƒãƒã¯ <b>åˆ¥äººã§ã‚‚OK</b>ï¼ˆåˆ¥åˆ¥è¨ˆç®—ï¼‰</div>
          </div>

          <div class="hr"></div>

          <h2>é‹ç”¨ã®ã‚³ãƒ„</h2>
          <ul class="muted small" style="margin:0;padding-left:18px;line-height:1.7">
            <li>å…¥åŠ›è€…ã¯ã€Œæ—¥ä»˜ãƒ»éƒ½é“åºœçœŒãƒ»å£²ä¸Šãƒ»è«‹æ±‚ã€ã ã‘ã§OKã€‚</li>
            <li>å§”è¨—ä¼šç¤¾ãŒå¤šã„å ´åˆã¯ã€Œå§”è¨—â‘¡ã€ã‚„ã€Œãã®ä»–çµŒè²»ã€ã«ã¾ã¨ã‚ã¦å…¥åŠ›ã€‚</li>
            <li>æœˆç· ã‚ã¯ã€Œé›†è¨ˆãƒ»å°åˆ·ã€ã‚¿ãƒ–ã§PDFåŒ–ã—ã¦å…±æœ‰ã€‚</li>
            <li>ç«¯æœ«æ•…éšœã«å‚™ãˆã¦ã€å®šæœŸçš„ã«ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(JSON)ã€æ¨å¥¨ã€‚</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- ===== â‘¢ é›†è¨ˆãƒ»å°åˆ· ===== -->
    <section id="tab-report" class="hide">
      <div class="card">
        <h2>é›†è¨ˆæ¡ä»¶</h2>

        <div class="row cols4 no-print">
          <div>
            <label>é–‹å§‹æ—¥</label>
            <input type="date" id="rFrom">
          </div>
          <div>
            <label>çµ‚äº†æ—¥</label>
            <input type="date" id="rTo">
          </div>
          <div>
            <label>éƒ½é“åºœçœŒï¼ˆçµã‚Šè¾¼ã¿ï¼‰</label>
            <select id="rPref">
              <option value="">å…¨ã¦</option>
            </select>
          </div>
          <div>
            <label>å–¶æ¥­ãƒãƒ³ï¼ˆçµã‚Šè¾¼ã¿ï¼‰</label>
            <input type="text" id="rSales" placeholder="ç©ºæ¬„=å…¨ã¦">
          </div>
        </div>

        <div class="inline no-print">
          <button class="btn-ok" id="btnBuild">ğŸ“Š é›†è¨ˆã™ã‚‹</button>
          <button class="btn-accent" id="btnPrint2">ğŸ–¨ï¸ ã“ã®é›†è¨ˆã‚’PDFå°åˆ·</button>
        </div>

        <div class="hr"></div>

        <!-- å°åˆ·ã«å‡ºã™ãƒ˜ãƒƒãƒ€ -->
        <div class="inline">
          <div class="chip"><b>é›†è¨ˆå¯¾è±¡</b>ï¼š<span id="printRange">ï¼ˆæœªé›†è¨ˆï¼‰</span></div>
          <div class="chip"><b>å‡ºåŠ›æ—¥</b>ï¼š<span id="printDate"></span></div>
        </div>

        <div class="hr"></div>

        <h2>éƒ½é“åºœçœŒåˆ¥ é›†è¨ˆ</h2>
        <div style="overflow:auto">
          <table id="tblPrefSum">
            <thead>
              <tr>
                <th>éƒ½é“åºœçœŒ</th>
                <th class="right">å£²ä¸Šåˆè¨ˆ</th>
                <th class="right">è«‹æ±‚+çµŒè²»åˆè¨ˆ</th>
                <th class="right">åˆ©ç›Šåˆè¨ˆ</th>
                <th>ã‚¨ãƒªã‚¢ãƒãƒ</th>
                <th class="right">ã‚¨ãƒªã‚¢ãƒãƒ0.3%</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th>ç·åˆè¨ˆ</th>
                <th class="right" id="tRev">0</th>
                <th class="right" id="tCost">0</th>
                <th class="right" id="tProf">0</th>
                <th class="right">â€”</th>
                <th class="right" id="tMgr">0</th>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="hr"></div>

        <h2>å–¶æ¥­ãƒãƒ³åˆ¥ é›†è¨ˆï¼ˆå–¶æ¥­0.3%ï¼‰</h2>
        <div style="overflow:auto">
          <table id="tblSalesSum">
            <thead>
              <tr>
                <th>å–¶æ¥­ãƒãƒ³</th>
                <th class="right">å£²ä¸Šåˆè¨ˆ</th>
                <th class="right">åˆ©ç›Šåˆè¨ˆ</th>
                <th class="right">å–¶æ¥­0.3%</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="hr"></div>

        <h2>æ˜ç´°ï¼ˆå¯¾è±¡ãƒ‡ãƒ¼ã‚¿ï¼‰</h2>
        <div class="muted small">â€»å°åˆ·ã«ã‚‚å‡ºã¾ã™ï¼ˆå¿…è¦ãªã‚‰ã“ã“ã ã‘éè¡¨ç¤ºã«ã‚‚ã§ãã¾ã™ï¼‰</div>
        <div style="overflow:auto;margin-top:10px">
          <table id="tblDetail">
            <thead>
              <tr>
                <th>æ—¥ä»˜</th>
                <th>éƒ½é“åºœçœŒ</th>
                <th>å–¶æ¥­</th>
                <th>æ¡ˆä»¶</th>
                <th>å§”è¨—ä¼šç¤¾</th>
                <th class="right">å£²ä¸Š</th>
                <th class="right">è«‹æ±‚+çµŒè²»</th>
                <th class="right">åˆ©ç›Š</th>
                <th class="right">å–¶æ¥­0.3%</th>
                <th>ãƒ¡ãƒ¢</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>

      <div class="pagebreak"></div>

      <div class="card">
        <h2>æ”¯æ‰•ã„ä¸€è¦§ï¼ˆæ‰‹å½“ã¾ã¨ã‚ï¼‰</h2>
        <div class="muted small">ã‚¨ãƒªã‚¢ãƒãƒæ‰‹å½“ï¼‹å–¶æ¥­æ‰‹å½“ã‚’ã¾ã¨ã‚ã¦ç¢ºèªã§ãã¾ã™ã€‚</div>

        <div class="hr"></div>

        <div style="overflow:auto">
          <table id="tblPayout">
            <thead>
              <tr>
                <th>åŒºåˆ†</th>
                <th>åå‰</th>
                <th>å¯¾è±¡</th>
                <th class="right">æ”¯çµ¦é¡</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th colspan="3" class="right">æ‰‹å½“ åˆè¨ˆ</th>
                <th class="right" id="tAllAllow">0</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>

  </div>

  <script>
    // ==============================
    //  ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
    // ==============================
    const LS_KEY = "ofa_sales_manager_v1";
    const LS_MGR = "ofa_sales_managers_v1";

    // éƒ½é“åºœçœŒãƒªã‚¹ãƒˆ
    const PREFS = [
      "åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ",
      "èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ",
      "æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ",
      "å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ",
      "æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ",
      "é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ",
      "å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ",
      "ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"
    ];

    // ãƒ«ãƒ¼ãƒ«
    const RATE_MANAGER = 0.003; // 0.3%
    const RATE_SALES   = 0.003; // 0.3%

    let rows = loadRows();           // æ˜ç´°
    let managers = loadManagers();   // éƒ½é“åºœçœŒâ†’ã‚¨ãƒªã‚¢ãƒãƒ

    let sortDesc = true;

    // ==============================
    //  å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ==============================
    const yen = n => (Number(n)||0).toLocaleString("ja-JP");
    const toNum = v => {
      if(v === null || v === undefined) return 0;
      const s = String(v).replace(/[^\d.-]/g,"");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };
    const todayISO = () => {
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60000);
      return local.toISOString().slice(0,10);
    };
    const uid = () => "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);

    function saveRows(){
      localStorage.setItem(LS_KEY, JSON.stringify(rows));
    }
    function loadRows(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){ return []; }
    }
    function saveManagers(){
      localStorage.setItem(LS_MGR, JSON.stringify(managers));
    }
    function loadManagers(){
      try{
        const raw = localStorage.getItem(LS_MGR);
        return raw ? JSON.parse(raw) : {};
      }catch(e){ return {}; }
    }

    function setSelectOptions(sel, list, addAll=false){
      sel.innerHTML = "";
      if(addAll){
        const op = document.createElement("option");
        op.value = "";
        op.textContent = "å…¨ã¦";
        sel.appendChild(op);
      }
      list.forEach(p=>{
        const op = document.createElement("option");
        op.value = p;
        op.textContent = p;
        sel.appendChild(op);
      });
    }

    function switchTab(tab){
      document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
      document.querySelectorAll("section[id^='tab-']").forEach(s=>s.classList.add("hide"));
      document.getElementById("tab-"+tab).classList.remove("hide");
      if(tab==="entry") renderRecent();
      if(tab==="masters") renderManagers();
      if(tab==="report") {
        document.getElementById("printDate").textContent = new Date().toLocaleString("ja-JP");
      }
    }

    // ==============================
    //  åˆæœŸåŒ–
    // ==============================
    const fDate = document.getElementById("fDate");
    const fPref = document.getElementById("fPref");
    const mPref = document.getElementById("mPref");
    const rPref = document.getElementById("rPref");

    setSelectOptions(fPref, PREFS);
    setSelectOptions(mPref, PREFS);
    setSelectOptions(rPref, PREFS, true);

    fDate.value = todayISO();

    // ã‚¿ãƒ–
    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=>switchTab(t.dataset.tab));
    });

    // ==============================
    //  â‘  è¿½åŠ ä¿å­˜
    // ==============================
    document.getElementById("btnAdd").addEventListener("click", ()=>{
      const date = fDate.value || todayISO();
      const pref = fPref.value;
      const sales = (document.getElementById("fSales").value || "").trim();
      const project = (document.getElementById("fProject").value || "").trim();

      const revenue = toNum(document.getElementById("fRevenue").value);
      const v1n = (document.getElementById("fVendor1Name").value || "").trim();
      const v1a = toNum(document.getElementById("fVendor1Amt").value);
      const v2n = (document.getElementById("fVendor2Name").value || "").trim();
      const v2a = toNum(document.getElementById("fVendor2Amt").value);
      const other = toNum(document.getElementById("fOtherCost").value);
      const memo = (document.getElementById("fMemo").value || "").trim();

      if(!pref){ alert("éƒ½é“åºœçœŒã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
      if(!sales){ alert("å–¶æ¥­ãƒãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if(revenue<=0){ alert("å£²ä¸Šï¼ˆå††ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

      const cost = (v1a||0) + (v2a||0) + (other||0);
      const profit = revenue - cost;
      const salesAllow = Math.floor(revenue * RATE_SALES);

      const row = {
        id: uid(),
        date, pref, sales, project,
        revenue,
        vendors: [
          {name:v1n, amount:v1a},
          {name:v2n, amount:v2a}
        ].filter(x => (x.name && x.amount) || x.amount),
        otherCost: other,
        memo,
        cost,
        profit,
        salesAllow
      };

      rows.push(row);
      saveRows();
      clearEntryInputsKeepBasics();
      renderRecent();
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
    });

    function clearEntryInputsKeepBasics(){
      document.getElementById("fProject").value = "";
      document.getElementById("fRevenue").value = "";
      document.getElementById("fVendor1Name").value = "";
      document.getElementById("fVendor1Amt").value = "";
      document.getElementById("fVendor2Name").value = "";
      document.getElementById("fVendor2Amt").value = "";
      document.getElementById("fOtherCost").value = "";
      document.getElementById("fMemo").value = "";
      fDate.value = todayISO();
    }

    // ä¸¦ã³æ›¿ãˆ
    document.getElementById("btnSortNew").addEventListener("click", ()=>{ sortDesc=true; renderRecent(); });
    document.getElementById("btnSortOld").addEventListener("click", ()=>{ sortDesc=false; renderRecent(); });

    // é¸æŠæ“ä½œ
    document.getElementById("btnSelectAll").addEventListener("click", ()=>{
      document.querySelectorAll(".chkRow").forEach(c=>c.checked=true);
    });
    document.getElementById("btnClearSelect").addEventListener("click", ()=>{
      document.querySelectorAll(".chkRow").forEach(c=>c.checked=false);
    });

    document.getElementById("btnDeleteSelected").addEventListener("click", ()=>{
      const ids = [...document.querySelectorAll(".chkRow:checked")].map(c=>c.dataset.id);
      if(ids.length===0){ alert("å‰Šé™¤ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      if(!confirm(`é¸æŠã—ãŸ ${ids.length} ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
      rows = rows.filter(r=>!ids.includes(r.id));
      saveRows();
      renderRecent();
    });

    // ç›´è¿‘ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderRecent(){
      const tbody = document.querySelector("#tblRecent tbody");
      tbody.innerHTML = "";

      const list = [...rows].sort((a,b)=>{
        const da = a.date + (a.id||"");
        const db = b.date + (b.id||"");
        return sortDesc ? (db.localeCompare(da)) : (da.localeCompare(db));
      }).slice(0,200);

      list.forEach(r=>{
        const tr = document.createElement("tr");
        const profitCls = r.profit>=0 ? "good" : "bad";
        tr.innerHTML = `
          <td class="no-print"><input type="checkbox" class="chkRow" data-id="${r.id}"></td>
          <td>${escapeHtml(r.date)}</td>
          <td>${escapeHtml(r.pref)}</td>
          <td>${escapeHtml(r.sales)}</td>
          <td class="right">${yen(r.revenue)}</td>
          <td class="right">${yen(r.cost)}</td>
          <td class="right ${profitCls}">${yen(r.profit)}</td>
          <td class="right">${yen(r.salesAllow)}</td>
          <td class="no-print">
            <button class="btn small" data-act="edit" data-id="${r.id}">âœï¸</button>
            <button class="btn-bad small" data-act="del" data-id="${r.id}">ğŸ—‘ï¸</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.dataset.id;
          const act = btn.dataset.act;
          if(act==="del") delRow(id);
          if(act==="edit") editRow(id);
        });
      });
    }

    function delRow(id){
      const r = rows.find(x=>x.id===id);
      if(!r) return;
      if(!confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${r.date} / ${r.pref} / ${r.sales} / å£²ä¸Š ${yen(r.revenue)}å††`)) return;
      rows = rows.filter(x=>x.id!==id);
      saveRows();
      renderRecent();
    }

    function editRow(id){
      const r = rows.find(x=>x.id===id);
      if(!r) return;

      // å…¥åŠ›æ¬„ã«åæ˜ ï¼ˆç°¡æ˜“ç·¨é›†ï¼‰
      fDate.value = r.date;
      fPref.value = r.pref;
      document.getElementById("fSales").value = r.sales;
      document.getElementById("fProject").value = r.project || "";
      document.getElementById("fRevenue").value = r.revenue;

      const v1 = r.vendors?.[0] || {name:"",amount:0};
      const v2 = r.vendors?.[1] || {name:"",amount:0};
      document.getElementById("fVendor1Name").value = v1.name || "";
      document.getElementById("fVendor1Amt").value = v1.amount || "";
      document.getElementById("fVendor2Name").value = v2.name || "";
      document.getElementById("fVendor2Amt").value = v2.amount || "";
      document.getElementById("fOtherCost").value = r.otherCost || "";
      document.getElementById("fMemo").value = r.memo || "";

      // å…ƒè¡Œå‰Šé™¤ã—ã¦å†è¿½åŠ ï¼ˆç¢ºå®Ÿé‹ç”¨ï¼‰
      rows = rows.filter(x=>x.id!==id);
      saveRows();
      renderRecent();
      switchTab("entry");
      alert("ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šå†…å®¹ã‚’ä¿®æ­£ã—ã¦ã€Œè¿½åŠ ã—ã¦ä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼ˆå…ƒãƒ‡ãƒ¼ã‚¿ã¯ç½®æ›ã•ã‚Œã¾ã™ï¼‰");
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ==============================
    //  â‘¡ ãƒã‚¹ã‚¿ãƒ¼ï¼ˆã‚¨ãƒªã‚¢ãƒãƒï¼‰
    // ==============================
    document.getElementById("btnSaveManager").addEventListener("click", ()=>{
      const p = mPref.value;
      const name = (document.getElementById("mManager").value || "").trim();
      if(!p){ alert("éƒ½é“åºœçœŒã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
      if(!name){ alert("ã‚¨ãƒªã‚¢ãƒãƒåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      managers[p] = name;
      saveManagers();
      renderManagers();
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
    });

    document.getElementById("btnClearManager").addEventListener("click", ()=>{
      const p = mPref.value;
      if(!p){ alert("éƒ½é“åºœçœŒã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
      if(!confirm(`${p} ã®ã‚¨ãƒªã‚¢ãƒãƒè¨­å®šã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      delete managers[p];
      saveManagers();
      renderManagers();
    });

    function renderManagers(){
      const tbody = document.querySelector("#tblManagers tbody");
      tbody.innerHTML = "";
      PREFS.forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(p)}</td>
          <td>${escapeHtml(managers[p] || "ï¼ˆæœªè¨­å®šï¼‰")}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ==============================
    //  â‘¢ é›†è¨ˆ
    // ==============================
    const rFrom = document.getElementById("rFrom");
    const rTo   = document.getElementById("rTo");
    const rSales= document.getElementById("rSales");

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šä»Šæœˆ
    (function initReportDates(){
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();
      const first = new Date(y,m,1);
      const last = new Date(y,m+1,0);
      const toISO = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      rFrom.value = toISO(first);
      rTo.value   = toISO(last);
      document.getElementById("printDate").textContent = new Date().toLocaleString("ja-JP");
    })();

    document.getElementById("btnBuild").addEventListener("click", buildReport);
    document.getElementById("btnPrint2").addEventListener("click", ()=>{
      buildReport();
      window.print();
    });

    function inRange(date, from, to){
      if(from && date < from) return false;
      if(to && date > to) return false;
      return true;
    }

    function buildReport(){
      const from = rFrom.value;
      const to = rTo.value;
      const prefFilter = rPref.value || "";
      const salesFilter = (rSales.value || "").trim();

      const filtered = rows.filter(r=>{
        if(!inRange(r.date, from, to)) return false;
        if(prefFilter && r.pref !== prefFilter) return false;
        if(salesFilter && r.sales !== salesFilter) return false;
        return true;
      }).sort((a,b)=> (a.date + a.id).localeCompare(b.date + b.id));

      document.getElementById("printRange").textContent =
        `${from || "â€”"} ã€œ ${to || "â€”"} / éƒ½é“åºœçœŒï¼š${prefFilter || "å…¨ã¦"} / å–¶æ¥­ï¼š${salesFilter || "å…¨ã¦"} / ä»¶æ•°ï¼š${filtered.length}`;

      // éƒ½é“åºœçœŒé›†è¨ˆ
      const prefMap = {}; // pref -> {rev,cost,prof,managerName,managerAllow}
      filtered.forEach(r=>{
        if(!prefMap[r.pref]) prefMap[r.pref] = {rev:0,cost:0,prof:0, manager: managers[r.pref] || "ï¼ˆæœªè¨­å®šï¼‰"};
        prefMap[r.pref].rev += r.revenue||0;
        prefMap[r.pref].cost += r.cost||0;
        prefMap[r.pref].prof += r.profit||0;
      });

      // å–¶æ¥­é›†è¨ˆ
      const salesMap = {}; // sales -> {rev,prof,allow}
      filtered.forEach(r=>{
        if(!salesMap[r.sales]) salesMap[r.sales] = {rev:0,prof:0};
        salesMap[r.sales].rev += r.revenue||0;
        salesMap[r.sales].prof += r.profit||0;
      });

      // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼šéƒ½é“åºœçœŒ
      const tbPref = document.querySelector("#tblPrefSum tbody");
      tbPref.innerHTML = "";
      let totalRev=0,totalCost=0,totalProf=0,totalMgrAllow=0;

      Object.keys(prefMap).sort().forEach(p=>{
        const o = prefMap[p];
        const mgrAllow = Math.floor(o.rev * RATE_MANAGER);
        totalRev += o.rev; totalCost += o.cost; totalProf += o.prof; totalMgrAllow += mgrAllow;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(p)}</td>
          <td class="right">${yen(o.rev)}</td>
          <td class="right">${yen(o.cost)}</td>
          <td class="right ${o.prof>=0?'good':'bad'}">${yen(o.prof)}</td>
          <td>${escapeHtml(o.manager)}</td>
          <td class="right">${yen(mgrAllow)}</td>
        `;
        tbPref.appendChild(tr);
      });

      document.getElementById("tRev").textContent = yen(totalRev);
      document.getElementById("tCost").textContent = yen(totalCost);
      document.getElementById("tProf").textContent = yen(totalProf);
      document.getElementById("tMgr").textContent = yen(totalMgrAllow);

      // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼šå–¶æ¥­
      const tbSales = document.querySelector("#tblSalesSum tbody");
      tbSales.innerHTML = "";
      Object.keys(salesMap).sort().forEach(s=>{
        const o = salesMap[s];
        const allow = Math.floor(o.rev * RATE_SALES);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(s)}</td>
          <td class="right">${yen(o.rev)}</td>
          <td class="right ${o.prof>=0?'good':'bad'}">${yen(o.prof)}</td>
          <td class="right">${yen(allow)}</td>
        `;
        tbSales.appendChild(tr);
      });

      // æ˜ç´°
      const tbDet = document.querySelector("#tblDetail tbody");
      tbDet.innerHTML = "";
      filtered.forEach(r=>{
        const vnames = (r.vendors||[]).map(v=>`${v.name || "å§”è¨—"}:${yen(v.amount||0)}å††`).join(" / ");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.date)}</td>
          <td>${escapeHtml(r.pref)}</td>
          <td>${escapeHtml(r.sales)}</td>
          <td>${escapeHtml(r.project || "")}</td>
          <td>${escapeHtml(vnames || "")}</td>
          <td class="right">${yen(r.revenue)}</td>
          <td class="right">${yen(r.cost)}</td>
          <td class="right ${r.profit>=0?'good':'bad'}">${yen(r.profit)}</td>
          <td class="right">${yen(Math.floor((r.revenue||0)*RATE_SALES))}</td>
          <td>${escapeHtml(r.memo || "")}</td>
        `;
        tbDet.appendChild(tr);
      });

      // æ”¯æ‰•ã„ä¸€è¦§ï¼ˆæ‰‹å½“ï¼‰
      const tbPay = document.querySelector("#tblPayout tbody");
      tbPay.innerHTML = "";
      let allowTotal = 0;

      // ã‚¨ãƒªã‚¢ãƒãƒ
      Object.keys(prefMap).sort().forEach(p=>{
        const o = prefMap[p];
        const mgrName = managers[p] || "";
        if(!mgrName) return; // æœªè¨­å®šã¯å‡ºã•ãªã„
        const amt = Math.floor(o.rev * RATE_MANAGER);
        allowTotal += amt;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>ã‚¨ãƒªã‚¢ãƒãƒ</td>
          <td>${escapeHtml(mgrName)}</td>
          <td>${escapeHtml(p)} å£²ä¸Šåˆè¨ˆ ${yen(o.rev)}å†† Ã— 0.3%</td>
          <td class="right">${yen(amt)}</td>
        `;
        tbPay.appendChild(tr);
      });

      // å–¶æ¥­
      Object.keys(salesMap).sort().forEach(s=>{
        const o = salesMap[s];
        const amt = Math.floor(o.rev * RATE_SALES);
        allowTotal += amt;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>å–¶æ¥­</td>
          <td>${escapeHtml(s)}</td>
          <td>å£²ä¸Šåˆè¨ˆ ${yen(o.rev)}å†† Ã— 0.3%</td>
          <td class="right">${yen(amt)}</td>
        `;
        tbPay.appendChild(tr);
      });

      document.getElementById("tAllAllow").textContent = yen(allowTotal);

      // å°åˆ·æ—¥
      document.getElementById("printDate").textContent = new Date().toLocaleString("ja-JP");
    }

    // ==============================
    //  å°åˆ·ãƒ»CSVãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    // ==============================
    document.getElementById("btnPrint").addEventListener("click", ()=>{
      switchTab("report");
      buildReport();
      window.print();
    });

    document.getElementById("btnCSV").addEventListener("click", ()=>{
      const header = [
        "id","date","pref","sales","project","revenue","vendor1","vendor1_amount","vendor2","vendor2_amount","otherCost","cost","profit","salesAllow","memo"
      ];
      const lines = [header.join(",")];
      rows.forEach(r=>{
        const v1 = r.vendors?.[0] || {name:"",amount:0};
        const v2 = r.vendors?.[1] || {name:"",amount:0};
        const cols = [
          r.id, r.date, r.pref, r.sales, (r.project||""),
          r.revenue||0,
          (v1.name||""), (v1.amount||0),
          (v2.name||""), (v2.amount||0),
          r.otherCost||0,
          r.cost||0,
          r.profit||0,
          Math.floor((r.revenue||0)*RATE_SALES),
          (r.memo||"")
        ].map(csvEscape);
        lines.push(cols.join(","));
      });
      downloadText(lines.join("\n"), `OFA_å£²ä¸Šç®¡ç†_${todayISO()}.csv`, "text/csv");
    });

    function csvEscape(v){
      const s = String(v ?? "");
      if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function downloadText(text, filename, mime){
      const blob = new Blob([text], {type:mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById("btnBackup").addEventListener("click", ()=>{
      const payload = {
        version:"v1",
        exportedAt: new Date().toISOString(),
        rows,
        managers
      };
      downloadText(JSON.stringify(payload, null, 2), `OFA_å£²ä¸Šç®¡ç†_BACKUP_${todayISO()}.json`, "application/json");
    });

    document.getElementById("jsonImport").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(!data || !data.rows) throw new Error("å½¢å¼ãŒé•ã„ã¾ã™");
        if(!confirm("ã“ã®JSONã§å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿï¼ˆç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰")) return;
        rows = Array.isArray(data.rows) ? data.rows : [];
        managers = data.managers || {};
        saveRows(); saveManagers();
        renderRecent(); renderManagers();
        alert("å¾©å…ƒã—ã¾ã—ãŸ");
      }catch(err){
        alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + err.message);
      }finally{
        e.target.value = "";
      }
    });

    document.getElementById("btnReset").addEventListener("click", ()=>{
      if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚å¾©å…ƒã§ãã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      rows = [];
      managers = {};
      saveRows(); saveManagers();
      renderRecent(); renderManagers();
      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
    });

    // åˆå›æç”»
    renderRecent();

    // ==============================
    //  å…¥åŠ›ã‚’è¦‹ã‚„ã™ãï¼šå††ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä»»æ„ï¼‰
    // ==============================
    ["fRevenue","fVendor1Amt","fVendor2Amt","fOtherCost"].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener("blur", ()=>{
        const n = toNum(el.value);
        el.value = n ? n.toLocaleString("ja-JP") : "";
      });
    });
  </script>
</body>
</html>
