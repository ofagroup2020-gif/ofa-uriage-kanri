<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFA æœˆæ¬¡ å£²ä¸Šç®¡ç†ï¼ˆæ‹ ç‚¹åˆ¥ / PDFãƒ»CSV / OCRå€™è£œé¸æŠ / å£²ä¸Šå˜ä¾¡ãƒã‚¹ã‚¿ãƒ¼ï¼‰</title>

  <!-- PDF.jsï¼ˆãƒ†ã‚­ã‚¹ãƒˆåŸ‹ã‚è¾¼ã¿PDFãªã‚‰æŠ½å‡ºå¯ï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>

  <style>
    :root{
      --bg:#fff;
      --card:#fff;
      --border:#dadada;
      --text:#111;
      --muted:#666;

      --yellow:#FFD400;
      --black:#111;
      --red:#E60012;
      --green:#0FA958;
      --blue:#0066CC;

      --radius:16px;
      --shadow:0 8px 24px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:12px 12px 120px}

    /* Top */
    .topbar{
      position:sticky;top:0;z-index:50;
      background:#fff;
      border-bottom:3px solid var(--black);
      padding:10px 10px;
      margin:-12px -12px 12px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:var(--yellow);
      border:3px solid var(--black);
      display:grid;place-items:center;
      font-weight:1000;color:#000;letter-spacing:.03em;
    }
    .brand h1{margin:0;font-size:16px;font-weight:1000}
    .brand .sub{margin-top:2px;color:var(--muted);font-size:12px;font-weight:800}

    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:3px solid var(--black);
      border-radius:12px;
      padding:10px 12px;
      font-weight:1000;
      cursor:pointer;
      background:#f5f5f5;
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      user-select:none;
    }
    .btn:hover{opacity:.92}
    .btn-yellow{background:var(--yellow);color:#000}
    .btn-blue{background:var(--blue);color:#fff;border-color:#003b73}
    .btn-green{background:var(--green);color:#fff;border-color:#0b6f3d}
    .btn-red{background:var(--red);color:#fff;border-color:#8f000b}
    .btn-ghost{background:#fff}

    /* Nav */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 12px}
    .tab{
      border:2px solid var(--black);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1000;
      background:#fff;
      cursor:pointer;
    }
    .tab.active{background:var(--yellow)}

    /* Cards */
    .card{
      background:var(--card);
      border:3px solid var(--black);
      border-radius:var(--radius);
      padding:14px;
      margin-bottom:12px;
      box-shadow:var(--shadow);
    }
    .muted{color:var(--muted);font-size:12px;font-weight:800;line-height:1.7}
    h2{margin:0 0 10px;font-size:14px;font-weight:1000}
    .step{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    .badge{
      width:30px;height:30px;border-radius:10px;
      background:var(--yellow);
      border:3px solid var(--black);
      display:grid;place-items:center;
      font-weight:1000;
    }

    .row{display:grid;gap:10px}
    @media(min-width:920px){
      .cols2{grid-template-columns:1fr 1fr}
      .cols3{grid-template-columns:1fr 1fr 1fr}
      .cols4{grid-template-columns:1fr 1fr 1fr 1fr}
      .cols5{grid-template-columns:1fr 1fr 1fr 1fr 1fr}
    }
    label{display:block;font-size:12px;font-weight:1000;margin:0 0 5px}
    input,select,textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:2px solid var(--border);
      font-size:15px;
      background:#fff;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:120px}
    input:focus,select:focus,textarea:focus{border-color:#999}
    .hr{height:2px;background:rgba(0,0,0,.12);margin:12px 0}

    /* Tables */
    .tableWrap{overflow:auto;border:2px solid var(--border);border-radius:14px}
    table{width:100%;border-collapse:collapse;font-size:13px;background:#fff}
    th,td{border:1px solid var(--border);padding:10px;white-space:nowrap;vertical-align:middle}
    th{background:#f2f2f2;text-align:left;font-weight:1000}
    td.right, th.right{text-align:right}
    td.center, th.center{text-align:center}

    /* KPI */
    .num{font-variant-numeric:tabular-nums}
    .good{color:var(--green);font-weight:1000}
    .bad{color:var(--red);font-weight:1000}
    .blue{color:var(--blue);font-weight:1000}
    .kpiRow{display:grid;gap:10px}
    @media(min-width:920px){.kpiRow{grid-template-columns:1fr 1fr 1fr 1fr}}
    .kpi{
      border:2px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    .kpi .t{font-size:12px;color:var(--muted);font-weight:1000}
    .kpi .v{margin-top:6px;font-size:18px;font-weight:1000}

    /* Simple toggle hint */
    .toggleBox{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      background:#fff;border:2px dashed var(--border);border-radius:14px;padding:10px 12px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      border:2px solid var(--black);
      border-radius:999px;
      padding:6px 10px;
      font-weight:1000;
      background:#fff;
      font-size:12px;
    }
    .pill-red{background:#ffe9ec;border-color:#8f000b}
    .pill-green{background:#e9fff3;border-color:#0b6f3d}
    .pill-blue{background:#e8f1ff;border-color:#003b73}

    /* Modal */
    .modalBg{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;z-index:999;
      padding:14px;
    }
    .modal{
      width:min(760px, 100%);
      background:#fff;border:3px solid var(--black);
      border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;border-bottom:2px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:var(--yellow);
    }
    .modalHead .title{font-weight:1000}
    .modalBody{padding:14px}
    .choice{
      border:2px solid var(--border);border-radius:14px;
      padding:10px 12px;display:flex;justify-content:space-between;align-items:center;
      cursor:pointer;gap:10px;margin-bottom:8px;
    }
    .choice:hover{border-color:#999}
    .choice .big{font-weight:1000}
    .choice .small{font-size:12px;color:var(--muted);font-weight:900}
    .modalFoot{
      padding:12px 14px;border-top:2px solid var(--border);
      display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;background:#fafafa;
    }

    /* Print (A4) */
    @page { size: A4; margin: 10mm; }
    .printArea{display:none}
    @media print{
      .no-print{display:none !important}
      .wrap{padding:0}
      body{background:#fff}
      .card{box-shadow:none}
      .printArea{display:block}
      .printCard{
        border:1px solid #000;border-radius:10px;padding:10px;margin-bottom:10px;
      }
      .printTitle{font-weight:1000;font-size:14px;margin:0 0 6px}
      .printMeta{font-size:11px;color:#333;font-weight:800;line-height:1.6}
      .printGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
      table{font-size:11px}
      th,td{padding:6px}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar no-print">
    <div class="brand">
      <div class="logo">OFA</div>
      <div>
        <h1>OFA æœˆæ¬¡ å£²ä¸Šç®¡ç†ï¼ˆæ‹ ç‚¹åˆ¥ï¼‰</h1>
        <div class="sub">å…¥åŠ›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€‚è¨ˆç®—ã¯å…¨éƒ¨è‡ªå‹•ã€‚PDF/CSVã§LINEé€ä»˜ã€‚</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-yellow" id="btnSaveDraft">ğŸ’¾ ä¿å­˜</button>
      <button class="btn btn-blue" id="btnPDF">ğŸ–¨ï¸ PDF</button>
      <button class="btn btn-blue" id="btnCSV">â¬‡ï¸ CSV</button>
      <button class="btn btn-red" id="btnClear">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <div class="tabs no-print">
    <div class="tab active" data-tab="input">å…¥åŠ›ï¼ˆç¾åœ°/å–¶æ¥­/FCï¼‰</div>
    <div class="tab" data-tab="board">æœ¬éƒ¨ä¸€è¦§ï¼ˆæ‹ ç‚¹åˆ¥ï¼‰</div>
    <div class="tab" data-tab="master">ãƒã‚¹ã‚¿ãƒ¼ï¼ˆå˜ä¾¡ï¼‰</div>
    <div class="tab" data-tab="history">å±¥æ­´</div>
  </div>

  <!-- ===================== INPUT ===================== -->
  <section id="tab-input">

    <div class="card no-print">
      <div class="toggleBox">
        <div class="pill pill-blue">å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</div>
        <select id="uiMode" style="max-width:320px">
          <option value="simple">è¶…ç°¡å˜ï¼ˆå£²ä¸Šé‡‘é¡ + å§”è¨—è«‹æ±‚é‡‘é¡ã ã‘ï¼‰</option>
          <option value="normal">é€šå¸¸ï¼ˆå€‹æ•°Ã—å˜ä¾¡ã§è‡ªå‹•è¨ˆç®—ã‚‚ä½¿ã†ï¼‰</option>
        </select>
        <div class="muted">è¿·ã†äººã¯ã€Œè¶…ç°¡å˜ã€ã€‚æ…£ã‚ŒãŸã‚‰ã€Œé€šå¸¸ã€ã§å€‹å»ºã‚‚è‡ªå‹•åŒ–ã€‚</div>
      </div>
    </div>

    <div class="card">
      <div class="step"><div class="badge">1</div><h2>åŸºæœ¬æƒ…å ±ï¼ˆæ‹ ç‚¹ãƒ¬ãƒãƒ¼ãƒˆï¼‰</h2></div>
      <div class="row cols5">
        <div>
          <label>å¯¾è±¡æœˆ</label>
          <input type="month" id="month">
        </div>
        <div>
          <label>éƒ½é“åºœçœŒ</label>
          <select id="pref"></select>
        </div>
        <div>
          <label>æ‹ ç‚¹å</label>
          <input id="base" placeholder="ä¾‹ï¼šç¦å²¡å¸‚å†… / æ±äº¬ï¼ˆè¶³ç«‹ï¼‰">
        </div>
        <div>
          <label>å ±å‘Šè€…ï¼ˆæ‹ ç‚¹è²¬ä»»è€…ï¼‰</label>
          <input id="reporter" placeholder="ä¾‹ï¼šæ£®ä¸‹ / â—‹â—‹FCåº—">
        </div>
        <div>
          <label>å–¶æ¥­æ‹…å½“</label>
          <input id="salesRep" placeholder="ä¾‹ï¼šæœ¬éƒ¨ å¤ªç”° / â—‹â—‹å–¶æ¥­">
        </div>
      </div>

      <div class="hr"></div>

      <div class="row cols4">
        <div>
          <label>ç›®æ¨™ï¼ˆä»»æ„ï¼‰</label>
          <input id="goal" placeholder="ä¾‹ï¼šç²—åˆ©ç‡15% / æœˆç²—åˆ©100ä¸‡">
        </div>
        <div>
          <label>æ¶ˆè²»ç¨ç‡ï¼ˆ%ï¼‰</label>
          <input id="taxRate" inputmode="decimal" placeholder="10">
        </div>
        <div>
          <label>ç²—åˆ©ç‡ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆ% ä»¥ä¸‹ã§èµ¤ï¼‰</label>
          <input id="alertRate" inputmode="decimal" placeholder="5">
        </div>
        <div>
          <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <input id="memo" placeholder="ä¾‹ï¼šå‰å¹´å·®è¦å› /å¢—å“¡/ç¹å¿™ãªã©">
        </div>
      </div>

      <div class="hr"></div>

      <div class="row cols4">
        <div>
          <label>æ‹ ç‚¹è²¬ä»»è€…ã‚¤ãƒ³ã‚»ãƒ³ï¼ˆ%ï¼‰</label>
          <input id="mgrPct" inputmode="decimal" placeholder="0.3">
        </div>
        <div>
          <label>å–¶æ¥­ã‚¤ãƒ³ã‚»ãƒ³ï¼ˆ%ï¼‰</label>
          <input id="salesPct" inputmode="decimal" placeholder="0.3">
        </div>
        <div>
          <label>ã‚¤ãƒ³ã‚»ãƒ³è¨ˆç®—ãƒ™ãƒ¼ã‚¹</label>
          <select id="incBase">
            <option value="gross">åˆ©ç›Šï¼ˆç²—åˆ©ï¼‰ãƒ™ãƒ¼ã‚¹</option>
            <option value="sales">å£²ä¸Šãƒ™ãƒ¼ã‚¹</option>
          </select>
        </div>
        <div>
          <label>ä¸Šé™/ä¸‹é™ï¼ˆä»»æ„ï¼‰</label>
          <div class="row cols2">
            <input id="incMin" inputmode="decimal" placeholder="ä¸‹é™(å††) ä¾‹ï¼š0">
            <input id="incMax" inputmode="decimal" placeholder="ä¸Šé™(å††) ä¾‹ï¼š50000">
          </div>
        </div>
      </div>

      <div class="muted" style="margin-top:8px">
        â€»ã‚¤ãƒ³ã‚»ãƒ³ã¯æ‹ ç‚¹ã”ã¨ã«è‡ªå‹•ã€‚ä¸Šé™/ä¸‹é™ã¯å¿…è¦ãªæ‹ ç‚¹ã ã‘è¨­å®šOKã€‚
      </div>
    </div>

    <div class="card">
      <div class="step"><div class="badge">2</div><h2>å£²ä¸Šï¼ˆå–å¼•å…ˆï¼‰</h2></div>
      <div class="muted">è¶…ç°¡å˜ï¼šé‡‘é¡ã ã‘ã€‚é€šå¸¸ï¼š<b>å€‹æ•°Ã—å£²ä¸Šå˜ä¾¡</b>ã‚‚ä½¿ãˆã¾ã™ï¼ˆãƒã‚¹ã‚¿ãƒ¼ç™»éŒ²ï¼‰ã€‚</div>

      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th style="min-width:220px">å–å¼•å…ˆ</th>
              <th class="right colSalesPieces">å€‹æ•°</th>
              <th class="right colSalesUnit">å£²ä¸Šå˜ä¾¡ï¼ˆç¨æŠœï¼‰</th>
              <th class="right">å£²ä¸Šé‡‘é¡ï¼ˆå…¥åŠ›/è‡ªå‹•ï¼‰</th>
              <th class="right">ç¨æŠœ</th>
              <th class="right">ç¨è¾¼</th>
              <th class="center">å‰Šé™¤</th>
            </tr>
          </thead>
          <tbody id="salesTbody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap" class="no-print">
        <button class="btn btn-yellow" id="btnAddSale">ï¼‹ å£²ä¸Šè¡Œã‚’è¿½åŠ </button>
      </div>
    </div>

    <div class="card">
      <div class="step"><div class="badge">3</div><h2>å§”è¨—ï¼ˆè«‹æ±‚ï¼‰</h2></div>
      <div class="muted">è¶…ç°¡å˜ï¼šè«‹æ±‚é‡‘é¡ã ã‘ã€‚é€šå¸¸ï¼š<b>å€‹æ•°Ã—å§”è¨—å˜ä¾¡</b>ã‚‚ä½¿ãˆã¾ã™ï¼ˆãƒã‚¹ã‚¿ãƒ¼ç™»éŒ²ï¼‰ã€‚</div>

      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th style="min-width:220px">å§”è¨—ä¼šç¤¾</th>
              <th style="min-width:170px">æ‹…å½“åœ°åŸŸ</th>
              <th class="right colOutPieces">å€‹æ•°</th>
              <th class="right colOutUnit">å§”è¨—å˜ä¾¡ï¼ˆç¨æŠœï¼‰</th>
              <th class="right">è«‹æ±‚é‡‘é¡ï¼ˆå…¥åŠ›/è‡ªå‹•ï¼‰</th>
              <th class="right">ç¨æŠœ</th>
              <th class="right">ç¨è¾¼</th>
              <th class="center">å‰Šé™¤</th>
            </tr>
          </thead>
          <tbody id="outTbody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap" class="no-print">
        <button class="btn btn-yellow" id="btnAddOut">ï¼‹ å§”è¨—è¡Œã‚’è¿½åŠ ï¼ˆç„¡é™ï¼‰</button>
      </div>
    </div>

    <div class="card no-print">
      <div class="step"><div class="badge">4</div><h2>è«‹æ±‚æ›¸OCR / PDFèª­ã¿è¾¼ã¿ï¼ˆå€™è£œé¸æŠUIï¼‰</h2></div>
      <div class="muted">
        âœ… OCRãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ â†’ <b>é‡‘é¡å€™è£œãŒè¤‡æ•°ãªã‚‰é¸æŠ</b> â†’ å£²ä¸Š/å§”è¨—ã«è¿½åŠ <br>
        âœ… PDFï¼ˆãƒ†ã‚­ã‚¹ãƒˆåŸ‹ã‚è¾¼ã¿ï¼‰ã‚‚æŠ½å‡ºâ†’åŒæ§˜ã«å€™è£œé¸æŠ
      </div>

      <div class="hr"></div>

      <div class="row cols2">
        <div>
          <label>OCRãƒ†ã‚­ã‚¹ãƒˆè²¼ã‚Šä»˜ã‘</label>
          <textarea id="invoiceText" placeholder="ã‚¹ãƒãƒ›OCRã§ã‚³ãƒ”ãƒ¼ã—ãŸæ–‡å­—ã‚’è²¼ã‚Šä»˜ã‘"></textarea>
          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-yellow" id="btnAnalyzeText">ğŸ” è§£æï¼ˆå€™è£œè¡¨ç¤ºï¼‰</button>
            <button class="btn btn-ghost" id="btnClearText">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
          </div>
        </div>

        <div>
          <label>PDFé¸æŠï¼ˆãƒ†ã‚­ã‚¹ãƒˆåŸ‹ã‚è¾¼ã¿ã®ã¿ï¼‰</label>
          <input type="file" id="pdfFile" accept="application/pdf">
          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-blue" id="btnAnalyzePDF">ğŸ“„ PDFè§£æï¼ˆå€™è£œè¡¨ç¤ºï¼‰</button>
          </div>
          <div class="muted" style="margin-top:8px">
            â€»ç”»åƒPDFï¼ˆã‚¹ã‚­ãƒ£ãƒ³ï¼‰ã¯æŠ½å‡ºä¸å¯ â†’ OCRè²¼ä»˜ã§å¯¾å¿œ
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="step"><div class="badge">5</div><h2>ç¢ºèªï¼ˆè‡ªå‹•é›†è¨ˆï¼‰</h2></div>

      <div class="kpiRow">
        <div class="kpi">
          <div class="t">å£²ä¸Šåˆè¨ˆï¼ˆç¨æŠœï¼‰</div>
          <div class="v num" id="kSalesEx">0</div>
        </div>
        <div class="kpi">
          <div class="t">å§”è¨—åˆè¨ˆï¼ˆç¨æŠœï¼‰</div>
          <div class="v num" id="kOutEx">0</div>
        </div>
        <div class="kpi">
          <div class="t">ç²—åˆ©ï¼ˆç¨æŠœï¼‰</div>
          <div class="v num" id="kGrossEx">0</div>
        </div>
        <div class="kpi">
          <div class="t">ç²—åˆ©ç‡</div>
          <div class="v num blue" id="kRate">0.0%</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row cols3">
        <div class="kpi">
          <div class="t">æ‹ ç‚¹è²¬ä»»è€…ã‚¤ãƒ³ã‚»ãƒ³</div>
          <div class="v num" id="kMgrInc">0</div>
        </div>
        <div class="kpi">
          <div class="t">å–¶æ¥­ã‚¤ãƒ³ã‚»ãƒ³</div>
          <div class="v num" id="kSalesInc">0</div>
        </div>
        <div class="kpi">
          <div class="t">ã‚¢ãƒ©ãƒ¼ãƒˆ</div>
          <div class="v" id="kAlert"><span class="pill pill-green">OK</span></div>
        </div>
      </div>

      <div class="hr"></div>

      <div style="display:flex;gap:10px;flex-wrap:wrap" class="no-print">
        <button class="btn btn-green" id="btnSaveHistory">ğŸ“Œ å±¥æ­´ä¿å­˜</button>
        <button class="btn btn-yellow" id="btnGoBoard">ğŸ¢ æœ¬éƒ¨ä¸€è¦§ã¸</button>
      </div>
      <div class="muted" style="margin-top:8px">
        â€»é‹ç”¨ï¼šå±¥æ­´ä¿å­˜ â†’ PDF/CSV â†’ LINEé€ä»˜
      </div>
    </div>

  </section>

  <!-- ===================== BOARD ===================== -->
  <section id="tab-board" style="display:none">

    <div class="card">
      <h2>æœ¬éƒ¨ä¸€è¦§ï¼ˆæ‹ ç‚¹åˆ¥ï¼‰</h2>
      <div class="row cols4 no-print">
        <div>
          <label>å¯¾è±¡æœˆ</label>
          <input type="month" id="boardMonth">
        </div>
        <div>
          <label>éƒ½é“åºœçœŒ</label>
          <select id="boardPref"></select>
        </div>
        <div>
          <label>æ‹ ç‚¹æ¤œç´¢</label>
          <input id="boardBaseQ" placeholder="éƒ¨åˆ†ä¸€è‡´ã§çµã‚Šè¾¼ã¿">
        </div>
        <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
          <button class="btn btn-blue" id="btnBoardRefresh">ğŸ”„ æ›´æ–°</button>
          <button class="btn btn-green" id="btnBoardPrint">ğŸ–¨ï¸ ä¸€è¦§ã‚’PDF</button>
        </div>
      </div>

      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>å¯¾è±¡æœˆ</th>
              <th>éƒ½é“åºœçœŒ</th>
              <th>æ‹ ç‚¹</th>
              <th>å ±å‘Šè€…</th>
              <th>å–¶æ¥­</th>
              <th class="right">å£²ä¸Š(ç¨æŠœ)</th>
              <th class="right">å§”è¨—(ç¨æŠœ)</th>
              <th class="right">ç²—åˆ©(ç¨æŠœ)</th>
              <th class="right">ç²—åˆ©ç‡</th>
              <th class="right">è²¬ä»»è€…ã‚¤ãƒ³ã‚»ãƒ³</th>
              <th class="right">å–¶æ¥­ã‚¤ãƒ³ã‚»ãƒ³</th>
              <th class="center no-print">ç·¨é›†</th>
            </tr>
          </thead>
          <tbody id="boardTbody"></tbody>
        </table>
      </div>
    </div>

  </section>

  <!-- ===================== MASTER ===================== -->
  <section id="tab-master" style="display:none">

    <div class="card">
      <h2>ãƒã‚¹ã‚¿ãƒ¼ï¼ˆé¸ã¶ã ã‘é‹ç”¨ï¼‰</h2>
      <div class="muted">
        âœ… å£²ä¸Šå˜ä¾¡ãƒã‚¹ã‚¿ãƒ¼ï¼šå–å¼•å…ˆÃ—å˜ä¾¡ï¼ˆç¨æŠœï¼‰ â†’ å€‹æ•°å…¥åŠ›ã§å£²ä¸Šè‡ªå‹•<br>
        âœ… å§”è¨—å˜ä¾¡ãƒã‚¹ã‚¿ãƒ¼ï¼šå§”è¨—ä¼šç¤¾Ã—åœ°åŸŸÃ—å˜ä¾¡ï¼ˆç¨æŠœï¼‰ â†’ å€‹æ•°å…¥åŠ›ã§å§”è¨—è‡ªå‹•
      </div>

      <div class="hr"></div>

      <div class="row cols2">
        <div>
          <h2 style="margin-top:0">â‘  å–å¼•å…ˆï¼ˆå£²ä¸Šï¼‰</h2>
          <div class="row cols2">
            <div>
              <label>å–å¼•å…ˆå</label>
              <input id="newClientName" placeholder="ä¾‹ï¼šAmazon / ãƒ¤ãƒãƒˆ / ä½å·">
            </div>
            <div>
              <label>å£²ä¸Šå˜ä¾¡ï¼ˆç¨æŠœï¼‰</label>
              <input id="newClientUnit" inputmode="decimal" placeholder="ä¾‹ï¼š180">
            </div>
          </div>
          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-yellow" id="btnAddClient">ï¼‹ è¿½åŠ </button>
          </div>

          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead><tr><th>å–å¼•å…ˆ</th><th class="right">å£²ä¸Šå˜ä¾¡(ç¨æŠœ)</th><th class="center">å‰Šé™¤</th></tr></thead>
              <tbody id="clientTbody"></tbody>
            </table>
          </div>
        </div>

        <div>
          <h2 style="margin-top:0">â‘¡ å§”è¨—å˜ä¾¡ï¼ˆå§”è¨—ä¼šç¤¾Ã—åœ°åŸŸï¼‰</h2>
          <div class="row cols3">
            <div>
              <label>å§”è¨—ä¼šç¤¾</label>
              <input id="newVendor" placeholder="ä¾‹ï¼šDARUMA">
            </div>
            <div>
              <label>æ‹…å½“åœ°åŸŸ</label>
              <input id="newArea" placeholder="ä¾‹ï¼šç¦å²¡å¸‚å†…">
            </div>
            <div>
              <label>å§”è¨—å˜ä¾¡ï¼ˆç¨æŠœï¼‰</label>
              <input id="newOutUnit" inputmode="decimal" placeholder="ä¾‹ï¼š160">
            </div>
          </div>
          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-yellow" id="btnAddOutPrice">ï¼‹ è¿½åŠ </button>
          </div>

          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead><tr><th>å§”è¨—ä¼šç¤¾</th><th>åœ°åŸŸ</th><th class="right">å§”è¨—å˜ä¾¡(ç¨æŠœ)</th><th class="center">å‰Šé™¤</th></tr></thead>
              <tbody id="outPriceTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="no-print" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn btn-green" id="btnSaveMaster">ğŸ’¾ ãƒã‚¹ã‚¿ãƒ¼ä¿å­˜</button>
        <button class="btn btn-red" id="btnResetMaster">ğŸ§¨ ãƒã‚¹ã‚¿ãƒ¼åˆæœŸåŒ–</button>
        <span class="muted">â€»ç«¯æœ«å†…ä¿å­˜ã€‚å…¨å“¡çµ±ä¸€ã¯â€œãƒã‚¹ã‚¿ãƒ¼CSVå…±æœ‰â€é‹ç”¨ãŒç¢ºå®Ÿã€‚</span>
      </div>
    </div>

  </section>

  <!-- ===================== HISTORY ===================== -->
  <section id="tab-history" style="display:none">

    <div class="card">
      <h2>å±¥æ­´ï¼ˆç«¯æœ«å†…ï¼‰</h2>
      <div class="row cols3 no-print">
        <div>
          <label>ä¿å­˜æ¸ˆã¿</label>
          <select id="historySelect"></select>
        </div>
        <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
          <button class="btn btn-yellow" id="btnLoadHistory">å‘¼ã³å‡ºã—</button>
          <button class="btn btn-red" id="btnDeleteHistory">å‰Šé™¤</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">
        â€»å±¥æ­´â†’å‘¼ã³å‡ºã—â†’ä¿®æ­£â†’PDF/CSV ãŒå¯èƒ½
      </div>
    </div>

  </section>

  <!-- ===================== PRINT AREA ===================== -->
  <div class="printArea">
    <div class="printCard">
      <div class="printTitle">OFA æœˆæ¬¡ å£²ä¸Šç®¡ç†ï¼ˆæ‹ ç‚¹ãƒ¬ãƒãƒ¼ãƒˆï¼‰</div>
      <div class="printMeta" id="printMeta"></div>
      <div class="printGrid">
        <div>
          <div class="printTitle" style="font-size:12px">é›†è¨ˆ</div>
          <div class="printMeta" id="printKpis"></div>
        </div>
        <div>
          <div class="printTitle" style="font-size:12px">ç›®æ¨™ / ãƒ¡ãƒ¢</div>
          <div class="printMeta" id="printGoalMemo"></div>
        </div>
      </div>
    </div>

    <div class="printCard">
      <div class="printTitle">å£²ä¸Šï¼ˆå–å¼•å…ˆï¼‰</div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>å–å¼•å…ˆ</th><th class="right">å€‹æ•°</th><th class="right">å˜ä¾¡(ç¨æŠœ)</th><th class="right">ç¨æŠœ</th>
            </tr>
          </thead>
          <tbody id="printSalesTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="printCard">
      <div class="printTitle">å§”è¨—ï¼ˆè«‹æ±‚ï¼‰</div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>å§”è¨—ä¼šç¤¾</th><th>åœ°åŸŸ</th><th class="right">å€‹æ•°</th><th class="right">å˜ä¾¡(ç¨æŠœ)</th><th class="right">ç¨æŠœ</th>
            </tr>
          </thead>
          <tbody id="printOutTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- ===================== OCR MODAL ===================== -->
<div class="modalBg" id="modalBg">
  <div class="modal">
    <div class="modalHead">
      <div class="title">é‡‘é¡å€™è£œã‚’é¸ã‚“ã§ç¢ºå®š</div>
      <button class="btn btn-ghost" id="btnCloseModal">âœ–</button>
    </div>
    <div class="modalBody">
      <div class="row cols2">
        <div>
          <label>åˆ†é¡ï¼ˆè¿½åŠ å…ˆï¼‰</label>
          <select id="modalType">
            <option value="out">å§”è¨—ï¼ˆè«‹æ±‚ï¼‰ã«è¿½åŠ </option>
            <option value="sales">å£²ä¸Šã«è¿½åŠ </option>
          </select>
          <div class="muted">OCRã®å†…å®¹ã§åˆ¤å®šã‚‚ã—ã¾ã™ãŒã€ã“ã“ã§å¤‰æ›´ã§ãã¾ã™ã€‚</div>
        </div>
        <div>
          <label>å–å¼•å…ˆ/å§”è¨—ä¼šç¤¾ï¼ˆä»»æ„ï¼‰</label>
          <select id="modalParty"></select>
          <div class="muted">ç©ºã§ã‚‚OKï¼ˆå¾Œã§æ‰‹å…¥åŠ›å¯ï¼‰</div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="muted">å€™è£œï¼ˆã‚¿ãƒƒãƒ—ã§ç¢ºå®šï¼‰</div>
      <div id="amountChoices" style="margin-top:10px"></div>

      <div class="hr"></div>
      <div class="row cols2">
        <div>
          <label>å€‹æ•°å€™è£œï¼ˆã‚ã‚Œã°ï¼‰</label>
          <input id="modalPieces" inputmode="numeric" placeholder="ä¾‹ï¼š14595">
          <div class="muted">å€‹å»ºãªã‚‰å…¥ã‚Œã‚‹ã¨è‡ªå‹•è¨ˆç®—ã«ä½¿ãˆã¾ã™ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰æ™‚ï¼‰</div>
        </div>
        <div>
          <label>åœ°åŸŸï¼ˆå§”è¨—ã®ã¨ãä»»æ„ï¼‰</label>
          <input id="modalArea" placeholder="ä¾‹ï¼šç¦å²¡å¸‚å†…">
        </div>
      </div>
    </div>
    <div class="modalFoot">
      <button class="btn btn-red" id="btnModalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== Storage =====
  const LS_MASTER = "ofa_simple_master_v1";
  const LS_DRAFT  = "ofa_simple_draft_v1";
  const LS_HIST   = "ofa_simple_hist_v1";

  // ===== Utils =====
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const num = (v)=> {
    const s = String(v??"").replace(/[^\d.-]/g,"");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };
  const yen = (n)=> (Number(n)||0).toLocaleString("ja-JP");
  const pct = (v)=> (v*100).toFixed(1) + "%";
  const clamp = (x,min,max)=>Math.min(Math.max(x,min),max);

  function nowMonth(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,7);
  }

  const PREFS = [
    "åŒ—æµ·é“","é’æ£®","å²©æ‰‹","å®®åŸ","ç§‹ç”°","å±±å½¢","ç¦å³¶",
    "èŒ¨åŸ","æ ƒæœ¨","ç¾¤é¦¬","åŸ¼ç‰","åƒè‘‰","æ±äº¬","ç¥å¥ˆå·",
    "æ–°æ½Ÿ","å¯Œå±±","çŸ³å·","ç¦äº•","å±±æ¢¨","é•·é‡",
    "å²é˜œ","é™å²¡","æ„›çŸ¥","ä¸‰é‡",
    "æ»‹è³€","äº¬éƒ½","å¤§é˜ª","å…µåº«","å¥ˆè‰¯","å’Œæ­Œå±±",
    "é³¥å–","å³¶æ ¹","å²¡å±±","åºƒå³¶","å±±å£",
    "å¾³å³¶","é¦™å·","æ„›åª›","é«˜çŸ¥",
    "ç¦å²¡","ä½è³€","é•·å´","ç†Šæœ¬","å¤§åˆ†","å®®å´","é¹¿å…å³¶","æ²–ç¸„",
    "ã‚¨ãƒªã‚¢å¤–/æœ¬éƒ¨å–¶æ¥­"
  ];

  function uid(){
    return (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));
  }

  // ===== State =====
  const state = {
    master:{
      // clients: {name, unitEx}
      clients:[
        {name:"Amazon", unitEx:180},
        {name:"ãƒ¤ãƒãƒˆ", unitEx:180},
        {name:"ä½å·", unitEx:180}
      ],
      // outsource: {vendor, area, unitEx}
      outPrices:[
        {vendor:"DARUMA", area:"ç¦å²¡å¸‚å†…", unitEx:160},
        {vendor:"ãƒ–ãƒ«ãƒ¼ãƒŸãƒ¼", area:"æ±äº¬ï¼ˆè¶³ç«‹ï¼‰", unitEx:170},
      ],
    },
    draft:{
      uiMode:"simple", // simple / normal
      report:{
        month: nowMonth(),
        pref:"",
        base:"",
        reporter:"",
        salesRep:"",
        goal:"",
        memo:"",
        taxRate:10,
        alertRate:5,
        mgrPct:0.3,
        salesPct:0.3,
        incBase:"gross",
        incMin:0,
        incMax:0,

        sales:[{client:"", pieces:"", inputAmount:""}],  // inputAmount is ex (simple) OR manual ex
        outs:[{vendor:"", area:"", pieces:"", inputAmount:""}], // inputAmount ex
      }
    },
    hist:[]
  };

  function loadAll(){
    try{ const m = localStorage.getItem(LS_MASTER); if(m) state.master = JSON.parse(m); }catch(e){}
    try{ const d = localStorage.getItem(LS_DRAFT); if(d) state.draft = JSON.parse(d); }catch(e){}
    try{ const h = localStorage.getItem(LS_HIST); if(h) state.hist = JSON.parse(h); }catch(e){}
  }
  function saveMaster(){ localStorage.setItem(LS_MASTER, JSON.stringify(state.master)); }
  function saveDraft(){ localStorage.setItem(LS_DRAFT, JSON.stringify(state.draft)); }
  function saveHist(){ localStorage.setItem(LS_HIST, JSON.stringify(state.hist)); }

  // ===== Tabs =====
  function setTab(name){
    ["input","board","master","history"].forEach(t=>{
      $("tab-"+t).style.display = (t===name) ? "" : "none";
    });
    document.querySelectorAll(".tab").forEach(el=>{
      el.classList.toggle("active", el.dataset.tab===name);
    });
    if(name==="board") renderBoard();
  }
  document.querySelectorAll(".tab").forEach(el=>{
    el.addEventListener("click", ()=>setTab(el.dataset.tab));
  });

  // ===== Pref Select =====
  function buildPrefSelect(sel, withAll=false){
    sel.innerHTML = withAll ? `<option value="">ã™ã¹ã¦</option>` : `<option value="">é¸æŠ</option>`;
    PREFS.forEach(p=>{
      const op = document.createElement("option");
      op.value = p; op.textContent = p;
      sel.appendChild(op);
    });
  }

  // ===== Master Lookups =====
  function getClientUnit(name){
    const c = (state.master.clients||[]).find(x=>x.name===name);
    return c ? Number(c.unitEx||0) : 0;
  }
  function getOutUnit(vendor, area){
    const o = (state.master.outPrices||[]).find(x=>x.vendor===vendor && x.area===area);
    return o ? Number(o.unitEx||0) : 0;
  }

  // ===== UI Mode Columns =====
  function applyModeColumns(){
    const m = state.draft.uiMode || "simple";
    const salesPieces = document.querySelectorAll(".colSalesPieces");
    const salesUnit = document.querySelectorAll(".colSalesUnit");
    const outPieces = document.querySelectorAll(".colOutPieces");
    const outUnit = document.querySelectorAll(".colOutUnit");

    if(m==="simple"){
      salesPieces.forEach(el=>el.style.display="none");
      salesUnit.forEach(el=>el.style.display="none");
      outPieces.forEach(el=>el.style.display="none");
      outUnit.forEach(el=>el.style.display="none");
    }else{
      salesPieces.forEach(el=>el.style.display="");
      salesUnit.forEach(el=>el.style.display="");
      outPieces.forEach(el=>el.style.display="");
      outUnit.forEach(el=>el.style.display="");
    }
  }

  // ===== Render Sales =====
  function renderSales(){
    const r = state.draft.report;
    const tb = $("salesTbody");
    const tax = num(r.taxRate)/100;
    const mode = state.draft.uiMode;

    const clientOpts = (state.master.clients||[])
      .map(c=>`<option value="${esc(c.name)}">${esc(c.name)}</option>`).join("");

    tb.innerHTML = r.sales.map((row,idx)=>{
      const pieces = num(row.pieces);
      const unit = getClientUnit(row.client);
      const isAuto = (mode==="normal" && pieces>0 && unit>0);
      const ex = isAuto ? (pieces * unit) : num(row.inputAmount);
      const inc = ex*(1+tax);

      const piecesCell = (mode==="simple") ? "" : `
        <td class="right colSalesPieces">
          <input class="num" data-s="pieces" data-i="${idx}" inputmode="numeric" placeholder="å€‹æ•°" value="${row.pieces??""}">
        </td>`;
      const unitCell = (mode==="simple") ? "" : `<td class="right num colSalesUnit">${yen(Math.round(unit))}</td>`;

      return `
        <tr>
          <td>
            <select data-s="client" data-i="${idx}">
              <option value="">é¸æŠ</option>
              ${clientOpts}
            </select>
          </td>
          ${piecesCell}
          ${unitCell}
          <td class="right">
            <input class="num" data-s="inputAmount" data-i="${idx}" inputmode="decimal"
                   placeholder="${isAuto ? "è‡ªå‹•" : "é‡‘é¡(ç¨æŠœ)"}" value="${isAuto ? "" : (row.inputAmount??"")}">
          </td>
          <td class="right num">${yen(Math.round(ex))}</td>
          <td class="right num">${yen(Math.round(inc))}</td>
          <td class="center"><button class="btn btn-red" data-del-sale="${idx}">Ã—</button></td>
        </tr>
      `;
    }).join("");

    // bind
    tb.querySelectorAll("select[data-s='client']").forEach(sel=>{
      const i = Number(sel.dataset.i);
      sel.value = r.sales[i].client || "";
      sel.addEventListener("change", ()=>{
        r.sales[i].client = sel.value;
        saveDraft(); renderSales(); recalc(); 
      });
    });
    tb.querySelectorAll("input[data-s='pieces']").forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=>{
        r.sales[i].pieces = inp.value;
        saveDraft(); renderSales(); recalc();
      });
    });
    tb.querySelectorAll("input[data-s='inputAmount']").forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=>{
        r.sales[i].inputAmount = inp.value;
        saveDraft(); recalc();
      });
      inp.addEventListener("blur", ()=>{
        const v = num(inp.value);
        inp.value = v ? String(v) : "";
        r.sales[i].inputAmount = inp.value;
        saveDraft(); renderSales(); recalc();
      });
    });
    tb.querySelectorAll("button[data-del-sale]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delSale);
        r.sales.splice(i,1);
        if(!r.sales.length) r.sales.push({client:"", pieces:"", inputAmount:""});
        saveDraft(); renderSales(); recalc();
      });
    });

    applyModeColumns();
  }

  // ===== Render Outs =====
  function renderOuts(){
    const r = state.draft.report;
    const tb = $("outTbody");
    const tax = num(r.taxRate)/100;
    const mode = state.draft.uiMode;

    const vendorSet = Array.from(new Set((state.master.outPrices||[]).map(x=>x.vendor))).filter(Boolean);
    const areaSet = Array.from(new Set((state.master.outPrices||[]).map(x=>x.area))).filter(Boolean);

    const vendorOpts = vendorSet.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
    const areaOpts = areaSet.map(a=>`<option value="${esc(a)}">${esc(a)}</option>`).join("");

    tb.innerHTML = r.outs.map((row,idx)=>{
      const pieces = num(row.pieces);
      const unit = getOutUnit(row.vendor, row.area);
      const isAuto = (mode==="normal" && pieces>0 && unit>0);
      const ex = isAuto ? (pieces * unit) : num(row.inputAmount);
      const inc = ex*(1+tax);

      const piecesCell = (mode==="simple") ? "" : `
        <td class="right colOutPieces">
          <input class="num" data-o="pieces" data-i="${idx}" inputmode="numeric" placeholder="å€‹æ•°" value="${row.pieces??""}">
        </td>`;
      const unitCell = (mode==="simple") ? "" : `<td class="right num colOutUnit">${yen(Math.round(unit))}</td>`;

      return `
        <tr>
          <td>
            <input data-o="vendor" data-i="${idx}" placeholder="å§”è¨—ä¼šç¤¾" value="${esc(row.vendor||"")}">
          </td>
          <td>
            <input data-o="area" data-i="${idx}" placeholder="æ‹…å½“åœ°åŸŸ" value="${esc(row.area||"")}">
          </td>
          ${piecesCell}
          ${unitCell}
          <td class="right">
            <input class="num" data-o="inputAmount" data-i="${idx}" inputmode="decimal"
                   placeholder="${isAuto ? "è‡ªå‹•" : "è«‹æ±‚(ç¨æŠœ)"}" value="${isAuto ? "" : (row.inputAmount??"")}">
          </td>
          <td class="right num">${yen(Math.round(ex))}</td>
          <td class="right num">${yen(Math.round(inc))}</td>
          <td class="center"><button class="btn btn-red" data-del-out="${idx}">Ã—</button></td>
        </tr>
      `;
    }).join("");

    // bind
    tb.querySelectorAll("input[data-o='vendor']").forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=>{
        r.outs[i].vendor = inp.value;
        saveDraft(); renderOuts(); recalc();
      });
    });
    tb.querySelectorAll("input[data-o='area']").forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=>{
        r.outs[i].area = inp.value;
        saveDraft(); renderOuts(); recalc();
      });
    });
    tb.querySelectorAll("input[data-o='pieces']").forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=>{
        r.outs[i].pieces = inp.value;
        saveDraft(); renderOuts(); recalc();
      });
    });
    tb.querySelectorAll("input[data-o='inputAmount']").forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=>{
        r.outs[i].inputAmount = inp.value;
        saveDraft(); recalc();
      });
      inp.addEventListener("blur", ()=>{
        const v = num(inp.value);
        inp.value = v ? String(v) : "";
        r.outs[i].inputAmount = inp.value;
        saveDraft(); renderOuts(); recalc();
      });
    });
    tb.querySelectorAll("button[data-del-out]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delOut);
        r.outs.splice(i,1);
        if(!r.outs.length) r.outs.push({vendor:"", area:"", pieces:"", inputAmount:""});
        saveDraft(); renderOuts(); recalc();
      });
    });

    applyModeColumns();
  }

  // ===== Calc =====
  function calc(){
    const r = state.draft.report;
    const tax = num(r.taxRate)/100;
    const mode = state.draft.uiMode;

    let salesEx=0, outEx=0;

    // sales
    r.sales.forEach(s=>{
      const pieces = num(s.pieces);
      const unit = getClientUnit(s.client);
      const isAuto = (mode==="normal" && pieces>0 && unit>0);
      const ex = isAuto ? (pieces*unit) : num(s.inputAmount);
      salesEx += ex;
    });

    // outs
    r.outs.forEach(o=>{
      const pieces = num(o.pieces);
      const unit = getOutUnit(o.vendor, o.area);
      const isAuto = (mode==="normal" && pieces>0 && unit>0);
      const ex = isAuto ? (pieces*unit) : num(o.inputAmount);
      outEx += ex;
    });

    const grossEx = salesEx - outEx;
    const rate = salesEx ? (grossEx/salesEx) : 0;

    // incentives
    const base = (r.incBase==="sales") ? salesEx : grossEx;
    const mgrPct = num(r.mgrPct)/100;
    const salesPct = num(r.salesPct)/100;

    let mgrInc = base>0 ? base*mgrPct : 0;
    let salesInc = base>0 ? base*salesPct : 0;

    const minV = Math.max(0, num(r.incMin));
    const maxV = Math.max(0, num(r.incMax));
    if(minV>0){ mgrInc = Math.max(mgrInc, minV); salesInc = Math.max(salesInc, minV); }
    if(maxV>0){ mgrInc = Math.min(mgrInc, maxV); salesInc = Math.min(salesInc, maxV); }

    return {salesEx,outEx,grossEx,rate,mgrInc,salesInc,tax};
  }

  function recalc(){
    const r = state.draft.report;
    const c = calc();

    $("kSalesEx").textContent = yen(Math.round(c.salesEx));
    $("kOutEx").textContent   = yen(Math.round(c.outEx));
    $("kGrossEx").textContent = yen(Math.round(c.grossEx));
    $("kGrossEx").className = "v num " + (c.grossEx>=0 ? "good" : "bad");
    $("kRate").textContent = pct(c.rate);

    $("kMgrInc").textContent = yen(Math.round(c.mgrInc));
    $("kSalesInc").textContent = yen(Math.round(c.salesInc));

    const th = num(r.alertRate)/100;
    $("kAlert").innerHTML = (c.rate <= th)
      ? `<span class="pill pill-red">ç²—åˆ©ç‡ãŒä½ã„</span>`
      : `<span class="pill pill-green">OK</span>`;
  }

  // ===== Print =====
  function fillPrint(){
    const r = state.draft.report;
    const c = calc();
    const taxRate = num(r.taxRate);
    const grossRate = pct(c.rate);

    $("printMeta").innerHTML = `
      å¯¾è±¡æœˆï¼š<b>${esc(r.month||"")}</b> ï¼ éƒ½é“åºœçœŒï¼š<b>${esc(r.pref||"")}</b> ï¼ æ‹ ç‚¹ï¼š<b>${esc(r.base||"")}</b><br>
      å ±å‘Šè€…ï¼š<b>${esc(r.reporter||"")}</b> ï¼ å–¶æ¥­ï¼š<b>${esc(r.salesRep||"")}</b> ï¼ æ¶ˆè²»ç¨ï¼š<b>${taxRate}%</b>
    `;
    $("printKpis").innerHTML = `
      å£²ä¸Š(ç¨æŠœ)ï¼š<b>${yen(Math.round(c.salesEx))}</b><br>
      å§”è¨—(ç¨æŠœ)ï¼š<b>${yen(Math.round(c.outEx))}</b><br>
      ç²—åˆ©(ç¨æŠœ)ï¼š<b>${yen(Math.round(c.grossEx))}</b> ï¼ ç²—åˆ©ç‡ï¼š<b>${grossRate}</b><br>
      è²¬ä»»è€…ã‚¤ãƒ³ã‚»ãƒ³ï¼š<b>${yen(Math.round(c.mgrInc))}</b> ï¼ å–¶æ¥­ã‚¤ãƒ³ã‚»ãƒ³ï¼š<b>${yen(Math.round(c.salesInc))}</b>
    `;
    $("printGoalMemo").innerHTML = `
      ç›®æ¨™ï¼š<b>${esc(r.goal||"")}</b><br>
      ãƒ¡ãƒ¢ï¼š<b>${esc(r.memo||"")}</b>
    `;

    // tables
    const sTb = $("printSalesTbody");
    sTb.innerHTML = "";
    r.sales.forEach(s=>{
      const pieces = num(s.pieces);
      const unit = getClientUnit(s.client);
      const isAuto = (state.draft.uiMode==="normal" && pieces>0 && unit>0);
      const ex = isAuto ? (pieces*unit) : num(s.inputAmount);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(s.client||"")}</td>
        <td class="right num">${pieces?pieces:""}</td>
        <td class="right num">${unit?yen(Math.round(unit)):""}</td>
        <td class="right num">${yen(Math.round(ex))}</td>
      `;
      sTb.appendChild(tr);
    });

    const oTb = $("printOutTbody");
    oTb.innerHTML = "";
    r.outs.forEach(o=>{
      const pieces = num(o.pieces);
      const unit = getOutUnit(o.vendor, o.area);
      const isAuto = (state.draft.uiMode==="normal" && pieces>0 && unit>0);
      const ex = isAuto ? (pieces*unit) : num(o.inputAmount);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(o.vendor||"")}</td>
        <td>${esc(o.area||"")}</td>
        <td class="right num">${pieces?pieces:""}</td>
        <td class="right num">${unit?yen(Math.round(unit)):""}</td>
        <td class="right num">${yen(Math.round(ex))}</td>
      `;
      oTb.appendChild(tr);
    });
  }

  // ===== CSV =====
  function csvEscape(v){
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }
  function downloadText(text, filename, mime){
    const blob = new Blob([text], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportCSV(){
    const r = state.draft.report;
    const c = calc();

    const cols = [
      "type","month","pref","base","reporter","salesRep","goal","memo",
      "taxRate","uiMode","mgrPct","salesPct","incBase","incMin","incMax","alertRate",
      "salesEx","outEx","grossEx","grossRate","mgrInc","salesInc",
      "client","salesPieces","salesUnitEx","salesAmountEx",
      "vendor","area","outPieces","outUnitEx","outAmountEx"
    ];
    const rows = [];
    rows.push(cols.join(","));

    // summary
    rows.push(cols.map(k=>csvEscape(({
      type:"SUMMARY",
      month:r.month,pref:r.pref,base:r.base,reporter:r.reporter,salesRep:r.salesRep,goal:r.goal,memo:r.memo,
      taxRate:r.taxRate,uiMode:state.draft.uiMode,mgrPct:r.mgrPct,salesPct:r.salesPct,incBase:r.incBase,incMin:r.incMin,incMax:r.incMax,alertRate:r.alertRate,
      salesEx:Math.round(c.salesEx),outEx:Math.round(c.outEx),grossEx:Math.round(c.grossEx),grossRate:c.rate,
      mgrInc:Math.round(c.mgrInc),salesInc:Math.round(c.salesInc)
    })[k] ?? "")).join(","));

    // sales lines
    r.sales.forEach(s=>{
      const pieces = num(s.pieces);
      const unit = getClientUnit(s.client);
      const isAuto = (state.draft.uiMode==="normal" && pieces>0 && unit>0);
      const ex = isAuto ? (pieces*unit) : num(s.inputAmount);
      const line = {
        type:"SALES",
        month:r.month,pref:r.pref,base:r.base,reporter:r.reporter,salesRep:r.salesRep,
        client:s.client||"", salesPieces:pieces||"", salesUnitEx:unit||"", salesAmountEx:Math.round(ex)
      };
      rows.push(cols.map(k=>csvEscape(line[k] ?? "")).join(","));
    });

    // out lines
    r.outs.forEach(o=>{
      const pieces = num(o.pieces);
      const unit = getOutUnit(o.vendor, o.area);
      const isAuto = (state.draft.uiMode==="normal" && pieces>0 && unit>0);
      const ex = isAuto ? (pieces*unit) : num(o.inputAmount);
      const line = {
        type:"OUTSOURCE",
        month:r.month,pref:r.pref,base:r.base,reporter:r.reporter,salesRep:r.salesRep,
        vendor:o.vendor||"", area:o.area||"", outPieces:pieces||"", outUnitEx:unit||"", outAmountEx:Math.round(ex)
      };
      rows.push(cols.map(k=>csvEscape(line[k] ?? "")).join(","));
    });

    downloadText(rows.join("\n"), `OFA_æœˆæ¬¡_${r.month||nowMonth()}_${r.pref||""}_${r.base||""}.csv`, "text/csv");
  }

  // ===== Board =====
  function renderBoard(){
    const month = $("boardMonth").value || state.draft.report.month || nowMonth();
    const pref = $("boardPref").value || "";
    const q = ($("boardBaseQ").value || "").trim();

    const list = (state.hist||[])
      .map(h=>h.snapshot)
      .filter(x=> (x.month||"") === month)
      .filter(x=> !pref || (x.pref||"")===pref)
      .filter(x=> !q || (x.base||"").includes(q));

    const tb = $("boardTbody");
    tb.innerHTML = "";

    list.forEach(snap=>{
      // temp calc from snapshot using current master + uiMode = snap.uiMode
      const tmp = JSON.parse(JSON.stringify(state.draft));
      tmp.uiMode = snap.uiMode || "simple";
      tmp.report = snap;
      const oldMode = state.draft.uiMode;
      const oldReport = state.draft.report;
      state.draft.uiMode = tmp.uiMode;
      state.draft.report = tmp.report;
      const c = calc();
      state.draft.uiMode = oldMode;
      state.draft.report = oldReport;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(snap.month||"")}</td>
        <td>${esc(snap.pref||"")}</td>
        <td>${esc(snap.base||"")}</td>
        <td>${esc(snap.reporter||"")}</td>
        <td>${esc(snap.salesRep||"")}</td>
        <td class="right num">${yen(Math.round(c.salesEx))}</td>
        <td class="right num">${yen(Math.round(c.outEx))}</td>
        <td class="right num ${c.grossEx>=0?"good":"bad"}">${yen(Math.round(c.grossEx))}</td>
        <td class="right num blue">${pct(c.rate)}</td>
        <td class="right num">${yen(Math.round(c.mgrInc))}</td>
        <td class="right num">${yen(Math.round(c.salesInc))}</td>
        <td class="center no-print"><button class="btn btn-yellow" data-load="${esc(snap._id)}">ç·¨é›†</button></td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("button[data-load]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.dataset.load;
        const hit = state.hist.find(h=>h.snapshot._id===id);
        if(!hit) return;
        state.draft.report = JSON.parse(JSON.stringify(hit.snapshot));
        state.draft.uiMode = state.draft.report.uiMode || state.draft.uiMode || "simple";
        saveDraft();
        hydrate();
        setTab("input");
      });
    });
  }

  // ===== OCR Parse (multiple candidates UI) =====
  function normalizeText(t){
    return String(t||"")
      .replace(/\u3000/g," ")
      .replace(/[ï¼Œã€]/g,",")
      .replace(/[ï¼-ï¼™]/g, d => String.fromCharCode(d.charCodeAt(0) - 0xFEE0))
      .replace(/[ï¿¥Â¥]/g,"Â¥")
      .replace(/\s+/g," ")
      .trim();
  }
  function extractYenCandidates(t){
    const out = [];
    const re = /(?:Â¥\s*)?(-?\d{1,3}(?:,\d{3})+|-?\d+)(?:\s*å††)?/g;
    let m;
    while((m=re.exec(t))){
      const raw = m[1].replace(/,/g,"");
      const v = Number(raw);
      if(Number.isFinite(v) && Math.abs(v) >= 500) out.push(v);
    }
    // é‡è¤‡å‰Šé™¤
    const uniq = Array.from(new Set(out.map(x=>Math.round(x))));
    uniq.sort((a,b)=>Math.abs(b)-Math.abs(a));
    return uniq.slice(0,12);
  }
  function extractPiecesCandidates(t){
    const out = [];
    const re = /(\d{1,6})\s*(å€‹|pcs|ä»¶)/ig;
    let m;
    while((m=re.exec(t))){
      const v = Number(m[1]);
      if(Number.isFinite(v) && v>0) out.push(v);
    }
    const uniq = Array.from(new Set(out));
    uniq.sort((a,b)=>b-a);
    return uniq.slice(0,8);
  }
  function guessType(t){
    const outK = ["æ”¯æ‰•","æŒ¯è¾¼","è«‹æ±‚","å§”è¨—","å¤–æ³¨","ç²¾ç®—","æ§é™¤","æ‰‹æ•°æ–™","å·®å¼•","ç«‹æ›¿"];
    const salesK = ["å£²ä¸Š","å…¥é‡‘","å—é ˜","ã”ä¾é ¼","è·ä¸»","ç™ºæ³¨"];
    const sOut = outK.reduce((acc,k)=>acc+(t.includes(k)?1:0),0);
    const sSales = salesK.reduce((acc,k)=>acc+(t.includes(k)?1:0),0);
    if(sOut>sSales) return "out";
    if(sSales>sOut) return "sales";
    return "out";
  }
  function guessPartyOptions(t, type){
    const opts = [];
    if(type==="sales"){
      (state.master.clients||[]).forEach(c=>{
        if(c.name && t.includes(c.name)) opts.push({value:c.name,label:c.name});
      });
      (state.master.clients||[]).forEach(c=> opts.push({value:c.name,label:c.name}));
    }else{
      const vendors = Array.from(new Set((state.master.outPrices||[]).map(x=>x.vendor))).filter(Boolean);
      vendors.forEach(v=>{
        if(t.includes(v)) opts.push({value:v,label:v});
      });
      vendors.forEach(v=>opts.push({value:v,label:v}));
    }
    // å…ˆé ­ã«ç©º
    opts.unshift({value:"", label:"ï¼ˆæœªé¸æŠï¼‰"});
    // é‡è¤‡å‰Šé™¤ï¼ˆé †åºç¶­æŒï¼‰
    const seen = new Set();
    return opts.filter(o=>{
      const k = o.value+"|"+o.label;
      if(seen.has(k)) return false;
      seen.add(k); return true;
    });
  }

  // Modal control
  let modalCandidates = { amounts:[], pieces:[], raw:"" };

  function openModal(type, partyOptions, amounts, pieces){
    $("modalBg").style.display = "flex";
    $("modalType").value = type;

    // party options
    const sel = $("modalParty");
    sel.innerHTML = "";
    partyOptions.forEach(o=>{
      const op = document.createElement("option");
      op.value = o.value; op.textContent = o.label;
      sel.appendChild(op);
    });

    // pieces prefill
    $("modalPieces").value = pieces.length ? String(pieces[0]) : "";
    $("modalArea").value = "";

    // amount choices
    const box = $("amountChoices");
    box.innerHTML = "";
    if(!amounts.length){
      box.innerHTML = `<div class="muted">é‡‘é¡å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚OCRãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>`;
      return;
    }
    amounts.forEach(a=>{
      const div = document.createElement("div");
      div.className = "choice";
      div.innerHTML = `
        <div>
          <div class="big">Â¥ ${yen(Math.round(a))}</div>
          <div class="small">ã‚¿ãƒƒãƒ—ã§ç¢ºå®š</div>
        </div>
        <div class="pill pill-blue">é¸ã¶</div>
      `;
      div.addEventListener("click", ()=>confirmModalAmount(a));
      box.appendChild(div);
    });
  }

  function closeModal(){
    $("modalBg").style.display = "none";
    modalCandidates = {amounts:[], pieces:[], raw:""};
  }

  function confirmModalAmount(amount){
    const r = state.draft.report;
    const type = $("modalType").value; // sales/out
    const party = $("modalParty").value || "";
    const pieces = num($("modalPieces").value);
    const area = ($("modalArea").value || "").trim();

    if(type==="sales"){
      r.sales.push({client: party, pieces: pieces?String(pieces):"", inputAmount: String(amount)});
    }else{
      r.outs.push({vendor: party, area: area, pieces: pieces?String(pieces):"", inputAmount: String(amount)});
    }

    saveDraft();
    renderSales();
    renderOuts();
    recalc();
    closeModal();
  }

  // PDF parse
  async function parsePDFFile(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    let txt = "";
    for(let i=1;i<=pdf.numPages;i++){
      const page = await pdf.getPage(i);
      const c = await page.getTextContent();
      txt += c.items.map(it=>it.str).join(" ") + " ";
    }
    return txt;
  }

  // ===== Master Render =====
  function renderMaster(){
    // clients
    const ctb = $("clientTbody");
    ctb.innerHTML = (state.master.clients||[]).map((c,idx)=>`
      <tr>
        <td>${esc(c.name)}</td>
        <td class="right num">${yen(Math.round(num(c.unitEx)))}</td>
        <td class="center"><button class="btn btn-red" data-delc="${idx}">Ã—</button></td>
      </tr>
    `).join("");
    ctb.querySelectorAll("button[data-delc]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delc);
        state.master.clients.splice(i,1);
        saveMaster(); renderMaster(); renderSales(); recalc();
      });
    });

    // outs
    const otb = $("outPriceTbody");
    otb.innerHTML = (state.master.outPrices||[]).map((o,idx)=>`
      <tr>
        <td>${esc(o.vendor)}</td>
        <td>${esc(o.area)}</td>
        <td class="right num">${yen(Math.round(num(o.unitEx)))}</td>
        <td class="center"><button class="btn btn-red" data-delo="${idx}">Ã—</button></td>
      </tr>
    `).join("");
    otb.querySelectorAll("button[data-delo]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delo);
        state.master.outPrices.splice(i,1);
        saveMaster(); renderMaster(); renderOuts(); recalc();
      });
    });
  }

  // ===== History =====
  function renderHistory(){
    const sel = $("historySelect");
    sel.innerHTML = "";
    if(!state.hist.length){
      const op = document.createElement("option");
      op.value = ""; op.textContent = "ï¼ˆå±¥æ­´ãªã—ï¼‰";
      sel.appendChild(op);
      return;
    }
    state.hist.slice().sort((a,b)=>(b.savedAt||"").localeCompare(a.savedAt||"")).forEach(h=>{
      const r = h.snapshot;
      const op = document.createElement("option");
      op.value = r._id;
      op.textContent = `${r.month} / ${r.pref} ${r.base} / ${r.reporter}`;
      sel.appendChild(op);
    });
  }

  // ===== Hydrate =====
  function hydrate(){
    const r = state.draft.report;
    $("uiMode").value = state.draft.uiMode || "simple";
    $("month").value = r.month || nowMonth();
    $("pref").value = r.pref || "";
    $("base").value = r.base || "";
    $("reporter").value = r.reporter || "";
    $("salesRep").value = r.salesRep || "";
    $("goal").value = r.goal || "";
    $("memo").value = r.memo || "";
    $("taxRate").value = (r.taxRate ?? 10);
    $("alertRate").value = (r.alertRate ?? 5);
    $("mgrPct").value = (r.mgrPct ?? 0.3);
    $("salesPct").value = (r.salesPct ?? 0.3);
    $("incBase").value = r.incBase || "gross";
    $("incMin").value = (r.incMin ?? 0);
    $("incMax").value = (r.incMax ?? 0);

    if(!Array.isArray(r.sales)) r.sales = [{client:"", pieces:"", inputAmount:""}];
    if(!Array.isArray(r.outs)) r.outs = [{vendor:"", area:"", pieces:"", inputAmount:""}];

    applyModeColumns();
    renderSales();
    renderOuts();
    recalc();
  }

  // ===== Wire =====
  function wire(){
    // mode
    $("uiMode").addEventListener("change", ()=>{
      state.draft.uiMode = $("uiMode").value;
      saveDraft();
      applyModeColumns();
      renderSales(); renderOuts(); recalc();
    });

    // base fields
    const bind = (id, key, evt="input")=>{
      $(id).addEventListener(evt, ()=>{
        state.draft.report[key] = $(id).value;
        saveDraft(); recalc();
      });
    };
    bind("month","month","change");
    bind("pref","pref","change");
    bind("base","base");
    bind("reporter","reporter");
    bind("salesRep","salesRep");
    bind("goal","goal");
    bind("memo","memo");
    bind("taxRate","taxRate");
    bind("alertRate","alertRate");
    bind("mgrPct","mgrPct");
    bind("salesPct","salesPct");
    bind("incMin","incMin");
    bind("incMax","incMax");
    $("incBase").addEventListener("change", ()=>{
      state.draft.report.incBase = $("incBase").value;
      saveDraft(); recalc();
    });

    // add rows
    $("btnAddSale").addEventListener("click", ()=>{
      state.draft.report.sales.push({client:"", pieces:"", inputAmount:""});
      saveDraft(); renderSales(); recalc();
    });
    $("btnAddOut").addEventListener("click", ()=>{
      state.draft.report.outs.push({vendor:"", area:"", pieces:"", inputAmount:""});
      saveDraft(); renderOuts(); recalc();
    });

    // save/pdf/csv/clear
    $("btnSaveDraft").addEventListener("click", ()=>{ saveDraft(); alert("ä¿å­˜ã—ã¾ã—ãŸ"); });
    $("btnPDF").addEventListener("click", ()=>{
      fillPrint();
      window.print();
    });
    $("btnCSV").addEventListener("click", exportCSV);
    $("btnClear").addEventListener("click", ()=>{
      if(!confirm("å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒã‚¹ã‚¿ãƒ¼/å±¥æ­´ã¯æ®‹ã‚Šã¾ã™ï¼‰")) return;
      state.draft.report.sales = [{client:"", pieces:"", inputAmount:""}];
      state.draft.report.outs  = [{vendor:"", area:"", pieces:"", inputAmount:""}];
      state.draft.report.memo = "";
      saveDraft(); renderSales(); renderOuts(); recalc();
    });

    // history
    $("btnSaveHistory").addEventListener("click", ()=>{
      const snap = JSON.parse(JSON.stringify(state.draft.report));
      snap._id = uid();
      snap.uiMode = state.draft.uiMode;
      state.hist.push({savedAt:new Date().toISOString(), snapshot:snap});
      saveHist(); renderHistory();
      alert("å±¥æ­´ä¿å­˜ã—ã¾ã—ãŸ");
    });
    $("btnLoadHistory").addEventListener("click", ()=>{
      const id = $("historySelect").value;
      if(!id) return;
      const hit = state.hist.find(h=>h.snapshot._id===id);
      if(!hit) return;
      state.draft.report = JSON.parse(JSON.stringify(hit.snapshot));
      state.draft.uiMode = state.draft.report.uiMode || state.draft.uiMode || "simple";
      saveDraft(); hydrate();
      setTab("input");
    });
    $("btnDeleteHistory").addEventListener("click", ()=>{
      const id = $("historySelect").value;
      if(!id) return;
      if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      state.hist = state.hist.filter(h=>h.snapshot._id!==id);
      saveHist(); renderHistory();
    });

    // board
    $("btnGoBoard").addEventListener("click", ()=>setTab("board"));
    $("btnBoardRefresh").addEventListener("click", renderBoard);
    $("btnBoardPrint").addEventListener("click", ()=>window.print());
    $("boardMonth").addEventListener("change", renderBoard);
    $("boardPref").addEventListener("change", renderBoard);
    $("boardBaseQ").addEventListener("input", renderBoard);

    // master add
    $("btnAddClient").addEventListener("click", ()=>{
      const name = ($("newClientName").value||"").trim();
      const unit = num($("newClientUnit").value);
      if(!name || unit<=0) return alert("å–å¼•å…ˆåã¨å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      if(!(state.master.clients||[]).some(c=>c.name===name)){
        state.master.clients.push({name, unitEx:unit});
      }
      $("newClientName").value=""; $("newClientUnit").value="";
      saveMaster(); renderMaster(); renderSales(); recalc();
    });
    $("btnAddOutPrice").addEventListener("click", ()=>{
      const vendor = ($("newVendor").value||"").trim();
      const area = ($("newArea").value||"").trim();
      const unit = num($("newOutUnit").value);
      if(!vendor || !area || unit<=0) return alert("å§”è¨—ä¼šç¤¾/åœ°åŸŸ/å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      state.master.outPrices.push({vendor, area, unitEx:unit});
      $("newVendor").value=""; $("newArea").value=""; $("newOutUnit").value="";
      saveMaster(); renderMaster(); renderOuts(); recalc();
    });
    $("btnSaveMaster").addEventListener("click", ()=>{
      // normalize
      state.master.clients = (state.master.clients||[])
        .map(c=>({name:String(c.name||"").trim(), unitEx:num(c.unitEx)}))
        .filter(c=>c.name && c.unitEx>0);
      state.master.outPrices = (state.master.outPrices||[])
        .map(o=>({vendor:String(o.vendor||"").trim(), area:String(o.area||"").trim(), unitEx:num(o.unitEx)}))
        .filter(o=>o.vendor && o.area && o.unitEx>0);

      saveMaster();
      alert("ãƒã‚¹ã‚¿ãƒ¼ä¿å­˜ã—ã¾ã—ãŸ");
      renderMaster(); renderSales(); renderOuts(); recalc();
    });
    $("btnResetMaster").addEventListener("click", ()=>{
      if(!confirm("ãƒã‚¹ã‚¿ãƒ¼åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      localStorage.removeItem(LS_MASTER);
      loadAll();
      renderMaster(); renderSales(); renderOuts(); recalc();
    });

    // OCR modal controls
    $("btnCloseModal").addEventListener("click", closeModal);
    $("btnModalCancel").addEventListener("click", closeModal);
    $("modalType").addEventListener("change", ()=>{
      // party options update based on type
      const t = $("modalType").value;
      const opts = guessPartyOptions(modalCandidates.raw, t);
      const sel = $("modalParty");
      sel.innerHTML = "";
      opts.forEach(o=>{
        const op = document.createElement("option");
        op.value=o.value; op.textContent=o.label;
        sel.appendChild(op);
      });
    });

    // OCR analyze
    $("btnAnalyzeText").addEventListener("click", ()=>{
      const raw = normalizeText($("invoiceText").value);
      if(!raw) return alert("OCRãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„");
      const type = guessType(raw);
      const amounts = extractYenCandidates(raw);
      const pieces = extractPiecesCandidates(raw);
      modalCandidates = {amounts, pieces, raw};
      const partyOptions = guessPartyOptions(raw, type);
      openModal(type, partyOptions, amounts, pieces);
    });
    $("btnClearText").addEventListener("click", ()=>{$("invoiceText").value="";});

    // PDF analyze
    $("btnAnalyzePDF").addEventListener("click", async ()=>{
      const f = $("pdfFile").files?.[0];
      if(!f) return alert("PDFã‚’é¸æŠã—ã¦ãã ã•ã„");
      try{
        const txt = normalizeText(await parsePDFFile(f));
        $("invoiceText").value = txt;
        const type = guessType(txt);
        const amounts = extractYenCandidates(txt);
        const pieces = extractPiecesCandidates(txt);
        modalCandidates = {amounts, pieces, raw:txt};
        const partyOptions = guessPartyOptions(txt, type);
        openModal(type, partyOptions, amounts, pieces);
      }catch(e){
        alert("PDFè§£æã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç”»åƒPDFã®å¯èƒ½æ€§ï¼‰ã€‚OCRè²¼ä»˜ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚");
      }
    });
  }

  // ===== Init =====
  loadAll();

  // build selects
  buildPrefSelect($("pref"), false);
  buildPrefSelect($("boardPref"), true);

  // defaults
  if(!state.draft?.report) state.draft.report = {month:nowMonth(), sales:[{client:"",pieces:"",inputAmount:""}], outs:[{vendor:"",area:"",pieces:"",inputAmount:""}]};
  if(!state.draft.report.sales?.length) state.draft.report.sales=[{client:"",pieces:"",inputAmount:""}];
  if(!state.draft.report.outs?.length) state.draft.report.outs=[{vendor:"",area:"",pieces:"",inputAmount:""}];
  if(!state.draft.report.taxRate && state.draft.report.taxRate!==0) state.draft.report.taxRate=10;

  // board month
  $("boardMonth").value = state.draft.report.month || nowMonth();
  $("boardPref").value = "";

  renderMaster();
  renderHistory();
  hydrate();
  wire();

})();
</script>

</body>
</html>
