<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFA æ‹ ç‚¹å£²ä¸Š æœˆæ¬¡ç®¡ç†ï¼ˆFCå¯¾å¿œ / ç¨æŠœç¨è¾¼ / å˜ä¾¡ãƒã‚¹ã‚¿ãƒ¼ï¼‰</title>

  <style>
    :root{
      --bg:#fff;
      --card:#fff;
      --border:#d9d9d9;
      --text:#111;
      --muted:#666;

      --yellow:#FFD400;
      --black:#111;
      --red:#E60012;
      --green:#0FA958;
      --blue:#0066CC;

      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1280px;margin:0 auto;padding:14px 14px 120px}

    /* ===== Header ===== */
    .topbar{
      position:sticky;top:0;z-index:50;
      background:#fff;
      border-bottom:3px solid var(--black);
      padding:12px 10px;
      margin:-14px -14px 14px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:48px;height:48px;border-radius:14px;
      background:var(--yellow);
      border:3px solid var(--black);
      display:grid;place-items:center;
      font-weight:1000;color:#000;letter-spacing:.03em;
    }
    .brand h1{margin:0;font-size:18px;font-weight:1000}
    .brand .sub{margin-top:2px;color:var(--muted);font-size:12px;font-weight:800}

    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:3px solid var(--black);
      border-radius:12px;
      padding:10px 14px;
      font-weight:1000;
      cursor:pointer;
      background:#f5f5f5;
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      user-select:none;
    }
    .btn:hover{opacity:.92}
    .btn-yellow{background:var(--yellow);color:#000}
    .btn-blue{background:var(--blue);color:#fff;border-color:#003b73}
    .btn-green{background:var(--green);color:#fff;border-color:#0b6f3d}
    .btn-red{background:var(--red);color:#fff;border-color:#8f000b}

    /* ===== Tabs ===== */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px}
    .tab{
      border:2px solid var(--black);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1000;
      background:#fff;
      cursor:pointer;
    }
    .tab.active{background:var(--yellow)}
    .card{
      background:var(--card);
      border:3px solid var(--black);
      border-radius:var(--radius);
      padding:14px;
      margin-bottom:14px;
    }
    .muted{color:var(--muted);font-size:12px;font-weight:700;line-height:1.6}
    h2{margin:0 0 10px;font-size:15px;font-weight:1000}
    h3{margin:0 0 10px;font-size:13px;font-weight:1000}

    .row{display:grid;gap:10px}
    @media(min-width:980px){
      .cols2{grid-template-columns:1fr 1fr}
      .cols3{grid-template-columns:1fr 1fr 1fr}
      .cols4{grid-template-columns:1fr 1fr 1fr 1fr}
      .cols5{grid-template-columns:1fr 1fr 1fr 1fr 1fr}
    }
    label{display:block;font-size:12px;font-weight:1000;margin:0 0 5px}
    input,select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:2px solid var(--border);
      font-size:14px;
      background:#fff;
      color:var(--text);
      outline:none;
    }
    input:focus,select:focus{border-color:#999}
    .hr{height:2px;background:rgba(0,0,0,.12);margin:12px 0}

    /* ===== Tables ===== */
    .tableWrap{overflow:auto;border:2px solid var(--border);border-radius:14px}
    table{width:100%;border-collapse:collapse;font-size:13px;background:#fff}
    th,td{border:1px solid var(--border);padding:9px;white-space:nowrap}
    th{background:#f2f2f2;text-align:left;font-weight:1000}
    td.right, th.right{text-align:right}
    td.center, th.center{text-align:center}

    /* ===== Numbers ===== */
    .num{font-variant-numeric:tabular-nums}
    .good{color:var(--green);font-weight:1000}
    .bad{color:var(--red);font-weight:1000}
    .blue{color:var(--blue);font-weight:1000}
    .kpiRow{
      display:grid;gap:10px;
    }
    @media(min-width:980px){.kpiRow{grid-template-columns:1fr 1fr 1fr 1fr}}
    .kpi{
      border:2px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    .kpi .t{font-size:12px;color:var(--muted);font-weight:900}
    .kpi .v{margin-top:6px;font-size:18px;font-weight:1000}
    .kpi .s{margin-top:2px;font-size:12px;color:var(--muted);font-weight:800}

    /* ===== Print ===== */
    @media print{
      .no-print{display:none !important}
      .wrap{padding:0}
      .card{border:1px solid #000}
      .topbar{display:none}
      th{background:#efefef !important}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar no-print">
    <div class="brand">
      <div class="logo">OFA</div>
      <div>
        <h1>OFA æ‹ ç‚¹å£²ä¸Š æœˆæ¬¡ç®¡ç†</h1>
        <div class="sub">FCå¯¾å¿œ / å£²ä¸Šãƒ»å§”è¨—ã‚’å…¥åŠ› â†’ ç¨æŠœ/ç¨è¾¼ è‡ªå‹• â†’ PDF/CSVå‡ºåŠ›</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-yellow" id="btnSave">ğŸ’¾ ç«¯æœ«ä¿å­˜</button>
      <button class="btn btn-blue" id="btnPDF">ğŸ–¨ï¸ PDF</button>
      <button class="btn btn-blue" id="btnCSV">â¬‡ï¸ CSV</button>
      <button class="btn btn-red" id="btnClear">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <div class="tabs no-print">
    <div class="tab active" data-tab="input">å…¥åŠ›</div>
    <div class="tab" data-tab="master">å˜ä¾¡è¨­å®šï¼ˆãƒã‚¹ã‚¿ãƒ¼ï¼‰</div>
    <div class="tab" data-tab="history">å±¥æ­´</div>
  </div>

  <!-- ===================== å…¥åŠ› ===================== -->
  <section id="tab-input">

    <div class="card">
      <h2>â‘  åŸºæœ¬æƒ…å ±</h2>
      <div class="row cols5">
        <div>
          <label>å¯¾è±¡æœˆ</label>
          <input type="month" id="month">
        </div>
        <div>
          <label>å…¥åŠ›è€…åŒºåˆ†</label>
          <select id="role">
            <option value="ã‚¨ãƒªã‚¢ãƒãƒï¼ˆç¾åœ°ï¼‰">ã‚¨ãƒªã‚¢ãƒãƒï¼ˆç¾åœ°ï¼‰</option>
            <option value="å–¶æ¥­ï¼ˆæœ¬éƒ¨/FCç®¡ç†ï¼‰">å–¶æ¥­ï¼ˆæœ¬éƒ¨/FCç®¡ç†ï¼‰</option>
            <option value="ãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚ºï¼ˆFCï¼‰">ãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚ºï¼ˆFCï¼‰</option>
          </select>
        </div>
        <div>
          <label>å ±å‘Šè€…</label>
          <input id="reporter" placeholder="ä¾‹ï¼šæ£®ä¸‹ / â—‹â—‹FCåº—">
        </div>
        <div>
          <label>éƒ½é“åºœçœŒ</label>
          <input id="pref" placeholder="ä¾‹ï¼šç¦å²¡ / é¹¿å…å³¶ / æ±äº¬">
        </div>
        <div>
          <label>æ‹ ç‚¹å</label>
          <input id="base" placeholder="ä¾‹ï¼šç¦å²¡å¸‚å†… / æ±äº¬ï¼ˆè¶³ç«‹ï¼‰">
        </div>
      </div>

      <div class="hr"></div>

      <div class="row cols4">
        <div>
          <label>æ¶ˆè²»ç¨ç‡ï¼ˆ%ï¼‰</label>
          <input id="taxRate" inputmode="decimal" placeholder="ä¾‹ï¼š10">
          <div class="muted">â€»æ¨™æº–10%ã€‚è»½æ¸›ç¨ç‡ãŒã‚ã‚‹ãªã‚‰ãƒã‚¹ã‚¿ãƒ¼å´ã§åˆ†ã‘ã¦é‹ç”¨ã‚‚å¯èƒ½ã€‚</div>
        </div>
        <div>
          <label>å£²ä¸Š é‡‘é¡å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</label>
          <select id="salesMode">
            <option value="ex">ç¨æŠœã§å…¥åŠ›</option>
            <option value="in">ç¨è¾¼ã§å…¥åŠ›</option>
          </select>
        </div>
        <div>
          <label>å§”è¨— é‡‘é¡å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</label>
          <select id="outMode">
            <option value="auto">è·ç‰©å€‹æ•°Ã—å˜ä¾¡ï¼ˆç¨æŠœï¼‰ã§è‡ªå‹•</option>
            <option value="manualEx">é‡‘é¡ï¼ˆç¨æŠœï¼‰ã‚’æ‰‹å…¥åŠ›</option>
            <option value="manualIn">é‡‘é¡ï¼ˆç¨è¾¼ï¼‰ã‚’æ‰‹å…¥åŠ›</option>
          </select>
        </div>
        <div>
          <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <input id="memo" placeholder="ä¾‹ï¼šå¢—å“¡/ç¹å¿™/ã‚¯ãƒ¬ãƒ¼ãƒ /å‰å¹´å·®è¦å› ãªã©">
        </div>
      </div>
    </div>

    <div class="card">
      <h2>â‘¡ å£²ä¸Šå…¥åŠ›ï¼ˆç™ºæ³¨æ¥­è€… Ã— é‡‘é¡ï¼‰</h2>

      <div class="muted">
        ç™ºæ³¨æ¥­è€…ã¯ã€Œå˜ä¾¡è¨­å®šï¼ˆãƒã‚¹ã‚¿ãƒ¼ï¼‰ã€ã§ç™»éŒ² â†’ ã“ã“ã§ã¯<b>é¸ã¶ã ã‘</b>ã€‚<br>
        â€»é‡‘é¡ã¯ã€Œç¨æŠœ/ç¨è¾¼ãƒ¢ãƒ¼ãƒ‰ã€ã«åˆã‚ã›ã¦å…¥åŠ›ã€‚
      </div>

      <div style="margin-top:10px" class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:220px">ç™ºæ³¨æ¥­è€…å</th>
              <th class="right">å…¥åŠ›é‡‘é¡</th>
              <th class="right">ç¨æŠœ</th>
              <th class="right">ç¨è¾¼</th>
              <th class="center">å‰Šé™¤</th>
            </tr>
          </thead>
          <tbody id="salesTbody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap" class="no-print">
        <button class="btn btn-yellow" id="btnAddSale">ï¼‹ å£²ä¸Šè¡Œã‚’è¿½åŠ </button>
      </div>
    </div>

    <div class="card">
      <h2>â‘¢ å§”è¨—å…¥åŠ›ï¼ˆå§”è¨—æ¥­è€… Ã— æ‹…å½“åœ°åŸŸ Ã— è·ç‰©å€‹æ•°ï¼‰</h2>

      <div class="muted">
        å§”è¨—æ¥­è€…ãƒ»æ‹…å½“åœ°åŸŸã¯ãƒã‚¹ã‚¿ãƒ¼ç™»éŒ² â†’ ã“ã“ã§ã¯<b>é¸ã¶ã ã‘</b>ã€‚<br>
        ã€Œè·ç‰©å€‹æ•°ã€ã‚’å…¥ã‚Œã‚‹ã¨ <b>å˜ä¾¡ãŒè‡ªå‹•ã§å…¥ã‚Šã€é‡‘é¡ãŒè‡ªå‹•è¨ˆç®—</b> ã•ã‚Œã¾ã™ï¼ˆå§”è¨—ãƒ¢ãƒ¼ãƒ‰=è‡ªå‹•ã®å ´åˆï¼‰ã€‚
      </div>

      <div style="margin-top:10px" class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:220px">å§”è¨—æ¥­è€…</th>
              <th style="min-width:180px">æ‹…å½“åœ°åŸŸ</th>
              <th class="right">è·ç‰©å€‹æ•°</th>
              <th class="right">å˜ä¾¡ï¼ˆç¨æŠœï¼‰</th>
              <th class="right">é‡‘é¡ å…¥åŠ›/è‡ªå‹•</th>
              <th class="right">ç¨æŠœ</th>
              <th class="right">ç¨è¾¼</th>
              <th class="center">å‰Šé™¤</th>
            </tr>
          </thead>
          <tbody id="outTbody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap" class="no-print">
        <button class="btn btn-yellow" id="btnAddOut">ï¼‹ å§”è¨—è¡Œã‚’è¿½åŠ </button>
      </div>
    </div>

    <div class="card">
      <h2>â‘£ é›†è¨ˆï¼ˆé»’ï¼‹èµ¤ï¼‹ç·‘ã§å³åˆ¤æ–­ï¼‰</h2>

      <div class="kpiRow">
        <div class="kpi">
          <div class="t">å£²ä¸Šåˆè¨ˆ</div>
          <div class="v num" id="kpiSales">0</div>
          <div class="s">ç¨æŠœ/ç¨è¾¼ä¸¡æ–¹</div>
        </div>
        <div class="kpi">
          <div class="t">å§”è¨—åˆè¨ˆ</div>
          <div class="v num" id="kpiOut">0</div>
          <div class="s">ç¨æŠœ/ç¨è¾¼ä¸¡æ–¹</div>
        </div>
        <div class="kpi">
          <div class="t">ç²—åˆ©ï¼ˆ= å£²ä¸Š âˆ’ å§”è¨—ï¼‰</div>
          <div class="v num" id="kpiGross">0</div>
          <div class="s">ãƒ—ãƒ©ã‚¹ç·‘ / ãƒã‚¤ãƒŠã‚¹èµ¤</div>
        </div>
        <div class="kpi">
          <div class="t">ç²—åˆ©ç‡</div>
          <div class="v num blue" id="kpiRate">0.0%</div>
          <div class="s">ç¨æŠœãƒ™ãƒ¼ã‚¹</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="muted">
        â€»ã€Œæœ€çµ‚åˆ©ç›Šã€ã¯ã€ä»Šã¯<b>ç²—åˆ©</b>ã¨åŒç¾©ï¼ˆæœ¬éƒ¨çµŒè²»ãªã©ã‚’å¾Œã‹ã‚‰è¿½åŠ æ‹¡å¼µã§ãã¾ã™ï¼‰ã€‚<br>
        â€»PDFã¯ã“ã®é›†è¨ˆãŒè¦‹ã‚„ã™ã„ã‚ˆã†ã«å°åˆ·æœ€é©åŒ–æ¸ˆã¿ã€‚
      </div>
    </div>

    <div class="card no-print">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn btn-green" id="btnSaveHistory">ğŸ“Œ ã“ã®æœˆæ¬¡ã‚’å±¥æ­´ã«ä¿å­˜</button>
        <span class="muted">ä¿å­˜ã™ã‚‹ã¨ã€Œå±¥æ­´ã€ã‚¿ãƒ–ã§æœˆåˆ¥ã«å‘¼ã³å‡ºã›ã¾ã™ï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰</span>
      </div>
    </div>

  </section>

  <!-- ===================== ãƒã‚¹ã‚¿ãƒ¼ ===================== -->
  <section id="tab-master" style="display:none">

    <div class="card">
      <h2>å˜ä¾¡è¨­å®šï¼ˆãƒã‚¹ã‚¿ãƒ¼ï¼‰</h2>
      <div class="muted">
        ã“ã“ã§ç™»éŒ²ã—ãŸå†…å®¹ãŒã€Œå…¥åŠ›ã€ã‚¿ãƒ–ã§<b>é¸ã¶ã ã‘</b>ã«ãªã‚Šã¾ã™ã€‚<br>
        æ¨å¥¨ï¼š<b>å§”è¨—æ¥­è€… Ã— æ‹…å½“åœ°åŸŸ</b> ã”ã¨ã«å˜ä¾¡ï¼ˆç¨æŠœï¼‰ã‚’ç™»éŒ²ã€‚
      </div>

      <div class="hr"></div>

      <div class="row cols3">
        <div>
          <h3>â‘  ç™ºæ³¨æ¥­è€…ï¼ˆå£²ä¸Šï¼‰</h3>
          <div style="display:flex;gap:8px">
            <input id="newClient" placeholder="ä¾‹ï¼šãƒ•ã‚§ãƒªã‚·ãƒ¢ / SHEIN / Amazon ãªã©">
            <button class="btn btn-yellow" id="btnAddClient">è¿½åŠ </button>
          </div>
          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead><tr><th>ç™ºæ³¨æ¥­è€…å</th><th class="center">å‰Šé™¤</th></tr></thead>
              <tbody id="clientTbody"></tbody>
            </table>
          </div>
        </div>

        <div>
          <h3>â‘¡ å§”è¨—æ¥­è€…ï¼ˆæ”¯æ‰•ã„ï¼‰</h3>
          <div style="display:flex;gap:8px">
            <input id="newVendor" placeholder="ä¾‹ï¼šãƒ–ãƒ«ãƒ¼ãƒŸãƒ¼ / DARUMA / Lifes ãªã©">
            <button class="btn btn-yellow" id="btnAddVendor">è¿½åŠ </button>
          </div>
          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead><tr><th>å§”è¨—æ¥­è€…å</th><th class="center">å‰Šé™¤</th></tr></thead>
              <tbody id="vendorTbody"></tbody>
            </table>
          </div>
        </div>

        <div>
          <h3>â‘¢ æ‹…å½“åœ°åŸŸ</h3>
          <div style="display:flex;gap:8px">
            <input id="newArea" placeholder="ä¾‹ï¼šç¦å²¡å¸‚å†… / æ±äº¬ï¼ˆè¶³ç«‹ï¼‰">
            <button class="btn btn-yellow" id="btnAddArea">è¿½åŠ </button>
          </div>
          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead><tr><th>æ‹…å½“åœ°åŸŸ</th><th class="center">å‰Šé™¤</th></tr></thead>
              <tbody id="areaTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <h3>â‘£ å˜ä¾¡ãƒã‚¹ã‚¿ãƒ¼ï¼ˆå§”è¨—æ¥­è€… Ã— æ‹…å½“åœ°åŸŸ â†’ å˜ä¾¡ï¼‰</h3>
      <div class="muted">â€»å˜ä¾¡ã¯ <b>ç¨æŠœ</b> ã§ç™»éŒ²ã—ã¦ãã ã•ã„ï¼ˆç¨ç‡ã¯å…¥åŠ›ã‚¿ãƒ–ã®ç¨ç‡è¨­å®šã§è¨ˆç®—ï¼‰ã€‚</div>

      <div style="margin-top:10px" class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:220px">å§”è¨—æ¥­è€…</th>
              <th style="min-width:180px">æ‹…å½“åœ°åŸŸ</th>
              <th class="right">å˜ä¾¡ï¼ˆç¨æŠœï¼‰</th>
              <th class="center">å‰Šé™¤</th>
            </tr>
          </thead>
          <tbody id="priceTbody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap" class="no-print">
        <button class="btn btn-yellow" id="btnAddPrice">ï¼‹ å˜ä¾¡è¡Œã‚’è¿½åŠ </button>
      </div>

      <div class="hr"></div>
      <div class="no-print" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn btn-green" id="btnSaveMaster">ğŸ’¾ ãƒã‚¹ã‚¿ãƒ¼ä¿å­˜</button>
        <button class="btn btn-red" id="btnResetMaster">ğŸ§¨ ãƒã‚¹ã‚¿ãƒ¼åˆæœŸåŒ–</button>
        <span class="muted">â€»ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ä¿å­˜ã€‚å…¨å“¡ã§çµ±ä¸€ã™ã‚‹ãªã‚‰CSVå…±æœ‰â†’è²¼ã‚Šä»˜ã‘æ–¹å¼ã‚‚è¿½åŠ ã§ãã¾ã™ã€‚</span>
      </div>
    </div>

  </section>

  <!-- ===================== å±¥æ­´ ===================== -->
  <section id="tab-history" style="display:none">

    <div class="card">
      <h2>å±¥æ­´ï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰</h2>
      <div class="muted">
        ã€Œå…¥åŠ›ã€ã‚¿ãƒ–ã§ä¿å­˜ã—ãŸæœˆæ¬¡ã‚’ã€ã“ã“ã§å‘¼ã³å‡ºã—ã¦ç·¨é›†ãƒ»PDFãƒ»CSVã§ãã¾ã™ã€‚<br>
        â€»å…±æœ‰ã¯PDF/CSVã‚’LINEã§é€ã‚‹é‹ç”¨ã§OKã€‚
      </div>

      <div class="hr"></div>

      <div class="row cols3">
        <div>
          <label>ä¿å­˜æ¸ˆã¿ä¸€è¦§</label>
          <select id="historySelect"></select>
        </div>
        <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap" class="no-print">
          <button class="btn btn-yellow" id="btnLoadHistory">å‘¼ã³å‡ºã—</button>
          <button class="btn btn-red" id="btnDeleteHistory">å‰Šé™¤</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="muted">
        âœ… é‹ç”¨ï¼š<b>å…¥åŠ› â†’ å±¥æ­´ä¿å­˜ â†’ PDF/CSV</b>ï¼ˆä¿®æ­£ã‚‚å±¥æ­´ã‹ã‚‰å¯èƒ½ï¼‰
      </div>
    </div>

  </section>

</div>

<script>
(() => {
  const LS_MASTER = "ofa_master_v1";
  const LS_FORM   = "ofa_form_draft_v1";
  const LS_HIST   = "ofa_history_v1";

  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const num = (v)=> {
    const s = String(v??"").replace(/[^\d.-]/g,"");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };
  const yen = (n)=> (Number(n)||0).toLocaleString("ja-JP");
  const pct = (v)=> (v*100).toFixed(1) + "%";
  const nowMonth = ()=>{
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,7);
  };

  // ========= State =========
  const state = {
    master: {
      clients: ["ãƒ•ã‚§ãƒªã‚·ãƒ¢","SHEIN","Amazon","ãƒ¤ãƒãƒˆ","ä½å·"],
      vendors: ["DARUMA","ãƒ–ãƒ«ãƒ¼ãƒŸãƒ¼","Lifes"],
      areas: ["ç¦å²¡å¸‚å†…","æ±äº¬ï¼ˆè¶³ç«‹ï¼‰","é¹¿å…å³¶"],
      prices: [
        {vendor:"DARUMA", area:"ç¦å²¡å¸‚å†…", unit:200},
        {vendor:"ãƒ–ãƒ«ãƒ¼ãƒŸãƒ¼", area:"æ±äº¬ï¼ˆè¶³ç«‹ï¼‰", unit:17000},
      ],
    },
    form: {
      month: nowMonth(),
      role: "ã‚¨ãƒªã‚¢ãƒãƒï¼ˆç¾åœ°ï¼‰",
      reporter: "",
      pref: "",
      base: "",
      memo: "",
      taxRate: 10,
      salesMode: "ex",   // ex or in
      outMode: "auto",   // auto / manualEx / manualIn
      sales: [],         // {client, inputAmount}
      outs: [],          // {vendor, area, pieces, unit, inputAmount}
    },
    history: [] // {id, savedAt, snapshot}
  };

  // ========= Load =========
  function loadAll(){
    try{
      const m = localStorage.getItem(LS_MASTER);
      if(m) state.master = JSON.parse(m);
    }catch(e){}
    try{
      const f = localStorage.getItem(LS_FORM);
      if(f) state.form = JSON.parse(f);
    }catch(e){}
    try{
      const h = localStorage.getItem(LS_HIST);
      if(h) state.history = JSON.parse(h);
    }catch(e){}
  }

  // ========= Save =========
  function saveDraft(){
    localStorage.setItem(LS_FORM, JSON.stringify(state.form));
  }
  function saveMaster(){
    localStorage.setItem(LS_MASTER, JSON.stringify(state.master));
  }
  function saveHistoryStore(){
    localStorage.setItem(LS_HIST, JSON.stringify(state.history));
  }

  // ========= Tabs =========
  function setTab(name){
    ["input","master","history"].forEach(t=>{
      const sec = $("tab-"+t);
      sec.style.display = (t===name) ? "" : "none";
      document.querySelectorAll(".tab").forEach(el=>{
        el.classList.toggle("active", el.dataset.tab===name);
      });
    });
  }
  document.querySelectorAll(".tab").forEach(el=>{
    el.addEventListener("click", ()=>setTab(el.dataset.tab));
  });

  // ========= Helpers: Master lookups =========
  function getUnitPrice(vendor, area){
    const hit = (state.master.prices||[]).find(p=>p.vendor===vendor && p.area===area);
    return hit ? Number(hit.unit||0) : 0;
  }

  // ========= Render: Sales rows =========
  const salesTbody = $("salesTbody");
  function renderSales(){
    const opts = state.master.clients.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
    salesTbody.innerHTML = state.form.sales.map((r,idx)=>{
      const mode = state.form.salesMode;
      const tax = num(state.form.taxRate)/100;
      const inputAmount = num(r.inputAmount);
      const ex = mode==="ex" ? inputAmount : (tax ? inputAmount/(1+tax) : inputAmount);
      const inc = mode==="in" ? inputAmount : ex*(1+tax);
      return `
        <tr>
          <td>
            <select data-k="client" data-i="${idx}">
              <option value="">é¸æŠ</option>
              ${opts}
            </select>
          </td>
          <td class="right">
            <input class="num" data-k="inputAmount" data-i="${idx}" inputmode="decimal" placeholder="é‡‘é¡" value="${r.inputAmount??""}">
          </td>
          <td class="right num">${yen(Math.round(ex))}</td>
          <td class="right num">${yen(Math.round(inc))}</td>
          <td class="center"><button class="btn btn-red" data-del-sale="${idx}">Ã—</button></td>
        </tr>
      `;
    }).join("");

    // set selected + bind
    salesTbody.querySelectorAll('select[data-k="client"]').forEach(sel=>{
      const i = Number(sel.dataset.i);
      sel.value = state.form.sales[i].client || "";
      sel.addEventListener("change", ()=>{
        state.form.sales[i].client = sel.value;
        saveDraft(); recalcAll();
      });
    });
    salesTbody.querySelectorAll('input[data-k="inputAmount"]').forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=>{
        state.form.sales[i].inputAmount = inp.value;
        saveDraft(); recalcAll();
      });
      inp.addEventListener("blur", ()=>{
        const v = num(inp.value);
        inp.value = v ? String(v) : "";
        state.form.sales[i].inputAmount = inp.value;
        saveDraft(); recalcAll();
      });
    });
    salesTbody.querySelectorAll('button[data-del-sale]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delSale);
        state.form.sales.splice(i,1);
        saveDraft(); renderSales(); recalcAll();
      });
    });
  }

  // ========= Render: Outs rows =========
  const outTbody = $("outTbody");
  function renderOuts(){
    const vOpts = state.master.vendors.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
    const aOpts = state.master.areas.map(a=>`<option value="${esc(a)}">${esc(a)}</option>`).join("");

    outTbody.innerHTML = state.form.outs.map((r,idx)=>{
      const outMode = state.form.outMode;
      const tax = num(state.form.taxRate)/100;

      const pieces = num(r.pieces);
      const unit = num(r.unit);
      const autoEx = pieces * unit;

      let inputAmount = num(r.inputAmount);
      let ex = 0, inc = 0;

      if(outMode==="auto"){
        ex = autoEx;
        inc = ex*(1+tax);
      } else if(outMode==="manualEx"){
        ex = inputAmount;
        inc = ex*(1+tax);
      } else { // manualIn
        inc = inputAmount;
        ex = tax ? inc/(1+tax) : inc;
      }

      const displayUnit = (outMode==="auto") ? unit : unit; // show unit anyway
      const amountLabel = (outMode==="auto") ? "è‡ªå‹•" : "å…¥åŠ›";

      return `
        <tr>
          <td>
            <select data-ok="vendor" data-i="${idx}">
              <option value="">é¸æŠ</option>
              ${vOpts}
            </select>
          </td>
          <td>
            <select data-ok="area" data-i="${idx}">
              <option value="">é¸æŠ</option>
              ${aOpts}
            </select>
          </td>
          <td class="right">
            <input class="num" data-ok="pieces" data-i="${idx}" inputmode="numeric" placeholder="å€‹æ•°" value="${r.pieces??""}">
          </td>
          <td class="right num">${yen(Math.round(displayUnit))}</td>
          <td class="right">
            <input class="num" data-ok="inputAmount" data-i="${idx}" inputmode="decimal" placeholder="${amountLabel}" value="${(outMode==="auto") ? "" : (r.inputAmount??"")}">
          </td>
          <td class="right num">${yen(Math.round(ex))}</td>
          <td class="right num">${yen(Math.round(inc))}</td>
          <td class="center"><button class="btn btn-red" data-del-out="${idx}">Ã—</button></td>
        </tr>
      `;
    }).join("");

    // set + bind
    outTbody.querySelectorAll('select[data-ok="vendor"]').forEach(sel=>{
      const i = Number(sel.dataset.i);
      sel.value = state.form.outs[i].vendor || "";
      sel.addEventListener("change", ()=>{
        state.form.outs[i].vendor = sel.value;
        // update unit if auto and area exists
        if(state.form.outMode==="auto"){
          const area = state.form.outs[i].area || "";
          state.form.outs[i].unit = getUnitPrice(sel.value, area);
        }
        saveDraft(); renderOuts(); recalcAll();
      });
    });
    outTbody.querySelectorAll('select[data-ok="area"]').forEach(sel=>{
      const i = Number(sel.dataset.i);
      sel.value = state.form.outs[i].area || "";
      sel.addEventListener("change", ()=>{
        state.form.outs[i].area = sel.value;
        if(state.form.outMode==="auto"){
          const vendor = state.form.outs[i].vendor || "";
          state.form.outs[i].unit = getUnitPrice(vendor, sel.value);
        }
        saveDraft(); renderOuts(); recalcAll();
      });
    });
    outTbody.querySelectorAll('input[data-ok="pieces"]').forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=>{
        state.form.outs[i].pieces = inp.value;
        // auto keeps unit
        saveDraft(); recalcAll();
      });
      inp.addEventListener("blur", ()=>{
        const v = num(inp.value);
        inp.value = v ? String(v) : "";
        state.form.outs[i].pieces = inp.value;
        saveDraft(); recalcAll();
      });
    });
    outTbody.querySelectorAll('input[data-ok="inputAmount"]').forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=>{
        state.form.outs[i].inputAmount = inp.value;
        saveDraft(); recalcAll();
      });
      inp.addEventListener("blur", ()=>{
        const v = num(inp.value);
        inp.value = v ? String(v) : "";
        state.form.outs[i].inputAmount = inp.value;
        saveDraft(); recalcAll();
      });
    });
    outTbody.querySelectorAll('button[data-del-out]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delOut);
        state.form.outs.splice(i,1);
        saveDraft(); renderOuts(); recalcAll();
      });
    });
  }

  // ========= Recalc KPIs =========
  function recalcAll(){
    const tax = num(state.form.taxRate)/100;

    // Sales totals (ex/in)
    let salesEx = 0, salesIn = 0;
    state.form.sales.forEach(r=>{
      const mode = state.form.salesMode;
      const inputAmount = num(r.inputAmount);
      const ex = mode==="ex" ? inputAmount : (tax ? inputAmount/(1+tax) : inputAmount);
      const inc = mode==="in" ? inputAmount : ex*(1+tax);
      salesEx += ex;
      salesIn += inc;
    });

    // Outs totals (ex/in)
    let outEx = 0, outIn = 0;
    state.form.outs.forEach(r=>{
      const outMode = state.form.outMode;
      const pieces = num(r.pieces);
      const unit = num(r.unit);
      const autoEx = pieces * unit;
      const inputAmount = num(r.inputAmount);

      let ex = 0, inc = 0;
      if(outMode==="auto"){
        ex = autoEx;
        inc = ex*(1+tax);
      } else if(outMode==="manualEx"){
        ex = inputAmount;
        inc = ex*(1+tax);
      } else { // manualIn
        inc = inputAmount;
        ex = tax ? inc/(1+tax) : inc;
      }
      outEx += ex;
      outIn += inc;
    });

    const grossEx = salesEx - outEx;
    const grossIn = salesIn - outIn;
    const rate = salesEx ? (grossEx / salesEx) : 0;

    const salesTxt = `ç¨æŠœ ${yen(Math.round(salesEx))} / ç¨è¾¼ ${yen(Math.round(salesIn))}`;
    const outTxt   = `ç¨æŠœ ${yen(Math.round(outEx))} / ç¨è¾¼ ${yen(Math.round(outIn))}`;
    const grossTxt = `ç¨æŠœ ${yen(Math.round(grossEx))} / ç¨è¾¼ ${yen(Math.round(grossIn))}`;

    $("kpiSales").textContent = salesTxt;
    $("kpiOut").textContent   = outTxt;
    $("kpiGross").textContent = grossTxt;
    $("kpiGross").className   = "v num " + (grossEx>=0 ? "good" : "bad");
    $("kpiRate").textContent  = pct(rate);

    // keep units updated if auto
    if(state.form.outMode==="auto"){
      state.form.outs.forEach(r=>{
        if(r.vendor && r.area){
          r.unit = getUnitPrice(r.vendor, r.area);
        }
      });
      saveDraft();
    }
  }

  // ========= Render Master =========
  function renderMasterLists(){
    // clients
    $("clientTbody").innerHTML = state.master.clients.map((c,idx)=>`
      <tr><td>${esc(c)}</td><td class="center"><button class="btn btn-red" data-del-client="${idx}">Ã—</button></td></tr>
    `).join("");
    $("clientTbody").querySelectorAll("button[data-del-client]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delClient);
        state.master.clients.splice(i,1);
        renderMasterLists(); renderSales(); saveMaster(); saveDraft(); recalcAll();
      });
    });

    // vendors
    $("vendorTbody").innerHTML = state.master.vendors.map((v,idx)=>`
      <tr><td>${esc(v)}</td><td class="center"><button class="btn btn-red" data-del-vendor="${idx}">Ã—</button></td></tr>
    `).join("");
    $("vendorTbody").querySelectorAll("button[data-del-vendor]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delVendor);
        const name = state.master.vendors[i];
        state.master.vendors.splice(i,1);
        // remove prices of this vendor
        state.master.prices = state.master.prices.filter(p=>p.vendor!==name);
        renderMasterLists(); renderOuts(); saveMaster(); saveDraft(); recalcAll();
      });
    });

    // areas
    $("areaTbody").innerHTML = state.master.areas.map((a,idx)=>`
      <tr><td>${esc(a)}</td><td class="center"><button class="btn btn-red" data-del-area="${idx}">Ã—</button></td></tr>
    `).join("");
    $("areaTbody").querySelectorAll("button[data-del-area]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delArea);
        const name = state.master.areas[i];
        state.master.areas.splice(i,1);
        // remove prices of this area
        state.master.prices = state.master.prices.filter(p=>p.area!==name);
        renderMasterLists(); renderOuts(); saveMaster(); saveDraft(); recalcAll();
      });
    });

    // prices
    const vOpts = state.master.vendors.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
    const aOpts = state.master.areas.map(a=>`<option value="${esc(a)}">${esc(a)}</option>`).join("");

    $("priceTbody").innerHTML = state.master.prices.map((p,idx)=>`
      <tr>
        <td>
          <select data-pk="vendor" data-i="${idx}">
            <option value="">é¸æŠ</option>${vOpts}
          </select>
        </td>
        <td>
          <select data-pk="area" data-i="${idx}">
            <option value="">é¸æŠ</option>${aOpts}
          </select>
        </td>
        <td class="right">
          <input class="num" data-pk="unit" data-i="${idx}" inputmode="decimal" placeholder="å˜ä¾¡" value="${p.unit??""}">
        </td>
        <td class="center"><button class="btn btn-red" data-del-price="${idx}">Ã—</button></td>
      </tr>
    `).join("");

    // set selected + bind
    $("priceTbody").querySelectorAll('select[data-pk="vendor"]').forEach(sel=>{
      const i = Number(sel.dataset.i);
      sel.value = state.master.prices[i].vendor || "";
      sel.addEventListener("change", ()=>{
        state.master.prices[i].vendor = sel.value;
      });
    });
    $("priceTbody").querySelectorAll('select[data-pk="area"]').forEach(sel=>{
      const i = Number(sel.dataset.i);
      sel.value = state.master.prices[i].area || "";
      sel.addEventListener("change", ()=>{
        state.master.prices[i].area = sel.value;
      });
    });
    $("priceTbody").querySelectorAll('input[data-pk="unit"]').forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=> state.master.prices[i].unit = inp.value );
      inp.addEventListener("blur", ()=>{
        const v = num(inp.value);
        inp.value = v ? String(v) : "";
        state.master.prices[i].unit = inp.value;
      });
    });
    $("priceTbody").querySelectorAll('button[data-del-price]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delPrice);
        state.master.prices.splice(i,1);
        renderMasterLists();
      });
    });
  }

  // ========= History =========
  function renderHistory(){
    const sel = $("historySelect");
    sel.innerHTML = "";
    if(!state.history.length){
      const op = document.createElement("option");
      op.value = "";
      op.textContent = "ï¼ˆå±¥æ­´ãªã—ï¼‰";
      sel.appendChild(op);
      return;
    }
    state.history
      .slice()
      .sort((a,b)=> (b.savedAt||"").localeCompare(a.savedAt||""))
      .forEach(h=>{
        const snap = h.snapshot;
        const label = `${snap.month || "æœªè¨­å®š"} / ${snap.pref||""} ${snap.base||""} / ${snap.reporter||""}ï¼ˆ${snap.role||""}ï¼‰`;
        const op = document.createElement("option");
        op.value = h.id;
        op.textContent = label;
        sel.appendChild(op);
      });
  }

  function snapshotForm(){
    // deep clone
    return JSON.parse(JSON.stringify(state.form));
  }

  // ========= CSV Export (single combined) =========
  function csvEscape(v){
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }
  function downloadText(text, filename, mime){
    const blob = new Blob([text], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportCSV(){
    const tax = num(state.form.taxRate)/100;

    // totals
    let salesEx=0, salesIn=0, outEx=0, outIn=0;
    // build rows
    const lines = [];

    // header info
    const headerRow = {
      type:"SUMMARY",
      month: state.form.month,
      role: state.form.role,
      reporter: state.form.reporter,
      pref: state.form.pref,
      base: state.form.base,
      memo: state.form.memo,
      taxRate: state.form.taxRate
    };

    // sales
    state.form.sales.forEach(r=>{
      const inputAmount = num(r.inputAmount);
      const ex = state.form.salesMode==="ex" ? inputAmount : (tax ? inputAmount/(1+tax) : inputAmount);
      const inc = state.form.salesMode==="in" ? inputAmount : ex*(1+tax);
      salesEx += ex; salesIn += inc;

      lines.push({
        type:"SALES",
        client: r.client||"",
        inputMode: state.form.salesMode,
        inputAmount: inputAmount,
        taxExcluded: Math.round(ex),
        taxIncluded: Math.round(inc)
      });
    });

    // outs
    state.form.outs.forEach(r=>{
      const pieces = num(r.pieces);
      const unit = num(r.unit);
      const autoEx = pieces * unit;
      const inputAmount = num(r.inputAmount);

      let ex=0, inc=0;
      if(state.form.outMode==="auto"){
        ex = autoEx; inc = ex*(1+tax);
      } else if(state.form.outMode==="manualEx"){
        ex = inputAmount; inc = ex*(1+tax);
      } else {
        inc = inputAmount; ex = tax ? inc/(1+tax) : inc;
      }
      outEx += ex; outIn += inc;

      lines.push({
        type:"OUTSOURCE",
        vendor: r.vendor||"",
        area: r.area||"",
        pieces: pieces,
        unitEx: Math.round(unit),
        mode: state.form.outMode,
        inputAmount: (state.form.outMode==="auto") ? "" : inputAmount,
        taxExcluded: Math.round(ex),
        taxIncluded: Math.round(inc)
      });
    });

    const grossEx = salesEx - outEx;
    const grossIn = salesIn - outIn;

    headerRow.salesEx = Math.round(salesEx);
    headerRow.salesIn = Math.round(salesIn);
    headerRow.outEx = Math.round(outEx);
    headerRow.outIn = Math.round(outIn);
    headerRow.grossEx = Math.round(grossEx);
    headerRow.grossIn = Math.round(grossIn);
    headerRow.grossRate = salesEx ? (grossEx / salesEx) : 0;

    // build csv
    const cols = [
      "type","month","role","reporter","pref","base","memo","taxRate",
      "salesEx","salesIn","outEx","outIn","grossEx","grossIn","grossRate",
      "client","inputMode","vendor","area","pieces","unitEx","mode","inputAmount","taxExcluded","taxIncluded"
    ];
    const rows = [];
    rows.push(cols.join(","));
    rows.push(cols.map(c=>csvEscape(headerRow[c] ?? "")).join(","));
    lines.forEach(o=>{
      const r = {};
      cols.forEach(c=>r[c]="");
      Object.assign(r, o);
      r.month = state.form.month;
      r.pref = state.form.pref;
      r.base = state.form.base;
      r.reporter = state.form.reporter;
      r.role = state.form.role;
      rows.push(cols.map(c=>csvEscape(r[c] ?? "")).join(","));
    });

    const fn = `OFA_æ‹ ç‚¹å£²ä¸Š_${state.form.month||"æœªè¨­å®š"}_${state.form.pref||""}_${state.form.base||""}.csv`;
    downloadText(rows.join("\n"), fn, "text/csv");
  }

  // ========= Wire form fields =========
  function wireBaseFields(){
    const bind = (id, key)=>{
      $(id).addEventListener("input", ()=>{
        state.form[key] = $(id).value;
        saveDraft(); recalcAll();
      });
    };
    bind("month","month");
    bind("reporter","reporter");
    bind("pref","pref");
    bind("base","base");
    bind("memo","memo");

    $("role").addEventListener("change", ()=>{
      state.form.role = $("role").value;
      saveDraft(); recalcAll();
    });

    $("taxRate").addEventListener("input", ()=>{
      state.form.taxRate = $("taxRate").value;
      saveDraft(); renderSales(); renderOuts(); recalcAll();
    });

    $("salesMode").addEventListener("change", ()=>{
      state.form.salesMode = $("salesMode").value;
      saveDraft(); renderSales(); recalcAll();
    });

    $("outMode").addEventListener("change", ()=>{
      state.form.outMode = $("outMode").value;
      // if switching to auto, refresh units
      if(state.form.outMode==="auto"){
        state.form.outs.forEach(r=>{
          if(r.vendor && r.area) r.unit = getUnitPrice(r.vendor, r.area);
        });
      }
      saveDraft(); renderOuts(); recalcAll();
    });
  }

  // ========= Buttons =========
  function wireButtons(){
    $("btnAddSale").addEventListener("click", ()=>{
      state.form.sales.push({client:"", inputAmount:""});
      saveDraft(); renderSales(); recalcAll();
    });
    $("btnAddOut").addEventListener("click", ()=>{
      state.form.outs.push({vendor:"", area:"", pieces:"", unit:0, inputAmount:""});
      // auto units if possible
      saveDraft(); renderOuts(); recalcAll();
    });

    $("btnSave").addEventListener("click", ()=>{
      saveDraft();
      alert("ç«¯æœ«ã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆä¸‹æ›¸ãï¼‰");
    });

    $("btnPDF").addEventListener("click", ()=>{
      // ensure latest calc
      recalcAll();
      window.print();
    });

    $("btnCSV").addEventListener("click", exportCSV);

    $("btnClear").addEventListener("click", ()=>{
      if(!confirm("å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒã‚¹ã‚¿ãƒ¼ã¯æ®‹ã‚Šã¾ã™ï¼‰")) return;
      state.form.sales = [];
      state.form.outs = [];
      state.form.memo = "";
      saveDraft();
      renderSales(); renderOuts(); recalcAll();
    });

    $("btnSaveHistory").addEventListener("click", ()=>{
      if(!state.form.month) return alert("å¯¾è±¡æœˆãŒæœªè¨­å®šã§ã™");
      const id = crypto?.randomUUID ? crypto.randomUUID() : String(Date.now());
      state.history.push({id, savedAt: new Date().toISOString(), snapshot: snapshotForm()});
      saveHistoryStore();
      renderHistory();
      alert("å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ");
    });

    $("btnLoadHistory").addEventListener("click", ()=>{
      const id = $("historySelect").value;
      if(!id) return;
      const h = state.history.find(x=>x.id===id);
      if(!h) return;
      state.form = JSON.parse(JSON.stringify(h.snapshot));
      saveDraft();
      hydrateFormUI();
      renderSales(); renderOuts(); recalcAll();
      setTab("input");
    });

    $("btnDeleteHistory").addEventListener("click", ()=>{
      const id = $("historySelect").value;
      if(!id) return;
      if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      state.history = state.history.filter(x=>x.id!==id);
      saveHistoryStore();
      renderHistory();
    });

    // Master buttons
    $("btnAddClient").addEventListener("click", ()=>{
      const v = $("newClient").value.trim();
      if(!v) return;
      if(!state.master.clients.includes(v)) state.master.clients.push(v);
      $("newClient").value = "";
      renderMasterLists(); saveMaster(); renderSales();
    });
    $("btnAddVendor").addEventListener("click", ()=>{
      const v = $("newVendor").value.trim();
      if(!v) return;
      if(!state.master.vendors.includes(v)) state.master.vendors.push(v);
      $("newVendor").value = "";
      renderMasterLists(); saveMaster(); renderOuts();
    });
    $("btnAddArea").addEventListener("click", ()=>{
      const v = $("newArea").value.trim();
      if(!v) return;
      if(!state.master.areas.includes(v)) state.master.areas.push(v);
      $("newArea").value = "";
      renderMasterLists(); saveMaster(); renderOuts();
    });
    $("btnAddPrice").addEventListener("click", ()=>{
      state.master.prices.push({vendor:"", area:"", unit:""});
      renderMasterLists();
    });
    $("btnSaveMaster").addEventListener("click", ()=>{
      // normalize: remove empty rows
      state.master.clients = (state.master.clients||[]).map(s=>String(s).trim()).filter(Boolean);
      state.master.vendors = (state.master.vendors||[]).map(s=>String(s).trim()).filter(Boolean);
      state.master.areas   = (state.master.areas||[]).map(s=>String(s).trim()).filter(Boolean);
      state.master.prices  = (state.master.prices||[])
        .map(p=>({vendor:String(p.vendor||"").trim(), area:String(p.area||"").trim(), unit:num(p.unit)}))
        .filter(p=>p.vendor && p.area && p.unit>0);

      saveMaster();
      // refresh units in form if auto
      if(state.form.outMode==="auto"){
        state.form.outs.forEach(r=>{
          if(r.vendor && r.area) r.unit = getUnitPrice(r.vendor, r.area);
        });
        saveDraft();
      }
      renderMasterLists(); renderSales(); renderOuts(); recalcAll();
      alert("ãƒã‚¹ã‚¿ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    });
    $("btnResetMaster").addEventListener("click", ()=>{
      if(!confirm("ãƒã‚¹ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      localStorage.removeItem(LS_MASTER);
      loadAll();
      renderMasterLists(); renderSales(); renderOuts(); recalcAll();
      alert("åˆæœŸåŒ–ã—ã¾ã—ãŸ");
    });
  }

  // ========= Hydrate UI =========
  function hydrateFormUI(){
    $("month").value = state.form.month || nowMonth();
    $("role").value = state.form.role || "ã‚¨ãƒªã‚¢ãƒãƒï¼ˆç¾åœ°ï¼‰";
    $("reporter").value = state.form.reporter || "";
    $("pref").value = state.form.pref || "";
    $("base").value = state.form.base || "";
    $("memo").value = state.form.memo || "";

    $("taxRate").value = (state.form.taxRate ?? 10);
    $("salesMode").value = state.form.salesMode || "ex";
    $("outMode").value = state.form.outMode || "auto";
  }

  // ========= Init =========
  loadAll();

  // defaults if missing
  if(!state.form.month) state.form.month = nowMonth();
  if(state.form.taxRate === undefined || state.form.taxRate === null) state.form.taxRate = 10;
  if(!Array.isArray(state.form.sales)) state.form.sales = [];
  if(!Array.isArray(state.form.outs)) state.form.outs = [];

  hydrateFormUI();
  wireBaseFields();
  wireButtons();

  renderMasterLists();
  renderSales();
  renderOuts();
  renderHistory();
  recalcAll();

  // if first time, add one row each for ease
  if(state.form.sales.length===0){
    state.form.sales.push({client:"", inputAmount:""});
  }
  if(state.form.outs.length===0){
    state.form.outs.push({vendor:"", area:"", pieces:"", unit:0, inputAmount:""});
  }
  saveDraft();
  renderSales(); renderOuts(); recalcAll();

})();
</script>

</body>
</html>
