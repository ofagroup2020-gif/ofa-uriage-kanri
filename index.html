<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFA æ‹ ç‚¹åˆ¥ å£²ä¸Šãƒ»å§”è¨—ãƒ»åˆ©ç›Š æœˆæ¬¡ç®¡ç†ï¼ˆPDF/CSV/OCR/PDFï¼‰</title>

  <!-- PDF.jsï¼ˆPDFè«‹æ±‚æ›¸ãŒâ€œãƒ†ã‚­ã‚¹ãƒˆåŸ‹ã‚è¾¼ã¿â€ã®å ´åˆã«èª­ã‚ã¾ã™ï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>

  <style>
    :root{
      --bg:#fff;
      --card:#fff;
      --border:#d9d9d9;
      --text:#111;
      --muted:#666;

      --yellow:#FFD400;
      --black:#111;
      --red:#E60012;
      --green:#0FA958;
      --blue:#0066CC;

      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1380px;margin:0 auto;padding:14px 14px 120px}

    /* ===== Header ===== */
    .topbar{
      position:sticky;top:0;z-index:50;
      background:#fff;
      border-bottom:3px solid var(--black);
      padding:12px 10px;
      margin:-14px -14px 14px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:48px;height:48px;border-radius:14px;
      background:var(--yellow);
      border:3px solid var(--black);
      display:grid;place-items:center;
      font-weight:1000;color:#000;letter-spacing:.03em;
    }
    .brand h1{margin:0;font-size:18px;font-weight:1000}
    .brand .sub{margin-top:2px;color:var(--muted);font-size:12px;font-weight:800}

    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:3px solid var(--black);
      border-radius:12px;
      padding:10px 14px;
      font-weight:1000;
      cursor:pointer;
      background:#f5f5f5;
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      user-select:none;
    }
    .btn:hover{opacity:.92}
    .btn-yellow{background:var(--yellow);color:#000}
    .btn-blue{background:var(--blue);color:#fff;border-color:#003b73}
    .btn-green{background:var(--green);color:#fff;border-color:#0b6f3d}
    .btn-red{background:var(--red);color:#fff;border-color:#8f000b}

    /* ===== Tabs ===== */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px}
    .tab{
      border:2px solid var(--black);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1000;
      background:#fff;
      cursor:pointer;
    }
    .tab.active{background:var(--yellow)}
    .card{
      background:var(--card);
      border:3px solid var(--black);
      border-radius:var(--radius);
      padding:14px;
      margin-bottom:14px;
    }
    .muted{color:var(--muted);font-size:12px;font-weight:700;line-height:1.6}
    h2{margin:0 0 10px;font-size:15px;font-weight:1000}
    h3{margin:0 0 10px;font-size:13px;font-weight:1000}

    .row{display:grid;gap:10px}
    @media(min-width:980px){
      .cols2{grid-template-columns:1fr 1fr}
      .cols3{grid-template-columns:1fr 1fr 1fr}
      .cols4{grid-template-columns:1fr 1fr 1fr 1fr}
      .cols5{grid-template-columns:1fr 1fr 1fr 1fr 1fr}
      .cols6{grid-template-columns:1fr 1fr 1fr 1fr 1fr 1fr}
    }
    label{display:block;font-size:12px;font-weight:1000;margin:0 0 5px}
    input,select,textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:2px solid var(--border);
      font-size:14px;
      background:#fff;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:120px}
    input:focus,select:focus,textarea:focus{border-color:#999}
    .hr{height:2px;background:rgba(0,0,0,.12);margin:12px 0}

    /* ===== Tables ===== */
    .tableWrap{overflow:auto;border:2px solid var(--border);border-radius:14px}
    table{width:100%;border-collapse:collapse;font-size:13px;background:#fff}
    th,td{border:1px solid var(--border);padding:9px;white-space:nowrap;vertical-align:middle}
    th{background:#f2f2f2;text-align:left;font-weight:1000}
    td.right, th.right{text-align:right}
    td.center, th.center{text-align:center}

    /* ===== Numbers ===== */
    .num{font-variant-numeric:tabular-nums}
    .good{color:var(--green);font-weight:1000}
    .bad{color:var(--red);font-weight:1000}
    .blue{color:var(--blue);font-weight:1000}

    .kpiRow{display:grid;gap:10px}
    @media(min-width:980px){.kpiRow{grid-template-columns:1fr 1fr 1fr 1fr}}
    .kpi{
      border:2px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    .kpi .t{font-size:12px;color:var(--muted);font-weight:900}
    .kpi .v{margin-top:6px;font-size:18px;font-weight:1000}
    .kpi .s{margin-top:2px;font-size:12px;color:var(--muted);font-weight:800}

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      border:2px solid var(--black);
      border-radius:999px;
      padding:6px 10px;
      font-weight:1000;
      background:#fff;
      font-size:12px;
    }
    .pill-yellow{background:var(--yellow)}
    .pill-blue{background:#e8f1ff;border-color:#003b73}
    .pill-green{background:#e9fff3;border-color:#0b6f3d}
    .pill-red{background:#ffe9ec;border-color:#8f000b}

    /* ===== Print ===== */
    @media print{
      .no-print{display:none !important}
      .wrap{padding:0}
      .card{border:1px solid #000}
      .topbar{display:none}
      th{background:#efefef !important}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar no-print">
    <div class="brand">
      <div class="logo">OFA</div>
      <div>
        <h1>OFA æ‹ ç‚¹åˆ¥ å£²ä¸Šãƒ»å§”è¨—ãƒ»åˆ©ç›Š æœˆæ¬¡ç®¡ç†</h1>
        <div class="sub">æ‹ ç‚¹åˆ¥ã«å…¥åŠ› â†’ è‡ªå‹•é›†è¨ˆï¼ˆåˆ©ç›Š/åˆ©ç›Šç‡/ã‚¤ãƒ³ã‚»ãƒ³ï¼‰â†’ PDF/CSV â†’ LINEé€ä»˜é‹ç”¨OK</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-yellow" id="btnSaveDraft">ğŸ’¾ ç«¯æœ«ä¿å­˜</button>
      <button class="btn btn-blue" id="btnPDF">ğŸ–¨ï¸ PDF</button>
      <button class="btn btn-blue" id="btnCSV">â¬‡ï¸ CSV</button>
      <button class="btn btn-red" id="btnResetDraft">ğŸ§¹ å…¥åŠ›ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <div class="tabs no-print">
    <div class="tab active" data-tab="dashboard">æ‹ ç‚¹åˆ¥ä¸€è¦§ï¼ˆæœ¬éƒ¨ç¢ºèªï¼‰</div>
    <div class="tab" data-tab="input">å…¥åŠ›ï¼ˆç¾åœ°/å–¶æ¥­/FCï¼‰</div>
    <div class="tab" data-tab="master">å˜ä¾¡ãƒã‚¹ã‚¿ãƒ¼</div>
    <div class="tab" data-tab="history">å±¥æ­´</div>
    <div class="tab" data-tab="help">ä½¿ã„æ–¹</div>
  </div>

  <!-- ===================== Dashboard ===================== -->
  <section id="tab-dashboard">

    <div class="card">
      <h2>â‘  æœˆæ¬¡ãƒ•ã‚£ãƒ«ã‚¿</h2>
      <div class="row cols5">
        <div>
          <label>å¯¾è±¡æœˆ</label>
          <input type="month" id="dashMonth">
        </div>
        <div>
          <label>è¡¨ç¤ºï¼ˆéƒ½é“åºœçœŒï¼‰</label>
          <select id="dashPref">
            <option value="">ã™ã¹ã¦</option>
          </select>
        </div>
        <div>
          <label>è¡¨ç¤ºï¼ˆå…¥åŠ›è€…åŒºåˆ†ï¼‰</label>
          <select id="dashRole">
            <option value="">ã™ã¹ã¦</option>
            <option value="ã‚¨ãƒªã‚¢ãƒãƒï¼ˆç¾åœ°ï¼‰">ã‚¨ãƒªã‚¢ãƒãƒï¼ˆç¾åœ°ï¼‰</option>
            <option value="å–¶æ¥­ï¼ˆæœ¬éƒ¨/FCç®¡ç†ï¼‰">å–¶æ¥­ï¼ˆæœ¬éƒ¨/FCç®¡ç†ï¼‰</option>
            <option value="ãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚ºï¼ˆFCï¼‰">ãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚ºï¼ˆFCï¼‰</option>
          </select>
        </div>
        <div>
          <label>è¡¨ç¤ºï¼ˆæ‹ ç‚¹ï¼‰</label>
          <input id="dashBase" placeholder="éƒ¨åˆ†ä¸€è‡´ã§çµã‚Šè¾¼ã¿">
        </div>
        <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
          <button class="btn btn-green" id="btnDashPrint">ğŸ–¨ï¸ ã“ã®ä¸€è¦§ã‚’PDF</button>
          <button class="btn" id="btnDashRefresh">ğŸ”„ æ›´æ–°</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">
        â€» â€œæ›ã‘æŒã¡æ‹ ç‚¹â€ ã§ã‚‚OKï¼šåŒã˜æœˆã«è¤‡æ•°æ‹ ç‚¹ãƒ¬ãƒãƒ¼ãƒˆãŒä¸¦ã³ã€æ‹ ç‚¹åˆ¥ã®å£²ä¸Š/åˆ©ç›Š/åˆ©ç›Šç‡ãŒä¸€è¦§åŒ–ã•ã‚Œã¾ã™ã€‚
      </div>
    </div>

    <div class="card">
      <h2>â‘¡ æ‹ ç‚¹åˆ¥ é›†è¨ˆï¼ˆé»’/èµ¤/ç·‘ã§å³åˆ¤æ–­ï¼‰</h2>

      <div class="kpiRow">
        <div class="kpi">
          <div class="t">å£²ä¸Šåˆè¨ˆï¼ˆç¨æŠœï¼‰</div>
          <div class="v num" id="dashKpiSalesEx">0</div>
          <div class="s">æ‹ ç‚¹åˆç®—</div>
        </div>
        <div class="kpi">
          <div class="t">å§”è¨—åˆè¨ˆï¼ˆç¨æŠœï¼‰</div>
          <div class="v num" id="dashKpiOutEx">0</div>
          <div class="s">æ‹ ç‚¹åˆç®—</div>
        </div>
        <div class="kpi">
          <div class="t">ç²—åˆ©ï¼ˆç¨æŠœï¼‰</div>
          <div class="v num" id="dashKpiGrossEx">0</div>
          <div class="s">ãƒ—ãƒ©ã‚¹ç·‘ / ãƒã‚¤ãƒŠã‚¹èµ¤</div>
        </div>
        <div class="kpi">
          <div class="t">ç²—åˆ©ç‡</div>
          <div class="v num blue" id="dashKpiRate">0.0%</div>
          <div class="s">ç¨æŠœãƒ™ãƒ¼ã‚¹</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>å¯¾è±¡æœˆ</th>
              <th>éƒ½é“åºœçœŒ</th>
              <th>æ‹ ç‚¹å</th>
              <th>å…¥åŠ›è€…åŒºåˆ†</th>
              <th>å ±å‘Šè€…</th>
              <th>å–¶æ¥­æ‹…å½“</th>
              <th class="right">å£²ä¸Š(ç¨æŠœ)</th>
              <th class="right">å§”è¨—(ç¨æŠœ)</th>
              <th class="right">ç²—åˆ©(ç¨æŠœ)</th>
              <th class="right">ç²—åˆ©ç‡</th>
              <th class="right">æ‹ ç‚¹è²¬ä»»è€…ã‚¤ãƒ³ã‚»ãƒ³</th>
              <th class="right">å–¶æ¥­ã‚¤ãƒ³ã‚»ãƒ³</th>
              <th class="center no-print">ç·¨é›†</th>
            </tr>
          </thead>
          <tbody id="dashTbody"></tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:8px">
        â€» â€œç·¨é›†â€ ã§è©²å½“æ‹ ç‚¹ã‚’å‘¼ã³å‡ºã— â†’ ä¿®æ­£ â†’ PDF/CSV â†’ LINEé€ä»˜ã€‚
      </div>
    </div>

  </section>

  <!-- ===================== Input ===================== -->
  <section id="tab-input" style="display:none">

    <div class="card">
      <h2>â‘  æ‹ ç‚¹ãƒ¬ãƒãƒ¼ãƒˆã‚’é¸æŠï¼ˆæ›ã‘æŒã¡å¯¾å¿œï¼‰</h2>
      <div class="row cols4">
        <div>
          <label>ç¾åœ¨ã®æ‹ ç‚¹ãƒ¬ãƒãƒ¼ãƒˆ</label>
          <select id="reportSelect"></select>
        </div>
        <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
          <button class="btn btn-yellow no-print" id="btnAddReport">ï¼‹ æ‹ ç‚¹ãƒ¬ãƒãƒ¼ãƒˆè¿½åŠ </button>
          <button class="btn btn-red no-print" id="btnDeleteReport">ğŸ—‘ï¸ ã“ã®æ‹ ç‚¹ã‚’å‰Šé™¤</button>
        </div>
        <div>
          <label>å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</label>
          <select id="uiMode">
            <option value="normal">é€šå¸¸ï¼ˆå£²ä¸Š+å§”è¨—+å˜ä¾¡/å€‹æ•°ï¼‰</option>
            <option value="simple">è¶…ç°¡å˜ï¼ˆå£²ä¸Šã¨è«‹æ±‚é‡‘é¡ã ã‘ï¼‰</option>
          </select>
        </div>
        <div class="muted">
          è¶…ç°¡å˜ãƒ¢ãƒ¼ãƒ‰ã¯ã€<b>è¨ˆç®—ã§ããªã„æ‹…å½“ã§ã‚‚è¿·ã‚ãªã„</b>ä»•æ§˜ã€‚<br>
          ï¼ˆå˜ä¾¡/å€‹æ•°ã¯çœç•¥ã—ã€é‡‘é¡å…¥åŠ›ã«å¯„ã›ã¾ã™ï¼‰
        </div>
      </div>
    </div>

    <div class="card">
      <h2>â‘¡ åŸºæœ¬æƒ…å ±ï¼ˆè¨ˆç®—ä¸è¦ï¼‰</h2>
      <div class="row cols6">
        <div>
          <label>å¯¾è±¡æœˆ</label>
          <input type="month" id="month">
        </div>
        <div>
          <label>å…¥åŠ›è€…åŒºåˆ†</label>
          <select id="role">
            <option value="ã‚¨ãƒªã‚¢ãƒãƒï¼ˆç¾åœ°ï¼‰">ã‚¨ãƒªã‚¢ãƒãƒï¼ˆç¾åœ°ï¼‰</option>
            <option value="å–¶æ¥­ï¼ˆæœ¬éƒ¨/FCç®¡ç†ï¼‰">å–¶æ¥­ï¼ˆæœ¬éƒ¨/FCç®¡ç†ï¼‰</option>
            <option value="ãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚ºï¼ˆFCï¼‰">ãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚ºï¼ˆFCï¼‰</option>
          </select>
        </div>
        <div>
          <label>å ±å‘Šè€…ï¼ˆæ‹ ç‚¹è²¬ä»»è€…ï¼‰</label>
          <input id="reporter" placeholder="ä¾‹ï¼šæ£®ä¸‹ / â—‹â—‹FCåº—">
        </div>
        <div>
          <label>å–¶æ¥­æ‹…å½“ï¼ˆæœ¬éƒ¨/FCç®¡ç†ï¼‰</label>
          <input id="salesRep" placeholder="ä¾‹ï¼šæœ¬éƒ¨ å¤ªç”° / â—‹â—‹å–¶æ¥­">
        </div>
        <div>
          <label>éƒ½é“åºœçœŒ</label>
          <select id="pref">
            <option value="">é¸æŠ</option>
          </select>
          <div class="muted">â€»ã€Œã‚¨ãƒªã‚¢å¤–/æœ¬éƒ¨å–¶æ¥­ã€ã‚‚é¸ã¹ã¾ã™</div>
        </div>
        <div>
          <label>æ‹ ç‚¹å</label>
          <input id="base" placeholder="ä¾‹ï¼šç¦å²¡å¸‚å†… / æ±äº¬ï¼ˆè¶³ç«‹ï¼‰">
        </div>
      </div>

      <div class="hr"></div>

      <div class="row cols4">
        <div>
          <label>ç›®æ¨™ï¼ˆä»»æ„ï¼‰</label>
          <input id="goal" placeholder="ä¾‹ï¼šç²—åˆ©ç‡15% / æœˆç²—åˆ©100ä¸‡">
          <div class="muted">â€»ãŸã ã‚„ã‚‰ã›ã‚‹å…¥åŠ›ã§ã¯ãªãã€<b>ç›®æ¨™é”æˆã®ãŸã‚ã®æ•°å­—ç®¡ç†</b>ã«ã€‚</div>
        </div>
        <div>
          <label>æ¶ˆè²»ç¨ç‡ï¼ˆ%ï¼‰</label>
          <input id="taxRate" inputmode="decimal" placeholder="ä¾‹ï¼š10">
        </div>
        <div>
          <label>å£²ä¸Š é‡‘é¡å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</label>
          <select id="salesMode">
            <option value="ex">ç¨æŠœã§å…¥åŠ›</option>
            <option value="in">ç¨è¾¼ã§å…¥åŠ›</option>
          </select>
        </div>
        <div>
          <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <input id="memo" placeholder="ä¾‹ï¼šå¢—å“¡/ç¹å¿™/å‰å¹´å·®è¦å› ãªã©">
        </div>
      </div>
    </div>

    <div class="card">
      <h2>â‘¢ ã‚¤ãƒ³ã‚»ãƒ³è¨­å®šï¼ˆ0.3%ï¼‰</h2>
      <div class="muted">æ‹ ç‚¹è²¬ä»»è€…ï¼ˆå ±å‘Šè€…ï¼‰ã¨å–¶æ¥­æ‹…å½“ã¯åˆ¥ã€‚è¨ˆç®—ã¯è‡ªå‹•ã§ã™ã€‚</div>

      <div class="row cols4" style="margin-top:10px">
        <div>
          <label>æ‹ ç‚¹è²¬ä»»è€…ã‚¤ãƒ³ã‚»ãƒ³ï¼ˆ%ï¼‰</label>
          <input id="mgrPct" inputmode="decimal" placeholder="0.3">
        </div>
        <div>
          <label>å–¶æ¥­ã‚¤ãƒ³ã‚»ãƒ³ï¼ˆ%ï¼‰</label>
          <input id="salesPct" inputmode="decimal" placeholder="0.3">
        </div>
        <div>
          <label>ã‚¤ãƒ³ã‚»ãƒ³è¨ˆç®—ãƒ™ãƒ¼ã‚¹</label>
          <select id="incBase">
            <option value="gross">åˆ©ç›Šï¼ˆç²—åˆ©ï¼‰ãƒ™ãƒ¼ã‚¹</option>
            <option value="sales">å£²ä¸Šãƒ™ãƒ¼ã‚¹</option>
          </select>
          <div class="muted">â€»è¦æœ›ã®ã€Œåˆ©ç›Šãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ã€å¯¾å¿œ</div>
        </div>
        <div>
          <label>ä¸Šé™/ä¸‹é™ï¼ˆä»»æ„ï¼‰</label>
          <div class="row cols2">
            <div>
              <input id="incMin" inputmode="decimal" placeholder="ä¸‹é™(å††) ä¾‹ï¼š0">
            </div>
            <div>
              <input id="incMax" inputmode="decimal" placeholder="ä¸Šé™(å††) ä¾‹ï¼š50000">
            </div>
          </div>
          <div class="muted">â€»0ãªã‚‰å®Ÿè³ªç„¡åˆ¶é™</div>
        </div>
      </div>
    </div>

    <div class="card" id="card-sales">
      <h2>â‘£ å£²ä¸Šå…¥åŠ›ï¼ˆå–å¼•å…ˆ Ã— é‡‘é¡ï¼‰</h2>
      <div class="muted">
        å–å¼•å…ˆã¯ãƒã‚¹ã‚¿ãƒ¼ç™»éŒ² â†’ ã“ã“ã§ã¯<b>é¸ã¶ã ã‘</b>ã€‚é‡‘é¡ã¯ç¨æŠœ/ç¨è¾¼ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦å…¥åŠ›ã€‚
      </div>

      <div style="margin-top:10px" class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:220px">å–å¼•å…ˆï¼ˆç™ºæ³¨/è·ä¸»ï¼‰</th>
              <th class="right">å…¥åŠ›é‡‘é¡</th>
              <th class="right">ç¨æŠœ</th>
              <th class="right">ç¨è¾¼</th>
              <th class="center">å‰Šé™¤</th>
            </tr>
          </thead>
          <tbody id="salesTbody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap" class="no-print">
        <button class="btn btn-yellow" id="btnAddSale">ï¼‹ å£²ä¸Šè¡Œã‚’è¿½åŠ ï¼ˆç„¡é™ï¼‰</button>
      </div>
    </div>

    <div class="card" id="card-outs">
      <h2>â‘¤ å§”è¨—å…¥åŠ›ï¼ˆå§”è¨—ä¼šç¤¾ Ã— åœ°åŸŸ Ã— å€‹æ•°/è«‹æ±‚é‡‘é¡ï¼‰</h2>

      <div class="muted">
        é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼š<b>è·ç‰©å€‹æ•°</b>ã‚’å…¥ã‚Œã‚‹ã¨ <b>å˜ä¾¡ãƒã‚¹ã‚¿ãƒ¼</b> ã‚’èª­ã‚“ã§è‡ªå‹•è¨ˆç®—ï¼ˆå€‹å»º/å‡ºæ¥é«˜å‘ã‘ï¼‰ã€‚<br>
        è¶…ç°¡å˜ãƒ¢ãƒ¼ãƒ‰ï¼š<b>è«‹æ±‚é‡‘é¡ã ã‘</b>å…¥ã‚Œã‚Œã°OKï¼ˆè¨ˆç®—ä¸è¦ã®äººå‘ã‘ï¼‰ã€‚
      </div>

      <div style="margin-top:10px" class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:220px">å§”è¨—ä¼šç¤¾</th>
              <th style="min-width:180px">æ‹…å½“åœ°åŸŸ</th>
              <th class="right col-pieces">è·ç‰©å€‹æ•°</th>
              <th class="right col-unit">å˜ä¾¡ï¼ˆç¨æŠœï¼‰</th>
              <th class="right">è«‹æ±‚é‡‘é¡ï¼ˆå…¥åŠ›/è‡ªå‹•ï¼‰</th>
              <th class="right">ç¨æŠœ</th>
              <th class="right">ç¨è¾¼</th>
              <th class="center">å‰Šé™¤</th>
            </tr>
          </thead>
          <tbody id="outTbody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap" class="no-print">
        <button class="btn btn-yellow" id="btnAddOut">ï¼‹ å§”è¨—è¡Œã‚’è¿½åŠ ï¼ˆç„¡é™ï¼‰</button>
      </div>
    </div>

    <div class="card no-print">
      <h2>â‘¥ è«‹æ±‚æ›¸èª­ã¿è¾¼ã¿ï¼ˆâ‘ OCRè²¼ä»˜ / â‘¡PDFèª­è¾¼ï¼‰</h2>
      <div class="muted">
        âœ… â‘  ã‚¹ãƒãƒ›ã§è«‹æ±‚æ›¸ã‚’æ’®å½± â†’ æ–‡å­—èªè­˜ï¼ˆOCRï¼‰â†’ ã‚³ãƒ”ãƒ¼ â†’ è²¼ã‚Šä»˜ã‘ â†’ è‡ªå‹•ã§è¡Œè¿½åŠ <br>
        âœ… â‘¡ PDFè«‹æ±‚æ›¸ï¼ˆãƒ†ã‚­ã‚¹ãƒˆåŸ‹ã‚è¾¼ã¿ï¼‰â†’ è‡ªå‹•ã§æ–‡å­—æŠ½å‡º â†’ â‘ ã«æµã—è¾¼ã¿ â†’ è‡ªå‹•è¿½åŠ <br>
        â€»ç”»åƒã ã‘ã®PDFï¼ˆã‚¹ã‚­ãƒ£ãƒ³ï¼‰ã¯â‘¡ã§èª­ã‚ã¾ã›ã‚“ â†’ â‘ ã§å¯¾å¿œ
      </div>

      <div class="hr"></div>

      <div class="row cols2">
        <div>
          <label>è²¼ã‚Šä»˜ã‘æ¬„ï¼ˆOCRãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
          <textarea id="invoiceText" placeholder="ã“ã“ã«è²¼ã‚Šä»˜ã‘"></textarea>
          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-yellow" id="btnParseInvoiceText">ğŸ” è§£æã—ã¦è¿½åŠ </button>
            <button class="btn" id="btnClearInvoiceText">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
          </div>
          <div class="muted" style="margin-top:8px">
            ãƒ’ãƒ³ãƒˆï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ â€œæ”¯æ‰•/å§”è¨—/è«‹æ±‚/ç²¾ç®—â€ ãŒå¤šã„ã¨ã€Œå§”è¨—ã€åˆ¤å®šã«ãªã‚Šã‚„ã™ã„ã§ã™ã€‚
          </div>
        </div>

        <div>
          <label>PDFã‚’é¸æŠï¼ˆãƒ†ã‚­ã‚¹ãƒˆåŸ‹ã‚è¾¼ã¿è«‹æ±‚æ›¸ï¼‰</label>
          <input type="file" id="pdfFile" accept="application/pdf">
          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-blue" id="btnParsePDF">ğŸ“„ PDFã‚’è§£æã—ã¦è¿½åŠ </button>
          </div>

          <div class="hr"></div>

          <label>è§£æãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå…ˆé ­20ä»¶ï¼‰</label>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>åˆ¤å®š</th>
                  <th>å–å¼•å…ˆå€™è£œ</th>
                  <th class="right">é‡‘é¡å€™è£œ</th>
                  <th class="right">å€‹æ•°å€™è£œ</th>
                </tr>
              </thead>
              <tbody id="invoicePreviewTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>â‘¦ é›†è¨ˆï¼ˆæ‹ ç‚¹å˜ä½ï¼‰</h2>

      <div class="kpiRow">
        <div class="kpi">
          <div class="t">å£²ä¸Šåˆè¨ˆ</div>
          <div class="v num" id="kpiSales">0</div>
          <div class="s">ç¨æŠœ/ç¨è¾¼</div>
        </div>
        <div class="kpi">
          <div class="t">å§”è¨—åˆè¨ˆ</div>
          <div class="v num" id="kpiOut">0</div>
          <div class="s">ç¨æŠœ/ç¨è¾¼</div>
        </div>
        <div class="kpi">
          <div class="t">ç²—åˆ©ï¼ˆ= å£²ä¸Š âˆ’ å§”è¨—ï¼‰</div>
          <div class="v num" id="kpiGross">0</div>
          <div class="s">ãƒ—ãƒ©ã‚¹ç·‘ / ãƒã‚¤ãƒŠã‚¹èµ¤</div>
        </div>
        <div class="kpi">
          <div class="t">ç²—åˆ©ç‡</div>
          <div class="v num blue" id="kpiRate">0.0%</div>
          <div class="s">ç¨æŠœãƒ™ãƒ¼ã‚¹</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row cols3">
        <div class="kpi">
          <div class="t">æ‹ ç‚¹è²¬ä»»è€…ã‚¤ãƒ³ã‚»ãƒ³</div>
          <div class="v num" id="kpiMgrInc">0</div>
          <div class="s">0.3%ï¼ˆè¨­å®šå¯ï¼‰</div>
        </div>
        <div class="kpi">
          <div class="t">å–¶æ¥­ã‚¤ãƒ³ã‚»ãƒ³</div>
          <div class="v num" id="kpiSalesInc">0</div>
          <div class="s">0.3%ï¼ˆè¨­å®šå¯ï¼‰</div>
        </div>
        <div class="kpi">
          <div class="t">ç•°å¸¸å€¤ã‚¢ãƒ©ãƒ¼ãƒˆ</div>
          <div class="v" id="kpiAlert">
            <span class="pill pill-green">OK</span>
          </div>
          <div class="s">ç²—åˆ©ç‡ãŒé–¾å€¤ä»¥ä¸‹ã§èµ¤</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row cols4 no-print">
        <div>
          <label>ã‚¢ãƒ©ãƒ¼ãƒˆé–¾å€¤ï¼ˆç²—åˆ©ç‡% ä»¥ä¸‹ã§èµ¤ï¼‰</label>
          <input id="alertRate" inputmode="decimal" placeholder="ä¾‹ï¼š5">
          <div class="muted">ä¾‹ï¼š5 ã‚’å…¥ã‚Œã‚‹ã¨ç²—åˆ©ç‡ 5% ä»¥ä¸‹ã¯èµ¤è¡¨ç¤º</div>
        </div>
        <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
          <button class="btn btn-green" id="btnSaveHistory">ğŸ“Œ ã“ã®æ‹ ç‚¹ã‚’å±¥æ­´ä¿å­˜</button>
          <button class="btn btn-blue" id="btnGoDash">ğŸ¢ æœ¬éƒ¨ä¸€è¦§ã¸åæ˜ </button>
        </div>
        <div class="muted" style="grid-column: span 2;">
          ä¿å­˜â†’PDF/CSVå‡ºåŠ›â†’LINEé€ä»˜ã®é‹ç”¨ã§OKï¼ˆæœ¬éƒ¨ã¸â€œé£›ã°ã•ãªã„â€é‹ç”¨ã«åˆã‚ã›ã¦ã„ã¾ã™ï¼‰ã€‚
        </div>
      </div>
    </div>

  </section>

  <!-- ===================== Master ===================== -->
  <section id="tab-master" style="display:none">
    <div class="card">
      <h2>å˜ä¾¡ãƒã‚¹ã‚¿ãƒ¼ï¼ˆé¸ã¶ã ã‘é‹ç”¨ï¼‰</h2>
      <div class="muted">
        ã“ã“ã§ç™»éŒ²ã—ãŸå†…å®¹ãŒã€Œå…¥åŠ›ã€ã§<b>é¸ã¶ã ã‘</b>ã«ãªã‚Šã¾ã™ã€‚<br>
        ãƒ»å–å¼•å…ˆï¼ˆå£²ä¸Šï¼‰<br>
        ãƒ»å§”è¨—ä¼šç¤¾ï¼ˆè«‹æ±‚ï¼‰<br>
        ãƒ»æ‹…å½“åœ°åŸŸï¼ˆã‚¨ãƒªã‚¢ï¼‰<br>
        ãƒ»å˜ä¾¡ãƒã‚¹ã‚¿ãƒ¼ï¼ˆå§”è¨—ä¼šç¤¾Ã—æ‹…å½“åœ°åŸŸâ†’å˜ä¾¡ ç¨æŠœï¼‰
      </div>

      <div class="hr"></div>

      <div class="row cols3">
        <div>
          <h3>â‘  å–å¼•å…ˆï¼ˆå£²ä¸Šï¼‰</h3>
          <div style="display:flex;gap:8px">
            <input id="newClient" placeholder="ä¾‹ï¼šAmazon / ãƒ¤ãƒãƒˆ / ä½å· / SHEIN">
            <button class="btn btn-yellow" id="btnAddClient">è¿½åŠ </button>
          </div>
          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead><tr><th>å–å¼•å…ˆå</th><th class="center">å‰Šé™¤</th></tr></thead>
              <tbody id="clientTbody"></tbody>
            </table>
          </div>
        </div>

        <div>
          <h3>â‘¡ å§”è¨—ä¼šç¤¾ï¼ˆè«‹æ±‚ï¼‰</h3>
          <div style="display:flex;gap:8px">
            <input id="newVendor" placeholder="ä¾‹ï¼šDARUMA / ãƒ–ãƒ«ãƒ¼ãƒŸãƒ¼ / Lifes">
            <button class="btn btn-yellow" id="btnAddVendor">è¿½åŠ </button>
          </div>
          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead><tr><th>å§”è¨—ä¼šç¤¾</th><th class="center">å‰Šé™¤</th></tr></thead>
              <tbody id="vendorTbody"></tbody>
            </table>
          </div>
        </div>

        <div>
          <h3>â‘¢ æ‹…å½“åœ°åŸŸ</h3>
          <div style="display:flex;gap:8px">
            <input id="newArea" placeholder="ä¾‹ï¼šç¦å²¡å¸‚å†… / æ±äº¬ï¼ˆè¶³ç«‹ï¼‰ / é¹¿å…å³¶">
            <button class="btn btn-yellow" id="btnAddArea">è¿½åŠ </button>
          </div>
          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead><tr><th>æ‹…å½“åœ°åŸŸ</th><th class="center">å‰Šé™¤</th></tr></thead>
              <tbody id="areaTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <h3>â‘£ å˜ä¾¡ãƒã‚¹ã‚¿ãƒ¼ï¼ˆå§”è¨—ä¼šç¤¾ Ã— æ‹…å½“åœ°åŸŸ â†’ å˜ä¾¡ï¼‰</h3>
      <div class="muted">â€»å˜ä¾¡ã¯ <b>ç¨æŠœ</b> ã§ç™»éŒ²ï¼ˆæ¶ˆè²»ç¨ã¯å…¥åŠ›å´ã§è¨ˆç®—ï¼‰ã€‚å€‹å»º/å‡ºæ¥é«˜ã®è‡ªå‹•è¨ˆç®—ã«ä½¿ç”¨ã€‚</div>

      <div style="margin-top:10px" class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:220px">å§”è¨—ä¼šç¤¾</th>
              <th style="min-width:180px">æ‹…å½“åœ°åŸŸ</th>
              <th class="right">å˜ä¾¡ï¼ˆç¨æŠœï¼‰</th>
              <th class="center">å‰Šé™¤</th>
            </tr>
          </thead>
          <tbody id="priceTbody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap" class="no-print">
        <button class="btn btn-yellow" id="btnAddPrice">ï¼‹ å˜ä¾¡è¡Œã‚’è¿½åŠ ï¼ˆç„¡é™ï¼‰</button>
      </div>

      <div class="hr"></div>
      <div class="no-print" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn btn-green" id="btnSaveMaster">ğŸ’¾ ãƒã‚¹ã‚¿ãƒ¼ä¿å­˜</button>
        <button class="btn btn-red" id="btnResetMaster">ğŸ§¨ ãƒã‚¹ã‚¿ãƒ¼åˆæœŸåŒ–</button>
        <span class="muted">â€»ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ä¿å­˜ã€‚å…¨å“¡ã«é…ã‚‹å ´åˆã¯CSVã§å…±æœ‰é‹ç”¨ãŒç¾å®Ÿçš„ã§ã™ã€‚</span>
      </div>
    </div>
  </section>

  <!-- ===================== History ===================== -->
  <section id="tab-history" style="display:none">
    <div class="card">
      <h2>å±¥æ­´ï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰</h2>
      <div class="muted">
        ä¿å­˜ã—ãŸæ‹ ç‚¹ãƒ¬ãƒãƒ¼ãƒˆã‚’å‘¼ã³å‡ºã—ã¦ç·¨é›† â†’ PDF/CSV â†’ LINEé€ä»˜ã§ãã¾ã™ã€‚<br>
        â€»ã€Œæœˆæ¬¡ã€ã€Œæ‹ ç‚¹åˆ¥ã€é‹ç”¨ã«æœ€é©åŒ–ã€‚
      </div>

      <div class="hr"></div>

      <div class="row cols4">
        <div>
          <label>ä¿å­˜æ¸ˆã¿ä¸€è¦§</label>
          <select id="historySelect"></select>
        </div>
        <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap" class="no-print">
          <button class="btn btn-yellow" id="btnLoadHistory">å‘¼ã³å‡ºã—</button>
          <button class="btn btn-red" id="btnDeleteHistory">å‰Šé™¤</button>
        </div>
        <div class="muted" style="grid-column: span 2;">
          âœ… ä¿®æ­£ã—ãŸã„ã¨ãï¼šå±¥æ­´â†’å‘¼ã³å‡ºã—â†’ç›´ã™â†’PDF/CSV
        </div>
      </div>
    </div>
  </section>

  <!-- ===================== Help ===================== -->
  <section id="tab-help" style="display:none">
    <div class="card">
      <h2>ä½¿ã„æ–¹ï¼ˆæœ€çŸ­ï¼‰</h2>
      <ol class="muted">
        <li><b>å˜ä¾¡ãƒã‚¹ã‚¿ãƒ¼</b>ã§ã€Œå–å¼•å…ˆ / å§”è¨—ä¼šç¤¾ / åœ°åŸŸ / å˜ä¾¡ã€ã‚’ç™»éŒ²</li>
        <li><b>å…¥åŠ›</b>ã§ã€Œå¯¾è±¡æœˆãƒ»éƒ½é“åºœçœŒãƒ»æ‹ ç‚¹åãƒ»å ±å‘Šè€…ãƒ»å–¶æ¥­æ‹…å½“ã€ã‚’å…¥åŠ›</li>
        <li>å£²ä¸Šï¼ˆå–å¼•å…ˆÃ—é‡‘é¡ï¼‰ã¨å§”è¨—ï¼ˆå§”è¨—ä¼šç¤¾Ã—åœ°åŸŸÃ—å€‹æ•°/è«‹æ±‚ï¼‰ã‚’å…¥åŠ›ï¼ˆè¡Œã¯ç„¡é™ã«è¿½åŠ ï¼‰</li>
        <li>é›†è¨ˆï¼ˆå£²ä¸Š/å§”è¨—/ç²—åˆ©/ç²—åˆ©ç‡/ã‚¤ãƒ³ã‚»ãƒ³/ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰ã‚’ç¢ºèª</li>
        <li><b>PDF</b>ã§å°åˆ·â†’LINEã§é€ä»˜ã€ã¾ãŸã¯<b>CSV</b>ã§é€ä»˜</li>
        <li>æ›ã‘æŒã¡æ‹ ç‚¹ã¯ã€Œæ‹ ç‚¹ãƒ¬ãƒãƒ¼ãƒˆè¿½åŠ ã€ã§è¤‡æ•°æ‹ ç‚¹ã‚’ä½œã‚Šã€æœ€å¾Œã«<b>æ‹ ç‚¹åˆ¥ä¸€è¦§</b>ã§æœ¬éƒ¨ç¢ºèª</li>
      </ol>
      <div class="muted">
        â€»è«‹æ±‚æ›¸è‡ªå‹•å…¥åŠ›ï¼šã‚¹ãƒãƒ›OCRã§æ–‡å­—ã‚³ãƒ”ãƒ¼â†’ã€ŒOCRè²¼ä»˜ã€â†’è§£æã§è¡Œè¿½åŠ ã€‚PDFã¯â€œãƒ†ã‚­ã‚¹ãƒˆåŸ‹ã‚è¾¼ã¿â€ã®ã¿å¯¾å¿œã€‚
      </div>
    </div>
  </section>

</div>

<script>
(() => {
  // ========= Storage Keys =========
  const LS_MASTER = "ofa_sales_master_v3";
  const LS_DRAFT  = "ofa_sales_draft_v3";
  const LS_HIST   = "ofa_sales_history_v3";

  // ========= Utilities =========
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const num = (v)=> {
    const s = String(v??"").replace(/[^\d.-]/g,"");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };
  const yen = (n)=> (Number(n)||0).toLocaleString("ja-JP");
  const pct = (v)=> (v*100).toFixed(1) + "%";
  const clamp = (x, min, max)=> Math.min(Math.max(x, min), max);

  function nowMonth(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,7);
  }

  const PREFS = [
    "åŒ—æµ·é“","é’æ£®","å²©æ‰‹","å®®åŸ","ç§‹ç”°","å±±å½¢","ç¦å³¶",
    "èŒ¨åŸ","æ ƒæœ¨","ç¾¤é¦¬","åŸ¼ç‰","åƒè‘‰","æ±äº¬","ç¥å¥ˆå·",
    "æ–°æ½Ÿ","å¯Œå±±","çŸ³å·","ç¦äº•","å±±æ¢¨","é•·é‡",
    "å²é˜œ","é™å²¡","æ„›çŸ¥","ä¸‰é‡",
    "æ»‹è³€","äº¬éƒ½","å¤§é˜ª","å…µåº«","å¥ˆè‰¯","å’Œæ­Œå±±",
    "é³¥å–","å³¶æ ¹","å²¡å±±","åºƒå³¶","å±±å£",
    "å¾³å³¶","é¦™å·","æ„›åª›","é«˜çŸ¥",
    "ç¦å²¡","ä½è³€","é•·å´","ç†Šæœ¬","å¤§åˆ†","å®®å´","é¹¿å…å³¶","æ²–ç¸„",
    "ã‚¨ãƒªã‚¢å¤–/æœ¬éƒ¨å–¶æ¥­"
  ];

  // ========= State =========
  const state = {
    master: {
      clients: ["Amazon","ãƒ¤ãƒãƒˆ","ä½å·","SHEIN","ãƒ•ã‚§ãƒªã‚·ãƒ¢"],
      vendors: ["DARUMA","ãƒ–ãƒ«ãƒ¼ãƒŸãƒ¼","Lifes"],
      areas: ["ç¦å²¡å¸‚å†…","æ±äº¬ï¼ˆè¶³ç«‹ï¼‰","é¹¿å…å³¶"],
      prices: [
        {vendor:"DARUMA", area:"ç¦å²¡å¸‚å†…", unit:200},
        {vendor:"ãƒ–ãƒ«ãƒ¼ãƒŸãƒ¼", area:"æ±äº¬ï¼ˆè¶³ç«‹ï¼‰", unit:170},
      ],
    },
    draft: {
      uiMode: "normal",
      currentReportId: "",
      reports: [
        // {id, month, role, reporter, salesRep, pref, base, goal, memo, taxRate, salesMode, mgrPct, salesPct, incBase, incMin, incMax, alertRate, sales[], outs[]}
      ]
    },
    history: [] // {id, savedAt, snapshotReport}
  };

  function uid(){
    return (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));
  }

  function defaultReport(){
    return {
      id: uid(),
      month: nowMonth(),
      role: "ã‚¨ãƒªã‚¢ãƒãƒï¼ˆç¾åœ°ï¼‰",
      reporter: "",
      salesRep: "",
      pref: "",
      base: "",
      goal: "",
      memo: "",
      taxRate: 10,
      salesMode: "ex", // ex/in
      mgrPct: 0.3,
      salesPct: 0.3,
      incBase: "gross", // gross/sales
      incMin: 0,
      incMax: 0,
      alertRate: 5, // %
      sales: [{client:"", inputAmount:""}],
      outs: [{vendor:"", area:"", pieces:"", unit:0, inputAmount:""}]
    };
  }

  function getCurrentReport(){
    const id = state.draft.currentReportId;
    return state.draft.reports.find(r=>r.id===id) || null;
  }

  // ========= Load/Save =========
  function loadAll(){
    try{
      const m = localStorage.getItem(LS_MASTER);
      if(m) state.master = JSON.parse(m);
    }catch(e){}
    try{
      const d = localStorage.getItem(LS_DRAFT);
      if(d) state.draft = JSON.parse(d);
    }catch(e){}
    try{
      const h = localStorage.getItem(LS_HIST);
      if(h) state.history = JSON.parse(h);
    }catch(e){}
  }
  function saveMaster(){ localStorage.setItem(LS_MASTER, JSON.stringify(state.master)); }
  function saveDraft(){ localStorage.setItem(LS_DRAFT, JSON.stringify(state.draft)); }
  function saveHistory(){ localStorage.setItem(LS_HIST, JSON.stringify(state.history)); }

  // ========= Tabs =========
  function setTab(name){
    ["dashboard","input","master","history","help"].forEach(t=>{
      $("tab-"+t).style.display = (t===name) ? "" : "none";
    });
    document.querySelectorAll(".tab").forEach(el=>{
      el.classList.toggle("active", el.dataset.tab===name);
    });
  }
  document.querySelectorAll(".tab").forEach(el=>{
    el.addEventListener("click", ()=>setTab(el.dataset.tab));
  });

  // ========= Master Lookups =========
  function getUnitPrice(vendor, area){
    const hit = (state.master.prices||[]).find(p=>p.vendor===vendor && p.area===area);
    return hit ? Number(hit.unit||0) : 0;
  }

  // ========= Pref Select Build =========
  function buildPrefSelect(sel){
    sel.innerHTML = `<option value="">é¸æŠ</option>` + PREFS.map(p=>`<option value="${esc(p)}">${esc(p)}</option>`).join("");
  }

  // ========= Render Report Select =========
  function renderReportSelect(){
    const sel = $("reportSelect");
    sel.innerHTML = "";
    if(!state.draft.reports.length){
      state.draft.reports.push(defaultReport());
    }
    if(!state.draft.currentReportId){
      state.draft.currentReportId = state.draft.reports[0].id;
    }
    state.draft.reports.forEach(r=>{
      const label = `${r.month||"æœªè¨­å®š"} / ${r.pref||"æœªè¨­å®š"} ${r.base||""} / å ±å‘Š:${r.reporter||""}`;
      const op = document.createElement("option");
      op.value = r.id;
      op.textContent = label;
      sel.appendChild(op);
    });
    sel.value = state.draft.currentReportId;
  }

  // ========= Hydrate UI from report =========
  function hydrateUI(){
    const r = getCurrentReport();
    if(!r) return;

    $("uiMode").value = state.draft.uiMode || "normal";

    $("month").value = r.month || nowMonth();
    $("role").value = r.role || "ã‚¨ãƒªã‚¢ãƒãƒï¼ˆç¾åœ°ï¼‰";
    $("reporter").value = r.reporter || "";
    $("salesRep").value = r.salesRep || "";
    $("pref").value = r.pref || "";
    $("base").value = r.base || "";
    $("goal").value = r.goal || "";
    $("memo").value = r.memo || "";
    $("taxRate").value = (r.taxRate ?? 10);
    $("salesMode").value = r.salesMode || "ex";

    $("mgrPct").value = (r.mgrPct ?? 0.3);
    $("salesPct").value = (r.salesPct ?? 0.3);
    $("incBase").value = r.incBase || "gross";
    $("incMin").value = (r.incMin ?? 0);
    $("incMax").value = (r.incMax ?? 0);
    $("alertRate").value = (r.alertRate ?? 5);

    if(!Array.isArray(r.sales)) r.sales = [{client:"", inputAmount:""}];
    if(!Array.isArray(r.outs)) r.outs = [{vendor:"", area:"", pieces:"", unit:0, inputAmount:""}];

    applyUIMode();
    renderSales();
    renderOuts();
    recalcCurrent();
    saveDraft();
  }

  function applyUIMode(){
    const mode = state.draft.uiMode || "normal";
    const piecesCols = document.querySelectorAll(".col-pieces");
    const unitCols = document.querySelectorAll(".col-unit");
    if(mode==="simple"){
      piecesCols.forEach(el=>el.style.display="none");
      unitCols.forEach(el=>el.style.display="none");
    }else{
      piecesCols.forEach(el=>el.style.display="");
      unitCols.forEach(el=>el.style.display="");
    }
  }

  // ========= Sales Render =========
  function renderSales(){
    const r = getCurrentReport(); if(!r) return;
    const tb = $("salesTbody");
    const opts = state.master.clients.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");

    const tax = num(r.taxRate)/100;
    tb.innerHTML = r.sales.map((row,idx)=>{
      const inputAmount = num(row.inputAmount);
      const ex = r.salesMode==="ex" ? inputAmount : (tax ? inputAmount/(1+tax) : inputAmount);
      const inc = r.salesMode==="in" ? inputAmount : ex*(1+tax);
      return `
        <tr>
          <td>
            <select data-s-k="client" data-i="${idx}">
              <option value="">é¸æŠ</option>
              ${opts}
            </select>
          </td>
          <td class="right">
            <input class="num" data-s-k="inputAmount" data-i="${idx}" inputmode="decimal" placeholder="é‡‘é¡" value="${row.inputAmount??""}">
          </td>
          <td class="right num">${yen(Math.round(ex))}</td>
          <td class="right num">${yen(Math.round(inc))}</td>
          <td class="center"><button class="btn btn-red" data-del-sale="${idx}">Ã—</button></td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll('select[data-s-k="client"]').forEach(sel=>{
      const i = Number(sel.dataset.i);
      sel.value = r.sales[i].client || "";
      sel.addEventListener("change", ()=>{
        r.sales[i].client = sel.value;
        saveDraft(); recalcCurrent(); renderDashboard();
      });
    });
    tb.querySelectorAll('input[data-s-k="inputAmount"]').forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=>{
        r.sales[i].inputAmount = inp.value;
        saveDraft(); recalcCurrent(); renderDashboard();
      });
      inp.addEventListener("blur", ()=>{
        const v = num(inp.value);
        inp.value = v ? String(v) : "";
        r.sales[i].inputAmount = inp.value;
        saveDraft(); recalcCurrent(); renderDashboard();
      });
    });
    tb.querySelectorAll('button[data-del-sale]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delSale);
        r.sales.splice(i,1);
        if(!r.sales.length) r.sales.push({client:"", inputAmount:""});
        saveDraft(); renderSales(); recalcCurrent(); renderDashboard();
      });
    });
  }

  // ========= Outs Render =========
  function renderOuts(){
    const r = getCurrentReport(); if(!r) return;
    const tb = $("outTbody");
    const vOpts = state.master.vendors.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
    const aOpts = state.master.areas.map(a=>`<option value="${esc(a)}">${esc(a)}</option>`).join("");

    const tax = num(r.taxRate)/100;
    const uiMode = state.draft.uiMode || "normal";

    tb.innerHTML = r.outs.map((row,idx)=>{
      const pieces = num(row.pieces);
      const unit = num(row.unit);
      const autoEx = pieces * unit;

      let inputAmount = num(row.inputAmount);
      // simple mode: treat input as ex by default
      // normal mode: if pieces present and unit present, auto ex; else manual
      const isAuto = (uiMode==="normal" && pieces>0 && unit>0);

      const ex = isAuto ? autoEx : inputAmount;
      const inc = ex*(1+tax);

      const unitCell = (uiMode==="simple") ? "" : `<td class="right num col-unit">${yen(Math.round(unit))}</td>`;
      const piecesCell = (uiMode==="simple") ? "" : `
        <td class="right col-pieces">
          <input class="num" data-o-k="pieces" data-i="${idx}" inputmode="numeric" placeholder="å€‹æ•°" value="${row.pieces??""}">
        </td>`;

      return `
        <tr>
          <td>
            <select data-o-k="vendor" data-i="${idx}">
              <option value="">é¸æŠ</option>
              ${vOpts}
            </select>
          </td>
          <td>
            <select data-o-k="area" data-i="${idx}">
              <option value="">é¸æŠ</option>
              ${aOpts}
            </select>
          </td>
          ${piecesCell}
          ${unitCell}
          <td class="right">
            <input class="num" data-o-k="inputAmount" data-i="${idx}" inputmode="decimal" placeholder="${isAuto ? "è‡ªå‹•" : "è«‹æ±‚"}" value="${isAuto ? "" : (row.inputAmount??"")}">
          </td>
          <td class="right num">${yen(Math.round(ex))}</td>
          <td class="right num">${yen(Math.round(inc))}</td>
          <td class="center"><button class="btn btn-red" data-del-out="${idx}">Ã—</button></td>
        </tr>
      `;
    }).join("");

    // bind
    tb.querySelectorAll('select[data-o-k="vendor"]').forEach(sel=>{
      const i = Number(sel.dataset.i);
      sel.value = r.outs[i].vendor || "";
      sel.addEventListener("change", ()=>{
        r.outs[i].vendor = sel.value;
        // update unit
        if(r.outs[i].vendor && r.outs[i].area){
          r.outs[i].unit = getUnitPrice(r.outs[i].vendor, r.outs[i].area);
        }
        saveDraft(); renderOuts(); recalcCurrent(); renderDashboard();
      });
    });
    tb.querySelectorAll('select[data-o-k="area"]').forEach(sel=>{
      const i = Number(sel.dataset.i);
      sel.value = r.outs[i].area || "";
      sel.addEventListener("change", ()=>{
        r.outs[i].area = sel.value;
        if(r.outs[i].vendor && r.outs[i].area){
          r.outs[i].unit = getUnitPrice(r.outs[i].vendor, r.outs[i].area);
        }
        saveDraft(); renderOuts(); recalcCurrent(); renderDashboard();
      });
    });
    tb.querySelectorAll('input[data-o-k="pieces"]').forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=>{
        r.outs[i].pieces = inp.value;
        // update unit if possible
        if(r.outs[i].vendor && r.outs[i].area){
          r.outs[i].unit = getUnitPrice(r.outs[i].vendor, r.outs[i].area);
        }
        saveDraft(); recalcCurrent(); renderOuts(); renderDashboard();
      });
      inp.addEventListener("blur", ()=>{
        const v = num(inp.value);
        inp.value = v ? String(v) : "";
        r.outs[i].pieces = inp.value;
        saveDraft(); recalcCurrent(); renderOuts(); renderDashboard();
      });
    });
    tb.querySelectorAll('input[data-o-k="inputAmount"]').forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=>{
        r.outs[i].inputAmount = inp.value;
        saveDraft(); recalcCurrent(); renderDashboard();
      });
      inp.addEventListener("blur", ()=>{
        const v = num(inp.value);
        inp.value = v ? String(v) : "";
        r.outs[i].inputAmount = inp.value;
        saveDraft(); recalcCurrent(); renderDashboard();
      });
    });
    tb.querySelectorAll('button[data-del-out]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delOut);
        r.outs.splice(i,1);
        if(!r.outs.length) r.outs.push({vendor:"", area:"", pieces:"", unit:0, inputAmount:""});
        saveDraft(); renderOuts(); recalcCurrent(); renderDashboard();
      });
    });

    applyUIMode();
  }

  // ========= Recalc for a report =========
  function calcReport(r){
    const tax = num(r.taxRate)/100;
    let salesEx=0, salesIn=0, outEx=0, outIn=0;

    (r.sales||[]).forEach(s=>{
      const inputAmount = num(s.inputAmount);
      const ex = r.salesMode==="ex" ? inputAmount : (tax ? inputAmount/(1+tax) : inputAmount);
      const inc = r.salesMode==="in" ? inputAmount : ex*(1+tax);
      salesEx += ex; salesIn += inc;
    });

    const uiMode = state.draft.uiMode || "normal";

    (r.outs||[]).forEach(o=>{
      const pieces = num(o.pieces);
      const unit = num(o.unit);
      const autoEx = pieces * unit;
      const inputAmount = num(o.inputAmount);

      const isAuto = (uiMode==="normal" && pieces>0 && unit>0);
      const ex = isAuto ? autoEx : inputAmount;
      const inc = ex*(1+tax);

      outEx += ex; outIn += inc;
    });

    const grossEx = salesEx - outEx;
    const grossIn = salesIn - outIn;
    const rate = salesEx ? (grossEx / salesEx) : 0;

    // incentives
    const base = (r.incBase==="sales") ? salesEx : grossEx;
    const mgrPct = num(r.mgrPct)/100;
    const salesPct = num(r.salesPct)/100;

    let mgrInc = base>0 ? base*mgrPct : 0;
    let salesInc = base>0 ? base*salesPct : 0;

    const minV = Math.max(0, num(r.incMin));
    const maxV = Math.max(0, num(r.incMax));
    if(minV>0){ mgrInc = Math.max(mgrInc, minV); salesInc = Math.max(salesInc, minV); }
    if(maxV>0){ mgrInc = Math.min(mgrInc, maxV); salesInc = Math.min(salesInc, maxV); }

    return {salesEx,salesIn,outEx,outIn,grossEx,grossIn,rate,mgrInc,salesInc};
  }

  function recalcCurrent(){
    const r = getCurrentReport(); if(!r) return;
    const c = calcReport(r);

    $("kpiSales").textContent = `ç¨æŠœ ${yen(Math.round(c.salesEx))} / ç¨è¾¼ ${yen(Math.round(c.salesIn))}`;
    $("kpiOut").textContent   = `ç¨æŠœ ${yen(Math.round(c.outEx))} / ç¨è¾¼ ${yen(Math.round(c.outIn))}`;

    $("kpiGross").textContent = `ç¨æŠœ ${yen(Math.round(c.grossEx))} / ç¨è¾¼ ${yen(Math.round(c.grossIn))}`;
    $("kpiGross").className   = "v num " + (c.grossEx>=0 ? "good" : "bad");
    $("kpiRate").textContent  = pct(c.rate);

    $("kpiMgrInc").textContent = yen(Math.round(c.mgrInc));
    $("kpiSalesInc").textContent = yen(Math.round(c.salesInc));

    // alert
    const th = num(r.alertRate)/100;
    const isBad = (c.rate <= th);
    $("kpiAlert").innerHTML = isBad
      ? `<span class="pill pill-red">ç²—åˆ©ç‡ãŒä½ã„</span>`
      : `<span class="pill pill-green">OK</span>`;
  }

  // ========= Dashboard Render =========
  function renderDashboard(){
    const month = $("dashMonth").value || nowMonth();
    const pref = $("dashPref").value || "";
    const role = $("dashRole").value || "";
    const baseQ = ($("dashBase").value || "").trim();

    const rows = state.draft.reports
      .filter(r => (r.month||"") === month)
      .filter(r => !pref || (r.pref||"")===pref)
      .filter(r => !role || (r.role||"")===role)
      .filter(r => !baseQ || (r.base||"").includes(baseQ));

    let sumSales=0,sumOut=0,sumGross=0;
    const tb = $("dashTbody");
    tb.innerHTML = "";

    rows.forEach(r=>{
      const c = calcReport(r);
      sumSales += c.salesEx; sumOut += c.outEx; sumGross += c.grossEx;
      const rateTxt = pct(c.rate);
      const grossCls = c.grossEx>=0 ? "good" : "bad";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="num">${esc(r.month||"")}</td>
        <td>${esc(r.pref||"")}</td>
        <td>${esc(r.base||"")}</td>
        <td>${esc(r.role||"")}</td>
        <td>${esc(r.reporter||"")}</td>
        <td>${esc(r.salesRep||"")}</td>
        <td class="right num">${yen(Math.round(c.salesEx))}</td>
        <td class="right num">${yen(Math.round(c.outEx))}</td>
        <td class="right num ${grossCls}">${yen(Math.round(c.grossEx))}</td>
        <td class="right num blue">${rateTxt}</td>
        <td class="right num">${yen(Math.round(c.mgrInc))}</td>
        <td class="right num">${yen(Math.round(c.salesInc))}</td>
        <td class="center no-print">
          <button class="btn btn-yellow" data-edit="${esc(r.id)}">ç·¨é›†</button>
        </td>
      `;
      tb.appendChild(tr);
    });

    const rate = sumSales ? (sumGross/sumSales) : 0;
    $("dashKpiSalesEx").textContent = yen(Math.round(sumSales));
    $("dashKpiOutEx").textContent   = yen(Math.round(sumOut));
    $("dashKpiGrossEx").textContent = yen(Math.round(sumGross));
    $("dashKpiGrossEx").className = "v num " + (sumGross>=0 ? "good" : "bad");
    $("dashKpiRate").textContent = pct(rate);

    tb.querySelectorAll("button[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.dataset.edit;
        state.draft.currentReportId = id;
        saveDraft();
        renderReportSelect();
        hydrateUI();
        setTab("input");
      });
    });
  }

  // ========= Master Render =========
  function renderMaster(){
    // lists
    $("clientTbody").innerHTML = (state.master.clients||[]).map((c,idx)=>`
      <tr><td>${esc(c)}</td><td class="center"><button class="btn btn-red" data-del-client="${idx}">Ã—</button></td></tr>
    `).join("");
    $("vendorTbody").innerHTML = (state.master.vendors||[]).map((v,idx)=>`
      <tr><td>${esc(v)}</td><td class="center"><button class="btn btn-red" data-del-vendor="${idx}">Ã—</button></td></tr>
    `).join("");
    $("areaTbody").innerHTML = (state.master.areas||[]).map((a,idx)=>`
      <tr><td>${esc(a)}</td><td class="center"><button class="btn btn-red" data-del-area="${idx}">Ã—</button></td></tr>
    `).join("");

    // price table
    const vOpts = (state.master.vendors||[]).map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
    const aOpts = (state.master.areas||[]).map(a=>`<option value="${esc(a)}">${esc(a)}</option>`).join("");

    $("priceTbody").innerHTML = (state.master.prices||[]).map((p,idx)=>`
      <tr>
        <td>
          <select data-pk="vendor" data-i="${idx}">
            <option value="">é¸æŠ</option>${vOpts}
          </select>
        </td>
        <td>
          <select data-pk="area" data-i="${idx}">
            <option value="">é¸æŠ</option>${aOpts}
          </select>
        </td>
        <td class="right">
          <input class="num" data-pk="unit" data-i="${idx}" inputmode="decimal" placeholder="å˜ä¾¡" value="${p.unit??""}">
        </td>
        <td class="center"><button class="btn btn-red" data-del-price="${idx}">Ã—</button></td>
      </tr>
    `).join("");

    // bind deletes
    $("clientTbody").querySelectorAll("button[data-del-client]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delClient);
        state.master.clients.splice(i,1);
        renderMaster(); saveMaster(); renderSales();
      });
    });
    $("vendorTbody").querySelectorAll("button[data-del-vendor]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delVendor);
        const name = state.master.vendors[i];
        state.master.vendors.splice(i,1);
        state.master.prices = (state.master.prices||[]).filter(p=>p.vendor!==name);
        renderMaster(); saveMaster(); renderOuts();
      });
    });
    $("areaTbody").querySelectorAll("button[data-del-area]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delArea);
        const name = state.master.areas[i];
        state.master.areas.splice(i,1);
        state.master.prices = (state.master.prices||[]).filter(p=>p.area!==name);
        renderMaster(); saveMaster(); renderOuts();
      });
    });

    // bind price selects/inputs
    $("priceTbody").querySelectorAll('select[data-pk="vendor"]').forEach(sel=>{
      const i = Number(sel.dataset.i);
      sel.value = state.master.prices[i].vendor || "";
      sel.addEventListener("change", ()=> state.master.prices[i].vendor = sel.value);
    });
    $("priceTbody").querySelectorAll('select[data-pk="area"]').forEach(sel=>{
      const i = Number(sel.dataset.i);
      sel.value = state.master.prices[i].area || "";
      sel.addEventListener("change", ()=> state.master.prices[i].area = sel.value);
    });
    $("priceTbody").querySelectorAll('input[data-pk="unit"]').forEach(inp=>{
      const i = Number(inp.dataset.i);
      inp.addEventListener("input", ()=> state.master.prices[i].unit = inp.value );
      inp.addEventListener("blur", ()=>{
        const v = num(inp.value);
        inp.value = v ? String(v) : "";
        state.master.prices[i].unit = inp.value;
      });
    });
    $("priceTbody").querySelectorAll('button[data-del-price]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.dataset.delPrice);
        state.master.prices.splice(i,1);
        renderMaster();
      });
    });
  }

  // ========= History Render =========
  function renderHistory(){
    const sel = $("historySelect");
    sel.innerHTML = "";
    if(!state.history.length){
      const op = document.createElement("option");
      op.value = "";
      op.textContent = "ï¼ˆå±¥æ­´ãªã—ï¼‰";
      sel.appendChild(op);
      return;
    }
    state.history
      .slice()
      .sort((a,b)=> (b.savedAt||"").localeCompare(a.savedAt||""))
      .forEach(h=>{
        const r = h.snapshotReport;
        const label = `${r.month||"æœªè¨­å®š"} / ${r.pref||""} ${r.base||""} / å ±å‘Š:${r.reporter||""}ï¼ˆ${r.role||""}ï¼‰`;
        const op = document.createElement("option");
        op.value = h.id;
        op.textContent = label;
        sel.appendChild(op);
      });
  }

  // ========= CSV Export =========
  function csvEscape(v){
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }
  function downloadText(text, filename, mime){
    const blob = new Blob([text], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportCSV(){
    // å…¨æ‹ ç‚¹ãƒ¬ãƒãƒ¼ãƒˆã‚’ã¾ã¨ã‚ã¦å‡ºã™ï¼ˆæœ¬éƒ¨ç¢ºèªç”¨ï¼‰
    const cols = [
      "type","reportId","month","pref","base","role","reporter","salesRep","goal","memo",
      "taxRate","salesMode","mgrPct","salesPct","incBase","incMin","incMax","alertRate",
      "salesEx","outEx","grossEx","grossRate","mgrInc","salesInc",
      "client","salesInputAmount",
      "vendor","area","pieces","unitEx","outInputAmount"
    ];
    const rows = [];
    rows.push(cols.join(","));

    state.draft.reports.forEach(r=>{
      const c = calcReport(r);
      // summary row
      const sum = {
        type:"SUMMARY",
        reportId:r.id,
        month:r.month,pref:r.pref,base:r.base,role:r.role,reporter:r.reporter,salesRep:r.salesRep,goal:r.goal,memo:r.memo,
        taxRate:r.taxRate,salesMode:r.salesMode,mgrPct:r.mgrPct,salesPct:r.salesPct,incBase:r.incBase,incMin:r.incMin,incMax:r.incMax,alertRate:r.alertRate,
        salesEx:Math.round(c.salesEx),outEx:Math.round(c.outEx),grossEx:Math.round(c.grossEx),grossRate:c.rate,
        mgrInc:Math.round(c.mgrInc),salesInc:Math.round(c.salesInc)
      };
      rows.push(cols.map(k=>csvEscape(sum[k]??"")).join(","));

      // sales rows
      (r.sales||[]).forEach(s=>{
        const line = {
          type:"SALES",
          reportId:r.id,
          month:r.month,pref:r.pref,base:r.base,role:r.role,reporter:r.reporter,salesRep:r.salesRep,
          client:s.client||"",
          salesInputAmount:num(s.inputAmount)||""
        };
        rows.push(cols.map(k=>csvEscape(line[k]??"")).join(","));
      });

      // outs rows
      (r.outs||[]).forEach(o=>{
        const line = {
          type:"OUTSOURCE",
          reportId:r.id,
          month:r.month,pref:r.pref,base:r.base,role:r.role,reporter:r.reporter,salesRep:r.salesRep,
          vendor:o.vendor||"",
          area:o.area||"",
          pieces:num(o.pieces)||"",
          unitEx:num(o.unit)||"",
          outInputAmount:num(o.inputAmount)||""
        };
        rows.push(cols.map(k=>csvEscape(line[k]??"")).join(","));
      });
    });

    downloadText(rows.join("\n"), `OFA_æ‹ ç‚¹åˆ¥_æœˆæ¬¡_${nowMonth()}.csv`, "text/csv");
  }

  // ========= OCR / PDF Import =========
  function normalizeText(t){
    return String(t||"")
      .replace(/\u3000/g," ")
      .replace(/[ï¼Œã€]/g,",")
      .replace(/[ï¼-ï¼™]/g, d => String.fromCharCode(d.charCodeAt(0) - 0xFEE0))
      .replace(/[ï¿¥Â¥]/g,"Â¥")
      .replace(/\s+/g," ")
      .trim();
  }

  function extractYenAmounts(t){
    const amounts = [];
    const re = /(?:Â¥\s*)?(-?\d{1,3}(?:,\d{3})+|-?\d+)(?:\s*å††)?/g;
    let m;
    while((m=re.exec(t))){
      const raw = m[1].replace(/,/g,"");
      const v = Number(raw);
      if(Number.isFinite(v) && Math.abs(v) >= 1000) amounts.push(v);
    }
    amounts.sort((a,b)=>Math.abs(b)-Math.abs(a));
    return amounts;
  }

  function extractPieces(t){
    const pieces = [];
    const re = /(\d{1,6})\s*(å€‹|pcs|ä»¶)/ig;
    let m;
    while((m=re.exec(t))){
      const v = Number(m[1]);
      if(Number.isFinite(v) && v>0) pieces.push(v);
    }
    pieces.sort((a,b)=>b-a);
    return pieces;
  }

  function guessType(t){
    const outK = ["æ”¯æ‰•","æŒ¯è¾¼","è«‹æ±‚","å§”è¨—","å¤–æ³¨","ç²¾ç®—","æ§é™¤","æ‰‹æ•°æ–™","å·®å¼•","ç«‹æ›¿"];
    const salesK = ["å£²ä¸Š","å…¥é‡‘","å—é ˜","ã”è«‹æ±‚","ã”ä¾é ¼","è·ä¸»","ç™ºæ³¨","ãŠæ”¯æ‰•æ—¥"];
    const sOut = outK.reduce((acc,k)=>acc+(t.includes(k)?1:0),0);
    const sSales = salesK.reduce((acc,k)=>acc+(t.includes(k)?1:0),0);
    if(sOut>sSales) return "å§”è¨—";
    if(sSales>sOut) return "å£²ä¸Š";
    return "ä¸æ˜";
  }

  function guessPartyFromMasters(t){
    const hitClients = (state.master.clients||[]).filter(n=>n && t.includes(n));
    const hitVendors = (state.master.vendors||[]).filter(n=>n && t.includes(n));
    return {hitClients, hitVendors};
  }

  function setPreview(rows){
    const tb = $("invoicePreviewTbody");
    tb.innerHTML = "";
    rows.slice(0,20).forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(r.type)}</td>
        <td>${esc(r.party||"")}</td>
        <td class="right num">${r.amount!=null ? yen(Math.round(r.amount)) : ""}</td>
        <td class="right num">${r.pieces!=null ? Math.round(r.pieces) : ""}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function parseInvoiceText(rawText){
    const r = getCurrentReport(); if(!r) return {preview:[], applied:false};

    const t = normalizeText(rawText);
    if(!t) return {preview:[], applied:false};

    const type = guessType(t);
    const amounts = extractYenAmounts(t);
    const pieces = extractPieces(t);
    const {hitClients, hitVendors} = guessPartyFromMasters(t);

    const amount = amounts.length ? amounts[0] : null; // æœ€å¤§ã‚’åˆè¨ˆå€™è£œã¨ã—ã¦æ¡ç”¨
    const piece = pieces.length ? pieces[0] : null;

    const preview = [{
      type,
      party: type==="å£²ä¸Š" ? (hitClients[0]||"") : type==="å§”è¨—" ? (hitVendors[0]||"") : "",
      amount,
      pieces: piece
    }];

    // apply (è½ã¡ã¦ã‚‚OKï¼šè¡Œè¿½åŠ ã ã‘ã™ã‚‹)
    if(amount!=null){
      if(type==="å§”è¨—"){
        r.outs.push({vendor: hitVendors[0]||"", area:"", pieces: piece!=null ? String(piece) : "", unit:0, inputAmount: String(amount)});
      }else{
        r.sales.push({client: hitClients[0]||"", inputAmount: String(amount)});
      }
      // unit update
      r.outs.forEach(o=>{
        if(o.vendor && o.area){
          o.unit = getUnitPrice(o.vendor, o.area);
        }
      });
      saveDraft();
      renderSales(); renderOuts(); recalcCurrent(); renderDashboard();
      return {preview, applied:true};
    }
    return {preview, applied:false};
  }

  async function parsePDFFile(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    let txt = "";
    for(let i=1;i<=pdf.numPages;i++){
      const page = await pdf.getPage(i);
      const c = await page.getTextContent();
      txt += c.items.map(it=>it.str).join(" ") + " ";
    }
    return txt;
  }

  // ========= Wire Base Fields =========
  function wire(){
    // top actions
    $("btnSaveDraft").addEventListener("click", ()=>{
      saveDraft();
      alert("ç«¯æœ«ã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆä¸‹æ›¸ãï¼‰");
    });
    $("btnPDF").addEventListener("click", ()=>{
      window.print();
    });
    $("btnCSV").addEventListener("click", exportCSV);
    $("btnResetDraft").addEventListener("click", ()=>{
      if(!confirm("å…¥åŠ›ï¼ˆæ‹ ç‚¹ãƒ¬ãƒãƒ¼ãƒˆï¼‰ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿãƒã‚¹ã‚¿ãƒ¼/å±¥æ­´ã¯æ®‹ã‚Šã¾ã™")) return;
      state.draft.reports = [defaultReport()];
      state.draft.currentReportId = state.draft.reports[0].id;
      saveDraft();
      renderReportSelect();
      hydrateUI();
      renderDashboard();
    });

    // dashboard
    $("btnDashPrint").addEventListener("click", ()=>window.print());
    $("btnDashRefresh").addEventListener("click", renderDashboard);
    $("dashPref").addEventListener("change", renderDashboard);
    $("dashRole").addEventListener("change", renderDashboard);
    $("dashBase").addEventListener("input", renderDashboard);
    $("dashMonth").addEventListener("change", renderDashboard);

    // report select
    $("reportSelect").addEventListener("change", ()=>{
      state.draft.currentReportId = $("reportSelect").value;
      saveDraft();
      hydrateUI();
    });
    $("btnAddReport").addEventListener("click", ()=>{
      const r = defaultReport();
      // è¿½åŠ æ™‚ã¯æœˆã‚’æƒãˆã‚‹ï¼ˆç¾å ´ã§æ¥½ï¼‰
      const cur = getCurrentReport();
      if(cur?.month) r.month = cur.month;
      state.draft.reports.push(r);
      state.draft.currentReportId = r.id;
      saveDraft();
      renderReportSelect();
      hydrateUI();
    });
    $("btnDeleteReport").addEventListener("click", ()=>{
      const r = getCurrentReport(); if(!r) return;
      if(!confirm("ã“ã®æ‹ ç‚¹ãƒ¬ãƒãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      state.draft.reports = state.draft.reports.filter(x=>x.id!==r.id);
      if(!state.draft.reports.length) state.draft.reports.push(defaultReport());
      state.draft.currentReportId = state.draft.reports[0].id;
      saveDraft();
      renderReportSelect();
      hydrateUI();
      renderDashboard();
    });

    $("uiMode").addEventListener("change", ()=>{
      state.draft.uiMode = $("uiMode").value;
      saveDraft();
      applyUIMode();
      renderOuts();
      recalcCurrent();
      renderDashboard();
    });

    // bind report fields
    const bind = (id, key, type="input")=>{
      $(id).addEventListener(type, ()=>{
        const r = getCurrentReport(); if(!r) return;
        r[key] = $(id).value;
        saveDraft();
        renderReportSelect();
        recalcCurrent();
        renderDashboard();
      });
    };
    bind("month","month");
    bind("reporter","reporter");
    bind("salesRep","salesRep");
    bind("pref","pref","change");
    bind("base","base");
    bind("goal","goal");
    bind("memo","memo");
    bind("taxRate","taxRate");
    bind("salesMode","salesMode","change");

    $("role").addEventListener("change", ()=>{
      const r = getCurrentReport(); if(!r) return;
      r.role = $("role").value;
      saveDraft(); renderReportSelect(); renderDashboard();
    });

    // incentive fields
    ["mgrPct","salesPct","incMin","incMax","alertRate"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        const r = getCurrentReport(); if(!r) return;
        r[id] = $(id).value;
        saveDraft(); recalcCurrent(); renderDashboard();
      });
    });
    $("incBase").addEventListener("change", ()=>{
      const r = getCurrentReport(); if(!r) return;
      r.incBase = $("incBase").value;
      saveDraft(); recalcCurrent(); renderDashboard();
    });

    // rows add
    $("btnAddSale").addEventListener("click", ()=>{
      const r = getCurrentReport(); if(!r) return;
      r.sales.push({client:"", inputAmount:""});
      saveDraft(); renderSales(); recalcCurrent(); renderDashboard();
    });
    $("btnAddOut").addEventListener("click", ()=>{
      const r = getCurrentReport(); if(!r) return;
      r.outs.push({vendor:"", area:"", pieces:"", unit:0, inputAmount:""});
      saveDraft(); renderOuts(); recalcCurrent(); renderDashboard();
    });

    // OCR/PDF
    $("btnParseInvoiceText").addEventListener("click", ()=>{
      const raw = $("invoiceText").value;
      const res = parseInvoiceText(raw);
      setPreview(res.preview);
      if(!res.applied) alert("é‡‘é¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚OCRãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    });
    $("btnClearInvoiceText").addEventListener("click", ()=>{$("invoiceText").value="";});
    $("btnParsePDF").addEventListener("click", async ()=>{
      const f = $("pdfFile").files?.[0];
      if(!f) return alert("PDFã‚’é¸æŠã—ã¦ãã ã•ã„");
      try{
        const txt = await parsePDFFile(f);
        $("invoiceText").value = txt;
        const res = parseInvoiceText(txt);
        setPreview(res.preview);
        if(!res.applied) alert("PDFã‹ã‚‰é‡‘é¡ãŒæ‹¾ãˆã¾ã›ã‚“ã§ã—ãŸï¼ˆç”»åƒPDFã®å¯èƒ½æ€§ï¼‰ã€‚OCRè²¼ä»˜ã§å¯¾å¿œã—ã¦ãã ã•ã„ã€‚");
      }catch(e){
        alert("PDFè§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®PDFã§è©¦ã™ã‹OCRè²¼ä»˜ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚");
      }
    });

    $("btnGoDash").addEventListener("click", ()=>{
      renderDashboard();
      setTab("dashboard");
    });

    // save history (1æ‹ ç‚¹)
    $("btnSaveHistory").addEventListener("click", ()=>{
      const r = getCurrentReport(); if(!r) return;
      if(!r.month) return alert("å¯¾è±¡æœˆãŒæœªè¨­å®šã§ã™");
      const id = uid();
      state.history.push({id, savedAt: new Date().toISOString(), snapshotReport: JSON.parse(JSON.stringify(r))});
      saveHistory();
      renderHistory();
      alert("ã“ã®æ‹ ç‚¹ã‚’å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ");
    });

    // history load/delete
    $("btnLoadHistory").addEventListener("click", ()=>{
      const id = $("historySelect").value;
      if(!id) return;
      const h = state.history.find(x=>x.id===id);
      if(!h) return;
      // åŒã˜idã§å…¥ã‚Œæ›¿ãˆã§ã¯ãªãã€æ–°è¦æ‹ ç‚¹ã¨ã—ã¦è¿½åŠ ï¼ˆå®‰å…¨ï¼‰
      const rep = JSON.parse(JSON.stringify(h.snapshotReport));
      rep.id = uid();
      state.draft.reports.push(rep);
      state.draft.currentReportId = rep.id;
      saveDraft();
      renderReportSelect();
      hydrateUI();
      renderDashboard();
      setTab("input");
    });
    $("btnDeleteHistory").addEventListener("click", ()=>{
      const id = $("historySelect").value;
      if(!id) return;
      if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      state.history = state.history.filter(x=>x.id!==id);
      saveHistory();
      renderHistory();
    });

    // master buttons
    $("btnAddClient").addEventListener("click", ()=>{
      const v = $("newClient").value.trim();
      if(!v) return;
      if(!state.master.clients.includes(v)) state.master.clients.push(v);
      $("newClient").value = "";
      saveMaster(); renderMaster(); renderSales();
    });
    $("btnAddVendor").addEventListener("click", ()=>{
      const v = $("newVendor").value.trim();
      if(!v) return;
      if(!state.master.vendors.includes(v)) state.master.vendors.push(v);
      $("newVendor").value = "";
      saveMaster(); renderMaster(); renderOuts();
    });
    $("btnAddArea").addEventListener("click", ()=>{
      const v = $("newArea").value.trim();
      if(!v) return;
      if(!state.master.areas.includes(v)) state.master.areas.push(v);
      $("newArea").value = "";
      saveMaster(); renderMaster(); renderOuts();
    });
    $("btnAddPrice").addEventListener("click", ()=>{
      state.master.prices.push({vendor:"", area:"", unit:""});
      renderMaster();
    });
    $("btnSaveMaster").addEventListener("click", ()=>{
      // normalize
      state.master.clients = (state.master.clients||[]).map(s=>String(s).trim()).filter(Boolean);
      state.master.vendors = (state.master.vendors||[]).map(s=>String(s).trim()).filter(Boolean);
      state.master.areas   = (state.master.areas||[]).map(s=>String(s).trim()).filter(Boolean);
      state.master.prices  = (state.master.prices||[])
        .map(p=>({vendor:String(p.vendor||"").trim(), area:String(p.area||"").trim(), unit:num(p.unit)}))
        .filter(p=>p.vendor && p.area && p.unit>0);

      saveMaster();
      // refresh units in all reports
      state.draft.reports.forEach(r=>{
        (r.outs||[]).forEach(o=>{
          if(o.vendor && o.area){
            o.unit = getUnitPrice(o.vendor, o.area);
          }
        });
      });
      saveDraft();
      renderMaster();
      renderOuts();
      recalcCurrent();
      renderDashboard();
      alert("ãƒã‚¹ã‚¿ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    });
    $("btnResetMaster").addEventListener("click", ()=>{
      if(!confirm("ãƒã‚¹ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      localStorage.removeItem(LS_MASTER);
      loadAll();
      renderMaster();
      renderSales(); renderOuts();
      recalcCurrent();
      renderDashboard();
      alert("åˆæœŸåŒ–ã—ã¾ã—ãŸ");
    });
  }

  // ========= Init =========
  loadAll();

  // Ensure draft has reports
  if(!state.draft || !Array.isArray(state.draft.reports)){
    state.draft = {uiMode:"normal", currentReportId:"", reports:[defaultReport()]};
  }
  if(!state.draft.reports.length){
    state.draft.reports.push(defaultReport());
  }
  if(!state.draft.currentReportId){
    state.draft.currentReportId = state.draft.reports[0].id;
  }

  // Build pref selects
  buildPrefSelect($("pref"));

  // dashboard filters build
  $("dashMonth").value = nowMonth();
  $("dashPref").innerHTML = `<option value="">ã™ã¹ã¦</option>` + PREFS.filter(p=>p!=="ã‚¨ãƒªã‚¢å¤–/æœ¬éƒ¨å–¶æ¥­").map(p=>`<option value="${esc(p)}">${esc(p)}</option>`).join("") + `<option value="ã‚¨ãƒªã‚¢å¤–/æœ¬éƒ¨å–¶æ¥­">ã‚¨ãƒªã‚¢å¤–/æœ¬éƒ¨å–¶æ¥­</option>`;

  // report select + UI
  renderReportSelect();
  hydrateUI();

  // master/history/dashboard
  renderMaster();
  renderHistory();
  renderDashboard();

  wire();

})();
</script>

</body>
</html>
