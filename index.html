<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFA æ‹ ç‚¹å£²ä¸Š æœˆæ¬¡ç®¡ç†ï¼ˆè«‹æ±‚æ›¸OCR/PDFå¯¾å¿œï¼‰</title>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>

  <style>
    :root{
      --yellow:#FFD400;
      --black:#111;
      --red:#E60012;
      --green:#0FA958;
      --blue:#0066CC;
      --border:#d9d9d9;
      --muted:#666;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP",sans-serif;
      background:#fff;
      color:#111;
    }
    .wrap{max-width:1280px;margin:auto;padding:14px 14px 120px}

    /* header */
    .topbar{
      position:sticky;top:0;z-index:10;
      background:#fff;border-bottom:3px solid var(--black);
      margin:-14px -14px 14px;padding:12px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:48px;height:48px;border-radius:12px;
      background:var(--yellow);border:3px solid var(--black);
      display:grid;place-items:center;font-weight:1000;
    }
    h1{margin:0;font-size:18px;font-weight:1000}
    .sub{font-size:12px;color:var(--muted);font-weight:800}

    .btn{
      border:3px solid var(--black);
      border-radius:12px;padding:10px 14px;
      font-weight:1000;cursor:pointer;background:#f5f5f5;
    }
    .btn-yellow{background:var(--yellow)}
    .btn-blue{background:var(--blue);color:#fff}
    .btn-green{background:var(--green);color:#fff}
    .btn-red{background:var(--red);color:#fff}

    .card{
      border:3px solid var(--black);
      border-radius:14px;padding:14px;margin-bottom:14px;
    }
    label{font-size:12px;font-weight:1000}
    input,select,textarea{
      width:100%;padding:10px;border-radius:10px;
      border:2px solid var(--border);font-size:14px;
    }
    textarea{min-height:120px}
    .row{display:grid;gap:10px}
    @media(min-width:900px){
      .cols2{grid-template-columns:1fr 1fr}
      .cols3{grid-template-columns:1fr 1fr 1fr}
      .cols4{grid-template-columns:1fr 1fr 1fr 1fr}
    }
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border:1px solid var(--border);padding:8px}
    th{background:#f2f2f2;font-weight:1000}
    td.right{text-align:right}
    .good{color:var(--green);font-weight:1000}
    .bad{color:var(--red);font-weight:1000}
    .muted{font-size:12px;color:var(--muted)}
    @media print{
      .no-print{display:none}
      .topbar{display:none}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar no-print">
    <div class="brand">
      <div class="logo">OFA</div>
      <div>
        <h1>OFA æ‹ ç‚¹å£²ä¸Š æœˆæ¬¡ç®¡ç†</h1>
        <div class="sub">è«‹æ±‚æ›¸OCR / PDFèª­è¾¼ â†’ è‡ªå‹•å…¥åŠ›</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-blue" onclick="window.print()">ğŸ–¨ï¸ PDF</button>
      <button class="btn btn-green" id="btnCSV">â¬‡ï¸ CSV</button>
    </div>
  </div>

  <!-- åŸºæœ¬æƒ…å ± -->
  <div class="card">
    <div class="row cols4">
      <div><label>å¯¾è±¡æœˆ</label><input type="month" id="month"></div>
      <div><label>å ±å‘Šè€…</label><input id="reporter"></div>
      <div><label>éƒ½é“åºœçœŒ</label><input id="pref"></div>
      <div><label>æ‹ ç‚¹å</label><input id="base"></div>
    </div>
  </div>

  <!-- å£²ä¸Š -->
  <div class="card">
    <h2>å£²ä¸Š</h2>
    <table>
      <thead>
        <tr><th>ç™ºæ³¨æ¥­è€…</th><th class="right">é‡‘é¡</th><th></th></tr>
      </thead>
      <tbody id="salesBody"></tbody>
    </table>
    <button class="btn btn-yellow no-print" onclick="addSale()">ï¼‹ å£²ä¸Šè¿½åŠ </button>
  </div>

  <!-- å§”è¨— -->
  <div class="card">
    <h2>å§”è¨—</h2>
    <table>
      <thead>
        <tr><th>å§”è¨—æ¥­è€…</th><th class="right">é‡‘é¡</th><th></th></tr>
      </thead>
      <tbody id="outBody"></tbody>
    </table>
    <button class="btn btn-yellow no-print" onclick="addOut()">ï¼‹ å§”è¨—è¿½åŠ </button>
  </div>

  <!-- OCR / PDF -->
  <div class="card no-print">
    <h2>è«‹æ±‚æ›¸èª­ã¿è¾¼ã¿ï¼ˆOCR / PDFï¼‰</h2>
    <div class="row cols2">
      <div>
        <label>â‘  OCRãƒ†ã‚­ã‚¹ãƒˆè²¼ä»˜</label>
        <textarea id="invoiceText"></textarea>
        <button class="btn btn-yellow" onclick="parseText()">è§£æã—ã¦è¿½åŠ </button>
      </div>
      <div>
        <label>â‘¡ PDFè«‹æ±‚æ›¸</label>
        <input type="file" id="pdfFile" accept="application/pdf">
        <button class="btn btn-blue" onclick="parsePDF()">PDFè§£æ</button>
      </div>
    </div>
  </div>

  <!-- é›†è¨ˆ -->
  <div class="card">
    <h2>é›†è¨ˆ</h2>
    <div>å£²ä¸Šåˆè¨ˆï¼š<span id="sumSales">0</span></div>
    <div>å§”è¨—åˆè¨ˆï¼š<span id="sumOut">0</span></div>
    <div>ç²—åˆ©ï¼š<span id="sumGross" class="good">0</span></div>
  </div>

</div>

<script>
const sales=[], outs=[];
const salesBody=document.getElementById("salesBody");
const outBody=document.getElementById("outBody");

function yen(n){return (Number(n)||0).toLocaleString("ja-JP");}

function addSale(v="",a=""){
  sales.push({client:v, amount:a});
  render();
}
function addOut(v="",a=""){
  outs.push({vendor:v, amount:a});
  render();
}
function render(){
  salesBody.innerHTML="";
  outBody.innerHTML="";
  let s=0,o=0;
  sales.forEach((r,i)=>{
    s+=Number(r.amount)||0;
    salesBody.innerHTML+=`<tr>
      <td><input value="${r.client}" oninput="sales[${i}].client=this.value"></td>
      <td class="right"><input value="${r.amount}" oninput="sales[${i}].amount=this.value;render()"></td>
      <td><button onclick="sales.splice(${i},1);render()">Ã—</button></td>
    </tr>`;
  });
  outs.forEach((r,i)=>{
    o+=Number(r.amount)||0;
    outBody.innerHTML+=`<tr>
      <td><input value="${r.vendor}" oninput="outs[${i}].vendor=this.value"></td>
      <td class="right"><input value="${r.amount}" oninput="outs[${i}].amount=this.value;render()"></td>
      <td><button onclick="outs.splice(${i},1);render()">Ã—</button></td>
    </tr>`;
  });
  document.getElementById("sumSales").textContent=yen(s);
  document.getElementById("sumOut").textContent=yen(o);
  document.getElementById("sumGross").textContent=yen(s-o);
  document.getElementById("sumGross").className=(s-o)>=0?"good":"bad";
}
addSale();addOut();

function parseText(){
  const t=document.getElementById("invoiceText").value;
  if(!t) return;
  const nums=t.match(/\d{1,3}(?:,\d{3})+/g);
  if(!nums) return;
  const amount=Number(nums[0].replace(/,/g,""));
  if(t.includes("å§”è¨—")||t.includes("æ”¯æ‰•")){
    addOut("",amount);
  }else{
    addSale("",amount);
  }
}

async function parsePDF(){
  const f=document.getElementById("pdfFile").files[0];
  if(!f) return;
  const buf=await f.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  let text="";
  for(let i=1;i<=pdf.numPages;i++){
    const p=await pdf.getPage(i);
    const c=await p.getTextContent();
    text+=c.items.map(it=>it.str).join(" ");
  }
  document.getElementById("invoiceText").value=text;
  parseText();
}

document.getElementById("btnCSV").onclick=()=>{
  let csv="type,name,amount\n";
  sales.forEach(r=>csv+=`sales,${r.client},${r.amount}\n`);
  outs.forEach(r=>csv+=`out,${r.vendor},${r.amount}\n`);
  const b=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="ofa_monthly.csv";
  a.click();
};
</script>

</body>
</html>
