<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OFA 拠点別 月次収支管理</title>

<style>
:root{
  --black:#111;
  --yellow:#FFD400;
  --red:#E60012;
  --green:#0FA958;
  --blue:#0066CC;
  --border:#ccc;
}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP",sans-serif;
  background:#fff;
  color:var(--black);
}
.wrap{max-width:1200px;margin:auto;padding:16px 14px 120px}
h1{margin:0 0 12px;font-size:20px;font-weight:900}
.card{
  border:2px solid var(--black);
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
}
label{font-size:12px;font-weight:900}
input,select,textarea{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:14px;
}
button{
  padding:10px 14px;
  border-radius:10px;
  border:2px solid var(--black);
  font-weight:900;
  cursor:pointer;
}
.yellow{background:var(--yellow)}
.green{background:var(--green);color:#fff}
.red{background:var(--red);color:#fff}
.blue{background:var(--blue);color:#fff}
.gray{background:#eee}

.row{display:grid;gap:10px}
@media(min-width:900px){
  .cols2{grid-template-columns:1fr 1fr}
  .cols3{grid-template-columns:1fr 1fr 1fr}
  .cols4{grid-template-columns:1fr 1fr 1fr 1fr}
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:8px;
}
th,td{
  border:1px solid var(--border);
  padding:6px;
  font-size:13px;
}
th{background:#f2f2f2;font-weight:900}
.right{text-align:right}
.left{text-align:left}

.good{color:var(--green);font-weight:900}
.bad{color:var(--red);font-weight:900}
</style>
</head>

<body>
<div class="wrap">

<h1>OFA 拠点別 月次収支管理</h1>

<!-- 基本情報 -->
<div class="card">
  <div class="row cols3">
    <div>
      <label>対象月</label>
      <input type="month" id="month">
    </div>
    <div>
      <label>報告者（責任者）</label>
      <input id="reporter">
    </div>
    <div>
      <label>区分</label>
      <select id="role">
        <option>エリアマネ</option>
        <option>営業</option>
        <option>フランチャイズ</option>
      </select>
    </div>
  </div>
</div>

<!-- 拠点エリア -->
<div id="bases"></div>

<button class="yellow" onclick="addBase()">＋ 拠点を追加</button>

<!-- 一覧 -->
<div class="card">
<h3>拠点別 収支一覧</h3>
<table id="summary">
<thead>
<tr>
<th>拠点</th>
<th>売上</th>
<th>委託費</th>
<th>粗利</th>
<th>利益率</th>
<th>売上達成</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div style="display:flex;gap:10px;flex-wrap:wrap">
<button class="blue" onclick="window.print()">PDF出力</button>
<button class="green" onclick="exportCSV()">CSV出力</button>
</div>

</div>

<script>
function yen(n){return (Number(n)||0).toLocaleString("ja-JP")}

function addBase(){
  const id=Date.now()
  const div=document.createElement("div")
  div.className="card"
  div.dataset.id=id
  div.innerHTML=`
  <h3>拠点</h3>
  <div class="row cols3">
    <div><label>都道府県</label><input class="pref"></div>
    <div><label>拠点名</label><input class="name"></div>
    <div><label>売上目標（税抜）</label><input class="target"></div>
  </div>

  <h4>売上（発注業者）</h4>
  <table class="sales">
    <tr><th>業者名</th><th>金額</th><th>個建</th><th>人数</th><th>個数</th><th></th></tr>
  </table>
  <button onclick="addSale(this)">＋ 売上追加</button>

  <h4>委託</h4>
  <table class="outs">
    <tr><th>業者</th><th>地域</th><th>個数</th><th>単価</th><th>金額</th><th></th></tr>
  </table>
  <button onclick="addOut(this)">＋ 委託追加</button>

  <h4>目標・コメント</h4>
  <textarea class="comment" placeholder="戦略・反省・次月アクション"></textarea>

  <h4>集計</h4>
  <div class="row cols4">
    <div>売上：<span class="sSales">0</span></div>
    <div>委託：<span class="sOut">0</span></div>
    <div>粗利：<span class="sGross">0</span></div>
    <div>達成率：<span class="sRate">0%</span></div>
  </div>
  `
  document.getElementById("bases").appendChild(div)
}

function addSale(btn){
  const tr=document.createElement("tr")
  tr.innerHTML=`
  <td><input></td>
  <td><input class="amt"></td>
  <td><input type="checkbox" class="koken"></td>
  <td><input class="people"></td>
  <td><input class="qty"></td>
  <td><button onclick="this.closest('tr').remove();calc()">×</button></td>`
  btn.previousElementSibling.appendChild(tr)
  tr.querySelectorAll("input").forEach(i=>i.oninput=calc)
}

function addOut(btn){
  const tr=document.createElement("tr")
  tr.innerHTML=`
  <td><input></td>
  <td><input></td>
  <td><input class="qty"></td>
  <td><input class="price"></td>
  <td class="sum">0</td>
  <td><button onclick="this.closest('tr').remove();calc()">×</button></td>`
  btn.previousElementSibling.appendChild(tr)
  tr.querySelectorAll("input").forEach(i=>i.oninput=calc)
}

function calc(){
  const rows=document.querySelectorAll("#bases .card")
  const sumBody=document.querySelector("#summary tbody")
  sumBody.innerHTML=""
  rows.forEach(b=>{
    let sales=0,outs=0
    b.querySelectorAll(".sales .amt").forEach(i=>sales+=+i.value||0)
    b.querySelectorAll(".outs tr").forEach(tr=>{
      const q=+tr.querySelector(".qty")?.value||0
      const p=+tr.querySelector(".price")?.value||0
      const s=q*p
      tr.querySelector(".sum").textContent=yen(s)
      outs+=s
    })
    const gross=sales-outs
    const target=+b.querySelector(".target").value||0
    const rate=target?Math.round(sales/target*100):0

    b.querySelector(".sSales").textContent=yen(sales)
    b.querySelector(".sOut").textContent=yen(outs)
    b.querySelector(".sGross").textContent=yen(gross)
    b.querySelector(".sRate").textContent=rate+"%"

    const tr=document.createElement("tr")
    tr.innerHTML=`
    <td>${b.querySelector(".name").value}</td>
    <td class="right">${yen(sales)}</td>
    <td class="right">${yen(outs)}</td>
    <td class="right ${gross>=0?"good":"bad"}">${yen(gross)}</td>
    <td class="right">${Math.round(gross/sales*100)||0}%</td>
    <td class="right ${rate>=100?"good":"bad"}">${rate}%</td>`
    sumBody.appendChild(tr)
  })
}

document.addEventListener("input",calc)

function exportCSV(){
  let csv="拠点,売上,委託,粗利\n"
  document.querySelectorAll("#summary tbody tr").forEach(tr=>{
    csv+=Array.from(tr.children).map(td=>td.textContent.replace(/,/g,"")).join(",")+"\n"
  })
  const blob=new Blob([csv],{type:"text/csv"})
  const a=document.createElement("a")
  a.href=URL.createObjectURL(blob)
  a.download="ofa_拠点別収支.csv"
  a.click()
}
</script>

</body>
</html>
