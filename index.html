<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFA æœˆæ¬¡å ±å‘Šãƒ•ã‚©ãƒ¼ãƒ ï¼ˆPDF/CSVï¼‰</title>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border:#dddddd;
      --text:#111111;
      --muted:#666666;

      --yellow:#FFD400;
      --black:#111111;
      --red:#E60012;
      --green:#0FA958;
      --blue:#0066CC;

      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px 14px 120px}
    .topbar{
      position:sticky;top:0;z-index:50;
      background:#fff;
      border-bottom:2px solid var(--black);
      padding:12px 10px;
      margin:-16px -14px 14px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:12px;
      background:var(--yellow);
      border:2px solid var(--black);
      display:grid;place-items:center;
      font-weight:900;color:#000;
      letter-spacing:.02em;
    }
    .brand h1{margin:0;font-size:16px;font-weight:900}
    .brand .sub{margin-top:2px;color:var(--muted);font-size:12px;font-weight:700}

    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    button,.btn{
      padding:10px 14px;
      border-radius:10px;
      border:2px solid var(--black);
      background:#f5f5f5;
      font-weight:900;
      cursor:pointer;
    }
    button:hover,.btn:hover{opacity:.9}
    .btn-yellow{background:var(--yellow);color:#000}
    .btn-green{background:var(--green);color:#fff;border-color:#0b6f3d}
    .btn-blue{background:var(--blue);color:#fff;border-color:#003e7a}
    .btn-red{background:var(--red);color:#fff;border-color:#8f000b}

    .card{
      background:var(--card);
      border:2px solid var(--black);
      border-radius:var(--radius);
      padding:14px;
      margin-bottom:14px;
    }
    h2{margin:0 0 10px;font-size:15px;font-weight:900}
    .muted{color:var(--muted);font-size:12px;line-height:1.6}
    .row{display:grid;gap:10px}
    @media(min-width:860px){
      .row.cols2{grid-template-columns:1fr 1fr}
      .row.cols3{grid-template-columns:1fr 1fr 1fr}
      .row.cols4{grid-template-columns:1fr 1fr 1fr 1fr}
    }
    label{display:block;font-size:12px;font-weight:900;margin:0 0 4px}
    input,select,textarea{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:14px;
      background:#fff;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .hr{height:2px;background:#000;opacity:.12;margin:12px 0}

    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#fafafa;
      font-size:12px;font-weight:900;color:#000;
    }
    .good{color:var(--green);font-weight:900}
    .bad{color:var(--red);font-weight:900}
    .blue{color:var(--blue);font-weight:900}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      background:#fff;
    }
    th,td{border:1px solid var(--border);padding:8px}
    th{background:#f2f2f2;font-weight:900;text-align:left}
    td.right{text-align:right}

    @media print{
      .no-print{display:none !important}
      .wrap{padding:0}
      .topbar{display:none}
      .card{border:1px solid #000}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar no-print">
      <div class="brand">
        <div class="logo">OFA</div>
        <div>
          <h1>æœˆæ¬¡å ±å‘Šãƒ•ã‚©ãƒ¼ãƒ ï¼ˆPDF / CSVï¼‰</h1>
          <div class="sub">å…¥åŠ›â†’PDF/CSVå‡ºåŠ›â†’LINEã€Œæœˆæ¬¡å ±å‘Šã€ã¸è»¢é€</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn-yellow" id="btnLP">ğŸ—¾ æ‹ ç‚¹ä¸€è¦§ï¼ˆLPï¼‰</button>
        <button class="btn-blue" id="btnPDF">ğŸ–¨ï¸ PDFå‡ºåŠ›</button>
        <button class="btn-blue" id="btnCSV">â¬‡ï¸ CSVå‡ºåŠ›</button>
        <button class="btn-green" id="btnLINE">ğŸ“© LINEï¼ˆæœˆæ¬¡å ±å‘Šï¼‰</button>
        <button class="btn-yellow" id="btnSave">ğŸ’¾ ç«¯æœ«ã«ä¿å­˜</button>
        <button class="btn-red" id="btnClear">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div class="card">
      <h2>â‘  åŸºæœ¬æƒ…å ±</h2>
      <div class="row cols4">
        <div>
          <label>å¯¾è±¡æœˆ</label>
          <input type="month" id="month">
        </div>
        <div>
          <label>å…¥åŠ›è€…åŒºåˆ†</label>
          <select id="role">
            <option value="ã‚¨ãƒªã‚¢ãƒãƒ">ã‚¨ãƒªã‚¢ãƒãƒï¼ˆç¾åœ°è²¬ä»»è€…ï¼‰</option>
            <option value="å–¶æ¥­ãƒãƒ³">å–¶æ¥­ãƒãƒ³ï¼ˆæœ¬éƒ¨/FCç®¡ç†ï¼‰</option>
            <option value="ãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚º">ãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚º</option>
          </select>
        </div>
        <div>
          <label>å…¥åŠ›è€…å</label>
          <input type="text" id="reporter" placeholder="ä¾‹ï¼šç”°ä¸­ / â—‹â—‹FCåº—">
        </div>
        <div>
          <label>æ‹…å½“å–¶æ¥­ï¼ˆä»»æ„ï¼‰</label>
          <select id="salesOwner">
            <option value="">æœªæŒ‡å®š</option>
            <option value="æ£®ä¸‹">æ£®ä¸‹</option><option value="å¤ªç”°">å¤ªç”°</option><option value="æ¾å²¡">æ¾å²¡</option>
            <option value="å³¶ç”°">å³¶ç”°</option><option value="æ—¥é«˜">æ—¥é«˜</option><option value="å†…å±±">å†…å±±</option>
            <option value="æ—">æ—</option><option value="å±‹å®®">å±‹å®®</option>
          </select>
        </div>
      </div>

      <div class="row cols3" style="margin-top:10px">
        <div>
          <label>éƒ½é“åºœçœŒ</label>
          <select id="pref"></select>
        </div>
        <div>
          <label>æ‹ ç‚¹å / åº—èˆ—å</label>
          <input type="text" id="base" placeholder="ä¾‹ï¼šOFAç¦å²¡å— / â—‹â—‹FCåº—">
        </div>
        <div>
          <label>ãƒ¡ãƒ¢ï¼ˆçŸ­æ–‡ï¼‰</label>
          <input type="text" id="memoShort" placeholder="ä¾‹ï¼šå¢—å“¡/å°æ•°å¢—/ç¹å¿™ãªã©">
        </div>
      </div>

      <div class="hr"></div>

      <h2>â‘¡ æœˆæ¬¡æ•°å€¤ï¼ˆå…¥åŠ›ã ã‘ï¼‰</h2>
      <div class="row cols3">
        <div>
          <label>å£²ä¸Šåˆè¨ˆï¼ˆå††ï¼‰</label>
          <input type="text" id="revenue" inputmode="numeric" placeholder="ä¾‹ï¼š2500000">
        </div>
        <div>
          <label>å§”è¨—ä¼šç¤¾è«‹æ±‚åˆè¨ˆï¼ˆå††ï¼‰</label>
          <input type="text" id="outsource" inputmode="numeric" placeholder="ä¾‹ï¼š1800000">
        </div>
        <div>
          <label>ãã®ä»–çµŒè²»ï¼ˆå††ï¼‰</label>
          <input type="text" id="otherCost" inputmode="numeric" placeholder="ä¾‹ï¼šé«˜é€Ÿ/ä¿®ç†/å¤–æ³¨è¿½åŠ ç­‰">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>å§”è¨—å†…è¨³ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="outsourceMemo" placeholder="ä¾‹ï¼šãƒ¤ãƒãƒˆ 1,200,000 / ä½å· 600,000 ãªã©"></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <h2>â‘¢ è‡ªå‹•è¨ˆç®—ï¼ˆç¢ºèªç”¨ï¼‰</h2>
      <div class="row cols4">
        <div class="pill">ã‚³ã‚¹ãƒˆåˆè¨ˆï¼š<span class="blue" id="costSum">0</span> å††</div>
        <div class="pill">åˆ©ç›Šï¼š<span id="profitSum" class="good">0</span> å††</div>
        <div class="pill">åˆ©ç›Šç‡ï¼š<span class="blue" id="profitRate">0.0%</span></div>
        <div class="pill">å¤–æ³¨ç‡ï¼š<span class="blue" id="outRate">0.0%</span></div>
      </div>

      <div class="hr"></div>

      <h2>â‘£ æ‰‹å½“ï¼ˆ0.3%ï¼‰</h2>
      <div class="row cols3">
        <div class="pill">ã‚¨ãƒªã‚¢ãƒãƒæ‰‹å½“ï¼ˆå£²ä¸ŠÃ—0.3%ï¼‰ï¼š<span class="blue" id="allowMgr">0</span> å††</div>
        <div class="pill">å–¶æ¥­æ‰‹å½“ï¼ˆå£²ä¸ŠÃ—0.3%ï¼‰ï¼š<span class="blue" id="allowSales">0</span> å††</div>
        <div class="pill">æ‰‹å½“åˆè¨ˆï¼š<span class="blue" id="allowAll">0</span> å††</div>
      </div>

      <div class="hr"></div>

      <h2>â‘¤ é•·æ–‡ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</h2>
      <textarea id="memoLong" placeholder="ä¾‹ï¼šå‰å¹´å·®ã®è¦å› ã€å¢—å“¡/æ¸›å“¡ã€ã‚¯ãƒ¬ãƒ¼ãƒ ã€ç¨¼åƒç‡ã€æ¥æœˆè¦‹è¾¼ã¿ãªã©"></textarea>

      <div class="hr no-print"></div>
      <div class="muted no-print">
        âœ… é€ä»˜æ‰‹é †ï¼š<b>PDFå‡ºåŠ› or CSVå‡ºåŠ›</b> â†’ <b>LINEï¼ˆæœˆæ¬¡å ±å‘Šï¼‰</b> â†’ æ·»ä»˜ã—ã¦é€ä¿¡
      </div>
    </div>

    <div class="card">
      <h2>å°åˆ·ã‚µãƒãƒªãƒ¼ï¼ˆãã®ã¾ã¾PDFæå‡ºï¼‰</h2>
      <table>
        <tbody>
          <tr><th style="width:200px">å¯¾è±¡æœˆ</th><td id="pMonth">â€”</td></tr>
          <tr><th>å…¥åŠ›è€…åŒºåˆ† / å</th><td id="pWho">â€”</td></tr>
          <tr><th>æ‹…å½“å–¶æ¥­</th><td id="pSales">â€”</td></tr>
          <tr><th>éƒ½é“åºœçœŒ / æ‹ ç‚¹</th><td id="pArea">â€”</td></tr>
          <tr><th>å£²ä¸Š / ã‚³ã‚¹ãƒˆ / åˆ©ç›Š</th><td id="pMoney">â€”</td></tr>
          <tr><th>åˆ©ç›Šç‡ / å¤–æ³¨ç‡</th><td id="pRates">â€”</td></tr>
          <tr><th>æ‰‹å½“ï¼ˆã‚¨ãƒªã‚¢ãƒãƒ/å–¶æ¥­ï¼‰</th><td id="pAllow">â€”</td></tr>
          <tr><th>ãƒ¡ãƒ¢</th><td id="pMemo">â€”</td></tr>
        </tbody>
      </table>
    </div>

  </div>

  <script>
    const LINE_URL = "https://lin.ee/o1TPv8v";
    const RATE = 0.003; // 0.3%
    const LS_KEY = "ofa_monthly_report_white_v1";

    const PREFS = [
      "åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ",
      "èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ",
      "æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ",
      "å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ",
      "æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ",
      "é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ",
      "å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ",
      "ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ",
      "ã‚¨ãƒªã‚¢å¤–","æœ¬éƒ¨å–¶æ¥­"
    ];

    const el = (id)=>document.getElementById(id);
    const month = el("month");
    const role = el("role");
    const reporter = el("reporter");
    const salesOwner = el("salesOwner");
    const pref = el("pref");
    const base = el("base");
    const memoShort = el("memoShort");

    const revenue = el("revenue");
    const outsource = el("outsource");
    const otherCost = el("otherCost");
    const outsourceMemo = el("outsourceMemo");
    const memoLong = el("memoLong");

    const yen = n => (Number(n)||0).toLocaleString("ja-JP");
    const toNum = v => {
      const s = String(v ?? "").replace(/[^\d.-]/g,"");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };
    const pct = v => (v*100).toFixed(1) + "%";
    const nowMonth = ()=>{
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60000);
      return local.toISOString().slice(0,7);
    };

    function setPrefOptions(){
      pref.innerHTML = "";
      PREFS.forEach(p=>{
        const op = document.createElement("option");
        op.value = p;
        op.textContent = p;
        pref.appendChild(op);
      });
    }

    function recalc(){
      const rev = toNum(revenue.value);
      const out = toNum(outsource.value);
      const oth = toNum(otherCost.value);

      const cost = out + oth;
      const prof = rev - cost;
      const pr = rev ? (prof / rev) : 0;
      const or = rev ? (out / rev) : 0;

      el("costSum").textContent = yen(cost);
      el("profitSum").textContent = yen(prof);
      el("profitSum").className = (prof>=0) ? "good" : "bad";
      el("profitRate").textContent = pct(pr);
      el("outRate").textContent = pct(or);

      const am = Math.floor(rev * RATE);
      const as = Math.floor(rev * RATE);
      el("allowMgr").textContent = yen(am);
      el("allowSales").textContent = yen(as);
      el("allowAll").textContent = yen(am+as);

      el("pMonth").textContent = month.value || "â€”";
      el("pWho").textContent = `${role.value} / ${reporter.value || "â€”"}`;
      el("pSales").textContent = salesOwner.value || "â€”";
      el("pArea").textContent = `${pref.value || "â€”"} / ${base.value || "â€”"}`;
      el("pMoney").textContent = `å£²ä¸Š ${yen(rev)}å†† / ã‚³ã‚¹ãƒˆ ${yen(cost)}å†† / åˆ©ç›Š ${yen(prof)}å††`;
      el("pRates").textContent = `åˆ©ç›Šç‡ ${pct(pr)} / å¤–æ³¨ç‡ ${pct(or)}`;
      el("pAllow").textContent = `ã‚¨ãƒªã‚¢ãƒãƒ ${yen(am)}å†† / å–¶æ¥­ ${yen(as)}å†† / åˆè¨ˆ ${yen(am+as)}å††`;

      const memoAll = [
        memoShort.value ? `çŸ­æ–‡ï¼š${memoShort.value}` : "",
        outsourceMemo.value ? `å§”è¨—å†…è¨³ï¼š${outsourceMemo.value}` : "",
        memoLong.value ? `è©³ç´°ï¼š${memoLong.value}` : ""
      ].filter(Boolean).join("\n");
      el("pMemo").textContent = memoAll || "â€”";
    }

    [month,role,reporter,salesOwner,pref,base,memoShort,revenue,outsource,otherCost,outsourceMemo,memoLong]
      .forEach(x=>x.addEventListener("input", recalc));

    [revenue,outsource,otherCost].forEach(inp=>{
      inp.addEventListener("blur", ()=>{
        const n = toNum(inp.value);
        inp.value = n ? n.toLocaleString("ja-JP") : "";
        recalc();
      });
    });

    function collect(){
      const rev = toNum(revenue.value);
      const out = toNum(outsource.value);
      const oth = toNum(otherCost.value);
      const cost = out + oth;
      const prof = rev - cost;
      const pr = rev ? prof/rev : 0;
      const or = rev ? out/rev : 0;

      return {
        month: month.value || "",
        role: role.value || "",
        reporter: reporter.value || "",
        salesOwner: salesOwner.value || "",
        pref: pref.value || "",
        base: base.value || "",
        memoShort: memoShort.value || "",
        revenue: rev,
        outsource: out,
        otherCost: oth,
        profit: prof,
        profitRate: pr,
        outsourceRate: or,
        allowMgr: Math.floor(rev*RATE),
        allowSales: Math.floor(rev*RATE),
        outsourceMemo: outsourceMemo.value || "",
        memoLong: memoLong.value || "",
        exportedAt: new Date().toISOString()
      };
    }

    function saveLocal(){
      localStorage.setItem(LS_KEY, JSON.stringify(collect()));
      alert("ç«¯æœ«ã«ä¿å­˜ã—ã¾ã—ãŸ");
    }
    function loadLocal(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return;
        const d = JSON.parse(raw);
        month.value = d.month || nowMonth();
        role.value = d.role || "ã‚¨ãƒªã‚¢ãƒãƒ";
        reporter.value = d.reporter || "";
        salesOwner.value = d.salesOwner || "";
        pref.value = d.pref || "é¹¿å…å³¶çœŒ";
        base.value = d.base || "";
        memoShort.value = d.memoShort || "";
        revenue.value = d.revenue ? Number(d.revenue).toLocaleString("ja-JP") : "";
        outsource.value = d.outsource ? Number(d.outsource).toLocaleString("ja-JP") : "";
        otherCost.value = d.otherCost ? Number(d.otherCost).toLocaleString("ja-JP") : "";
        outsourceMemo.value = d.outsourceMemo || "";
        memoLong.value = d.memoLong || "";
      }catch(e){}
    }

    function csvEscape(v){
      const s = String(v ?? "");
      if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }
    function downloadText(text, filename, mime){
      const blob = new Blob([text], {type:mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportCSV(){
      const d = collect();
      const header = [
        "month","role","reporter","salesOwner","pref","base",
        "revenue","outsource","otherCost","cost","profit",
        "profitRate","outsourceRate",
        "allowMgr","allowSales",
        "memoShort","outsourceMemo","memoLong","exportedAt"
      ];
      const cost = d.outsource + d.otherCost;
      const row = [
        d.month,d.role,d.reporter,d.salesOwner,d.pref,d.base,
        d.revenue,d.outsource,d.otherCost,cost,d.profit,
        d.profitRate,d.outsourceRate,
        d.allowMgr,d.allowSales,
        d.memoShort,d.outsourceMemo,d.memoLong,d.exportedAt
      ].map(csvEscape);
      const csv = header.join(",") + "\n" + row.join(",");
      const fn = `OFA_æœˆæ¬¡å ±å‘Š_${d.month || "æœªè¨­å®š"}_${d.pref || "æœªè¨­å®š"}_${d.base || "æ‹ ç‚¹"}.csv`;
      downloadText(csv, fn, "text/csv");
    }

    function exportPDF(){
      recalc();
      window.print();
    }

    function clearAll(){
      if(!confirm("å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
      month.value = nowMonth();
      role.value = "ã‚¨ãƒªã‚¢ãƒãƒ";
      reporter.value = "";
      salesOwner.value = "";
      pref.value = "é¹¿å…å³¶çœŒ";
      base.value = "";
      memoShort.value = "";
      revenue.value = "";
      outsource.value = "";
      otherCost.value = "";
      outsourceMemo.value = "";
      memoLong.value = "";
      recalc();
    }

    function applyParams(){
      const qs = new URLSearchParams(location.search);
      const pPref = qs.get("pref");
      const pBase = qs.get("base");
      const pSales = qs.get("sales");
      const pRole = qs.get("role");
      const pReporter = qs.get("reporter");
      const pMonth = qs.get("month");

      if(pMonth) month.value = pMonth;
      if(pPref) pref.value = pPref;
      if(pBase) base.value = pBase;
      if(pSales) salesOwner.value = pSales;
      if(pRole) role.value = pRole;
      if(pReporter) reporter.value = pReporter;

      recalc();
    }

    // init
    setPrefOptions();
    month.value = nowMonth();
    pref.value = "é¹¿å…å³¶çœŒ";
    loadLocal();
    applyParams();
    recalc();

    // actions
    el("btnPDF").addEventListener("click", exportPDF);
    el("btnCSV").addEventListener("click", exportCSV);
    el("btnSave").addEventListener("click", saveLocal);
    el("btnClear").addEventListener("click", clearAll);
    el("btnLINE").addEventListener("click", ()=>window.open(LINE_URL,"_blank"));
    el("btnLP").addEventListener("click", ()=>window.open("lp.html","_blank"));
  </script>
</body>
</html>
