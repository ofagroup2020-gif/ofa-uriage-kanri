<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFA æœ¬éƒ¨ãƒ“ãƒ¥ãƒ¼ï¼ˆCSVå–è¾¼ï¼‰</title>
  <style>
    :root{--bg:#0b1220;--text:#e9f1ff;--muted:rgba(233,241,255,.72);--line:rgba(255,255,255,.12);--card:rgba(255,255,255,.06);--shadow:0 12px 28px rgba(0,0,0,.35);--r:18px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 100px}
    .card{background:linear-gradient(180deg,var(--card),rgba(255,255,255,.03));border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    h1{margin:0;font-size:16px}
    .muted{color:var(--muted);font-size:12px;line-height:1.6}
    .drop{margin-top:12px;padding:18px;border-radius:16px;border:1px dashed rgba(255,255,255,.25);background:rgba(0,0,0,.18);text-align:center}
    .row{display:grid;gap:10px;margin-top:12px}
    @media(min-width:900px){.row{grid-template-columns:1fr 1fr 1fr 1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:var(--text)}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12.5px}
    th{color:var(--muted);text-align:left;background:rgba(255,255,255,.04);font-weight:900}
    tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .good{color:#19c37d;font-weight:900}
    .bad{color:#ff5c5c;font-weight:900}
    .pill{display:inline-block;margin:6px 8px 0 0;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.06);font-size:12px;color:var(--muted)}
    button{border:0;cursor:pointer;padding:10px 12px;border-radius:12px;color:var(--text);background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);font-weight:900}
    button:hover{filter:brightness(1.06)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>æœ¬éƒ¨ãƒ“ãƒ¥ãƒ¼ï¼ˆCSVå–è¾¼ â†’ æ‹ ç‚¹åˆ¥ã«ä¸€è¦§ï¼‰</h1>
      <div class="muted">
        LINEã§å±Šã„ãŸCSVï¼ˆOFA_æœˆæ¬¡å ±å‘Š_*.csvï¼‰ã‚’ã€ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°OKï¼‰ã€‚<br>
        â€»ã“ã®ç”»é¢ã¯ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã§ã¯ãªãã€ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§èª­ã‚€ã ã‘ã§ã™ã€‚
      </div>

      <div id="drop" class="drop">
        ğŸ“¥ ã“ã“ã«CSVã‚’ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆã¾ãŸã¯
        <input id="file" type="file" accept=".csv,text/csv" multiple style="display:inline-block;margin-left:6px">
        ï¼‰
      </div>

      <div class="row">
        <div>
          <label>çµã‚Šè¾¼ã¿ï¼šå¯¾è±¡æœˆï¼ˆmonthï¼‰</label>
          <input id="fMonth" placeholder="ä¾‹ï¼š2025-12ï¼ˆç©ºæ¬„=å…¨ã¦ï¼‰">
        </div>
        <div>
          <label>çµã‚Šè¾¼ã¿ï¼šéƒ½é“åºœçœŒï¼ˆprefï¼‰</label>
          <input id="fPref" placeholder="ä¾‹ï¼šç¦å²¡çœŒï¼ˆç©ºæ¬„=å…¨ã¦ï¼‰">
        </div>
        <div>
          <label>çµã‚Šè¾¼ã¿ï¼šæ‹ ç‚¹/åº—èˆ—åï¼ˆbaseï¼‰</label>
          <input id="fBase" placeholder="ä¾‹ï¼šOFAç¦å²¡å—ï¼ˆç©ºæ¬„=å…¨ã¦ï¼‰">
        </div>
        <div style="display:flex;gap:10px;align-items:flex-end">
          <button id="btnClear">ğŸ§¹ å–è¾¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <span class="pill">ä»¶æ•°ï¼š<b id="cnt">0</b></span>
        <span class="pill">å£²ä¸Šåˆè¨ˆï¼š<b id="sumRev">0</b></span>
        <span class="pill">åˆ©ç›Šåˆè¨ˆï¼š<b id="sumProf">0</b></span>
      </div>

      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th>month</th>
              <th>pref</th>
              <th>base</th>
              <th>role</th>
              <th>reporter</th>
              <th>salesOwner</th>
              <th class="right">revenue</th>
              <th class="right">profit</th>
              <th class="right">profitRate</th>
              <th class="right">outsourceRate</th>
              <th class="right">allowMgr</th>
              <th class="right">allowSales</th>
              <th>memoShort</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

  <script>
    const yen = n => (Number(n)||0).toLocaleString("ja-JP");
    const pct = v => (Number(v||0)*100).toFixed(1) + "%";

    let rows = []; // å–ã‚Šè¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ï¼ˆè¤‡æ•°CSVï¼‰

    const qs = new URLSearchParams(location.search);
    const initialPref = qs.get("pref") || "";
    const initialBase = qs.get("base") || "";

    const fMonth = document.getElementById("fMonth");
    const fPref = document.getElementById("fPref");
    const fBase = document.getElementById("fBase");

    if(initialPref) fPref.value = initialPref;
    if(initialBase) fBase.value = initialBase;

    const drop = document.getElementById("drop");
    const file = document.getElementById("file");

    function parseCSV(text){
      // ã‚·ãƒ³ãƒ—ãƒ«CSVï¼ˆã“ã®ã‚·ã‚¹ãƒ†ãƒ ã®1è¡ŒCSVå‰æï¼‰
      const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim().length);
      if(lines.length < 2) return [];
      const header = splitCSVLine(lines[0]);
      const dataLine = splitCSVLine(lines[1]);
      const obj = {};
      header.forEach((h,i)=>obj[h] = dataLine[i] ?? "");
      // æ•°å€¤ã£ã½ã„ã®ã¯æ•°å€¤åŒ–
      ["revenue","outsource","otherCost","cost","profit","profitRate","outsourceRate","allowMgr","allowSales"].forEach(k=>{
        if(obj[k] !== undefined){
          const n = Number(String(obj[k]).replace(/[^\d.-]/g,""));
          obj[k] = Number.isFinite(n) ? n : 0;
        }
      });
      return [obj];
    }

    function splitCSVLine(line){
      const out = [];
      let cur = "", inQ = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(inQ){
          if(ch === '"'){
            if(line[i+1] === '"'){ cur += '"'; i++; }
            else inQ = false;
          }else cur += ch;
        }else{
          if(ch === '"') inQ = true;
          else if(ch === ","){ out.push(cur); cur = ""; }
          else cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    function render(){
      const m = fMonth.value.trim();
      const p = fPref.value.trim();
      const b = fBase.value.trim();

      const list = rows.filter(r=>{
        if(m && String(r.month||"") !== m) return false;
        if(p && String(r.pref||"").indexOf(p) === -1) return false;
        if(b && String(r.base||"").indexOf(b) === -1) return false;
        return true;
      });

      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";

      let sumRev = 0, sumProf = 0;

      list.forEach(r=>{
        sumRev += Number(r.revenue||0);
        sumProf += Number(r.profit||0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(r.month)}</td>
          <td>${esc(r.pref)}</td>
          <td>${esc(r.base)}</td>
          <td>${esc(r.role)}</td>
          <td>${esc(r.reporter)}</td>
          <td>${esc(r.salesOwner)}</td>
          <td class="right">${yen(r.revenue)}</td>
          <td class="right ${r.profit>=0?'good':'bad'}">${yen(r.profit)}</td>
          <td class="right">${pct(r.profitRate)}</td>
          <td class="right">${pct(r.outsourceRate)}</td>
          <td class="right">${yen(r.allowMgr)}</td>
          <td class="right">${yen(r.allowSales)}</td>
          <td>${esc(r.memoShort)}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("cnt").textContent = list.length;
      document.getElementById("sumRev").textContent = yen(sumRev);
      document.getElementById("sumProf").textContent = yen(sumProf);
    }

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function handleFiles(files){
      for(const f of files){
        const text = await f.text();
        const parsed = parseCSV(text);
        rows.push(...parsed);
      }
      render();
    }

    drop.addEventListener("dragover", (e)=>{ e.preventDefault(); drop.style.filter="brightness(1.08)"; });
    drop.addEventListener("dragleave", ()=>{ drop.style.filter=""; });
    drop.addEventListener("drop", (e)=>{
      e.preventDefault(); drop.style.filter="";
      const files = e.dataTransfer.files;
      if(files && files.length) handleFiles(files);
    });

    file.addEventListener("change", ()=>{
      if(file.files && file.files.length) handleFiles(file.files);
      file.value = "";
    });

    [fMonth,fPref,fBase].forEach(x=>x.addEventListener("input", render));

    document.getElementById("btnClear").addEventListener("click", ()=>{
      if(!confirm("å–ã‚Šè¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
      rows = [];
      render();
    });

    render();
  </script>
</body>
</html>
