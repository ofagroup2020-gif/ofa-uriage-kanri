<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFA æœ¬éƒ¨ãƒ“ãƒ¥ãƒ¼ï¼ˆæ¯”è¼ƒãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰</title>

  <style>
    :root{
      --bg:#ffffff;--card:#ffffff;--border:#dddddd;--text:#111111;--muted:#666666;
      --yellow:#FFD400;--black:#111111;--red:#E60012;--green:#0FA958;--blue:#0066CC;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1280px;margin:0 auto;padding:16px 14px 110px}
    .topbar{
      background:#fff;border-bottom:2px solid var(--black);
      padding:12px 10px;margin:-16px -14px 14px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:44px;height:44px;border-radius:12px;background:var(--yellow);border:2px solid var(--black);display:grid;place-items:center;font-weight:900;color:#000}
    .brand h1{margin:0;font-size:16px;font-weight:900}
    .brand .sub{margin-top:2px;color:var(--muted);font-size:12px;font-weight:700}

    .card{background:var(--card);border:2px solid var(--black);border-radius:var(--radius);padding:14px;margin-bottom:14px}
    .muted{color:var(--muted);font-size:12px;line-height:1.6}

    .btn{
      padding:10px 14px;border-radius:10px;border:2px solid var(--black);
      background:#f5f5f5;font-weight:900;cursor:pointer;
    }
    .btn:hover{opacity:.9}
    .btn-yellow{background:var(--yellow);color:#000}
    .btn-blue{background:var(--blue);color:#fff;border-color:#003e7a}
    .btn-red{background:var(--red);color:#fff;border-color:#8f000b}

    .row{display:grid;gap:10px;margin-top:10px}
    @media(min-width:980px){.row.cols5{grid-template-columns:1.1fr 1fr 1fr 1fr 1fr}}
    label{display:block;font-size:12px;font-weight:900;margin:0 0 4px}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);font-size:14px}

    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#fafafa;font-size:12px;font-weight:900}
    .good{color:var(--green);font-weight:900}
    .bad{color:var(--red);font-weight:900}
    .warn{color:var(--blue);font-weight:900}

    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;border:1px solid var(--border)}
    .badge-ok{background:#e7f6ef;color:var(--green);border-color:#bde6d1}
    .badge-warn{background:#eaf2fb;color:var(--blue);border-color:#c7dcf6}
    .badge-bad{background:#fdeaea;color:var(--red);border-color:#f6c7c7}

    .drop{
      margin-top:10px;padding:14px;border-radius:12px;
      border:2px dashed #999;background:#fff;text-align:center
    }

    .tableWrap{overflow:auto;max-height:70vh;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:13px;background:#fff}
    th,td{border:1px solid var(--border);padding:8px;white-space:nowrap}
    th{background:#f2f2f2;font-weight:900;position:sticky;top:0}
    td.right{text-align:right}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">OFA</div>
        <div>
          <h1>æœ¬éƒ¨ãƒ“ãƒ¥ãƒ¼ï¼ˆå‰æœˆæ¯”ãƒ»å‰å¹´å·®ãƒ»ç•°å¸¸ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰</h1>
          <div class="sub">CSVè¤‡æ•°å–è¾¼ â†’ è‡ªå‹•æ¯”è¼ƒ â†’ ç•°å¸¸ã‚’èµ¤ã§è¡¨ç¤º</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn btn-yellow" href="lp.html" target="_blank" style="text-decoration:none;color:#000;display:inline-flex;align-items:center">ğŸ—¾ æ‹ ç‚¹ä¸€è¦§</a>
        <a class="btn btn-blue" href="index.html" target="_blank" style="text-decoration:none;color:#fff;display:inline-flex;align-items:center">ğŸ“ æœˆæ¬¡å…¥åŠ›</a>
        <button class="btn btn-red" id="btnClear">ğŸ§¹ å–è¾¼ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div class="card">
      <div class="muted">
        LINEã§å±Šã„ãŸCSVï¼ˆOFA_æœˆæ¬¡å ±å‘Š_*.csvï¼‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆè¤‡æ•°OKï¼‰ã€‚<br>
        è¡¨ç¤ºæœˆãŒç©ºæ¬„ãªã‚‰ã€å–ã‚Šè¾¼ã‚“ã ä¸­ã§ä¸€ç•ªæ–°ã—ã„æœˆã‚’è‡ªå‹•æ¡ç”¨ã—ã¾ã™ã€‚
      </div>

      <div id="drop" class="drop">
        ğŸ“¥ ã“ã“ã«CSVã‚’ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆã¾ãŸã¯
        <input id="file" type="file" accept=".csv,text/csv" multiple style="display:inline-block;margin-left:6px">
        ï¼‰
      </div>

      <div class="row cols5">
        <div>
          <label>è¡¨ç¤ºæœˆï¼ˆmonthï¼‰</label>
          <input id="fMonth" placeholder="ä¾‹ï¼š2025-12ï¼ˆç©ºæ¬„=æœ€æ–°ï¼‰">
        </div>
        <div>
          <label>éƒ½é“åºœçœŒï¼ˆprefï¼‰</label>
          <input id="fPref" placeholder="ä¾‹ï¼šç¦å²¡çœŒï¼ˆç©ºæ¬„=å…¨ã¦ï¼‰">
        </div>
        <div>
          <label>æ‹ ç‚¹/åº—èˆ—åï¼ˆbaseï¼‰</label>
          <input id="fBase" placeholder="ä¾‹ï¼šOFAç¦å²¡å—ï¼ˆç©ºæ¬„=å…¨ã¦ï¼‰">
        </div>
        <div>
          <label>åˆ©ç›Šç‡ ä¸‹é™ï¼ˆ%ï¼‰</label>
          <input id="thProfit" inputmode="decimal" placeholder="ä¾‹ï¼š8">
        </div>
        <div>
          <label>å¤–æ³¨ç‡ ä¸Šé™ï¼ˆ%ï¼‰</label>
          <input id="thOut" inputmode="decimal" placeholder="ä¾‹ï¼š85">
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <span class="pill">ä»¶æ•°ï¼š<b id="cnt">0</b></span>
        <span class="pill">å£²ä¸Šåˆè¨ˆï¼š<b id="sumRev">0</b></span>
        <span class="pill">åˆ©ç›Šåˆè¨ˆï¼š<b id="sumProf">0</b></span>
        <span class="pill">ç•°å¸¸ä»¶æ•°ï¼š<b id="abn">0</b></span>
      </div>

      <div class="tableWrap" style="margin-top:10px">
        <table id="tbl">
          <thead>
            <tr>
              <th>åˆ¤å®š</th>
              <th>month</th>
              <th>pref</th>
              <th>base</th>
              <th class="right">å£²ä¸Š</th>
              <th class="right">åˆ©ç›Š</th>
              <th class="right">åˆ©ç›Šç‡</th>
              <th class="right">å¤–æ³¨ç‡</th>

              <th class="right">å‰æœˆ å£²ä¸Šå·®</th>
              <th class="right">å‰æœˆ åˆ©ç›Šå·®</th>
              <th class="right">å‰æœˆ åˆ©ç›Šç‡å·®(pt)</th>

              <th class="right">å‰å¹´å·® å£²ä¸Šå·®</th>
              <th class="right">å‰å¹´å·® åˆ©ç›Šå·®</th>
              <th class="right">å‰å¹´å·® åˆ©ç›Šç‡å·®(pt)</th>

              <th>role</th>
              <th>reporter</th>
              <th>salesOwner</th>
              <th>memoShort</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px">
        â€»åˆ©ç›Šç‡å·®(pt)ï¼š8%â†’6%ãªã‚‰ã€Œ-2.0ptã€<br>
        â€»ç•°å¸¸ï¼åˆ©ç›Šç‡ãŒä¸‹é™æœªæº€ï¼ˆèµ¤ï¼‰ / æ³¨æ„ï¼å¤–æ³¨ç‡ãŒä¸Šé™è¶…ï¼ˆé’ï¼‰
      </div>
    </div>
  </div>

  <script>
    let rows = [];

    const yen = n => (Number(n)||0).toLocaleString("ja-JP");
    const pct = v => (Number(v||0)*100).toFixed(1) + "%";

    const qs = new URLSearchParams(location.search);
    const initialPref = qs.get("pref") || "";
    const initialBase = qs.get("base") || "";

    const fMonth = document.getElementById("fMonth");
    const fPref  = document.getElementById("fPref");
    const fBase  = document.getElementById("fBase");
    const thProfit = document.getElementById("thProfit");
    const thOut    = document.getElementById("thOut");

    if(initialPref) fPref.value = initialPref;
    if(initialBase) fBase.value = initialBase;

    thProfit.value = "8";
    thOut.value = "85";

    const drop = document.getElementById("drop");
    const file = document.getElementById("file");

    function splitCSVLine(line){
      const out = [];
      let cur = "", inQ = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(inQ){
          if(ch === '"'){
            if(line[i+1] === '"'){ cur += '"'; i++; }
            else inQ = false;
          }else cur += ch;
        }else{
          if(ch === '"') inQ = true;
          else if(ch === ","){ out.push(cur); cur = ""; }
          else cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    function parseCSV(text){
      const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim().length);
      if(lines.length < 2) return [];
      const header = splitCSVLine(lines[0]);
      const dataLine = splitCSVLine(lines[1]);
      const obj = {};
      header.forEach((h,i)=>obj[h] = dataLine[i] ?? "");

      ["revenue","outsource","otherCost","cost","profit","profitRate","outsourceRate","allowMgr","allowSales"].forEach(k=>{
        if(obj[k] !== undefined){
          const n = Number(String(obj[k]).replace(/[^\d.-]/g,""));
          obj[k] = Number.isFinite(n) ? n : 0;
        }
      });
      return [obj];
    }

    function monthAdd(monthStr, diff){
      const [y,m] = monthStr.split("-").map(Number);
      const d = new Date(y, (m-1) + diff, 1);
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      return `${yy}-${mm}`;
    }

    function keyOf(r){
      return `${String(r.pref||"")}|${String(r.base||"")}`;
    }

    function findLatestMonth(list){
      const months = [...new Set(list.map(r=>String(r.month||"")).filter(Boolean))].sort();
      return months.length ? months[months.length-1] : "";
    }

    function pickIndex(list){
      const idx = new Map();
      list.forEach(r=>{
        const k = `${keyOf(r)}|${String(r.month||"")}`;
        idx.set(k, r);
      });
      return idx;
    }

    function badgeHTML(status){
      if(status === "ç•°å¸¸") return `<span class="badge badge-bad">ç•°å¸¸</span>`;
      if(status === "æ³¨æ„") return `<span class="badge badge-warn">æ³¨æ„</span>`;
      return `<span class="badge badge-ok">OK</span>`;
    }

    function fmtDiff(v){
      if(v === null || v === undefined) return "â€”";
      const n = Number(v||0);
      const s = (n>0?"+":"") + yen(n);
      return n>=0 ? `<span class="good">${s}</span>` : `<span class="bad">${s}</span>`;
    }
    function fmtPt(v){
      if(v === null || v === undefined) return "â€”";
      const n = Number(v||0);
      const s = (n>0?"+":"") + n.toFixed(1) + "pt";
      return n>=0 ? `<span class="good">${s}</span>` : `<span class="bad">${s}</span>`;
    }
    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function render(){
      const p = fPref.value.trim();
      const b = fBase.value.trim();

      let m = fMonth.value.trim();
      if(!m) m = findLatestMonth(rows);

      const profitTh = Number(String(thProfit.value||"").replace(/[^\d.-]/g,"")) / 100;
      const outTh    = Number(String(thOut.value||"").replace(/[^\d.-]/g,"")) / 100;

      const list = rows.filter(r=>{
        if(m && String(r.month||"") !== m) return false;
        if(p && String(r.pref||"").indexOf(p) === -1) return false;
        if(b && String(r.base||"").indexOf(b) === -1) return false;
        return true;
      });

      const idx = pickIndex(rows);
      const prevM = m ? monthAdd(m, -1) : "";
      const yoyM  = m ? monthAdd(m, -12) : "";

      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";

      let sumRev = 0, sumProf = 0, abn = 0;

      list.forEach(r=>{
        const k = keyOf(r);
        const prev = prevM ? idx.get(`${k}|${prevM}`) : null;
        const yoy  = yoyM  ? idx.get(`${k}|${yoyM}`)  : null;

        const rev = Number(r.revenue||0);
        const prof = Number(r.profit||0);
        const pr = Number(r.profitRate||0);
        const or = Number(r.outsourceRate||0);

        sumRev += rev;
        sumProf += prof;

        const dPrevRev = prev ? rev - Number(prev.revenue||0) : null;
        const dPrevProf = prev ? prof - Number(prev.profit||0) : null;
        const dPrevPRpt = prev ? (pr - Number(prev.profitRate||0))*100 : null;

        const dYoyRev = yoy ? rev - Number(yoy.revenue||0) : null;
        const dYoyProf = yoy ? prof - Number(yoy.profit||0) : null;
        const dYoyPRpt = yoy ? (pr - Number(yoy.profitRate||0))*100 : null;

        let status = "OK";
        if(Number.isFinite(profitTh) && profitTh > 0 && pr < profitTh) status = "ç•°å¸¸";
        else if(Number.isFinite(outTh) && outTh > 0 && or > outTh) status = "æ³¨æ„";

        if(status !== "OK") abn++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${badgeHTML(status)}</td>
          <td>${esc(r.month)}</td>
          <td>${esc(r.pref)}</td>
          <td>${esc(r.base)}</td>

          <td class="right">${yen(rev)}</td>
          <td class="right ${prof>=0?'good':'bad'}">${yen(prof)}</td>
          <td class="right ${pr < profitTh ? 'bad' : ''}">${pct(pr)}</td>
          <td class="right ${or > outTh ? 'warn' : ''}">${pct(or)}</td>

          <td class="right">${fmtDiff(dPrevRev)}</td>
          <td class="right">${fmtDiff(dPrevProf)}</td>
          <td class="right">${fmtPt(dPrevPRpt)}</td>

          <td class="right">${fmtDiff(dYoyRev)}</td>
          <td class="right">${fmtDiff(dYoyProf)}</td>
          <td class="right">${fmtPt(dYoyPRpt)}</td>

          <td>${esc(r.role)}</td>
          <td>${esc(r.reporter)}</td>
          <td>${esc(r.salesOwner)}</td>
          <td>${esc(r.memoShort)}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("cnt").textContent = list.length;
      document.getElementById("sumRev").textContent = yen(sumRev);
      document.getElementById("sumProf").textContent = yen(sumProf);
      document.getElementById("abn").textContent = abn;

      if(!fMonth.value.trim() && m) fMonth.value = m;
    }

    async function handleFiles(files){
      for(const f of files){
        const text = await f.text();
        rows.push(...parseCSV(text));
      }
      render();
    }

    drop.addEventListener("dragover", (e)=>{ e.preventDefault(); drop.style.opacity="0.9"; });
    drop.addEventListener("dragleave", ()=>{ drop.style.opacity="1"; });
    drop.addEventListener("drop", (e)=>{
      e.preventDefault(); drop.style.opacity="1";
      const files = e.dataTransfer.files;
      if(files && files.length) handleFiles(files);
    });

    file.addEventListener("change", ()=>{
      if(file.files && file.files.length) handleFiles(file.files);
      file.value = "";
    });

    [fMonth,fPref,fBase,thProfit,thOut].forEach(x=>x.addEventListener("input", render));

    document.getElementById("btnClear").addEventListener("click", ()=>{
      if(!confirm("å–ã‚Šè¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
      rows = [];
      fMonth.value = "";
      render();
    });

    render();
  </script>
</body>
</html>
